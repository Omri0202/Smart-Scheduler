<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smart Scheduler</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.5;
            color: #1e293b;
            background: #f8fafc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Login container */
        #loginContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            text-align: center;
        }
        
        .login-card {
            background: white;
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        
        .login-card h1 {
            font-size: 1.75rem;
            margin-bottom: 1rem;
            color: #1e293b;
        }
        
        .login-card p {
            color: #64748b;
            margin-bottom: 2rem;
        }
        
        #google-signin-button {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        /* Chat container */
        #appLayout {
            display: none;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Header */
        .app-header {
            padding: 1rem 1.5rem;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .sign-out-btn {
            background: #f1f5f9;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .sign-out-btn:hover {
            background: #e2e8f0;
        }
        
        /* Chat area */
        #chatContainer {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f8fafc;
        }
        
        .message {
            margin-bottom: 1.5rem;
            max-width: 80%;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            margin-left: auto;
            text-align: right;
        }
        
        .assistant-message {
            margin-right: auto;
        }
        
        .message-content {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 0.9375rem;
            line-height: 1.5;
        }
        
        .user-message .message-content {
            background: #6366f1;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        
        .assistant-message .message-content {
            background: white;
            color: #1e293b;
            border-bottom-left-radius: 0.25rem;
        }
        
        /* Input area */
        #inputContainer {
            padding: 1rem 1.5rem;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.75rem;
        }
        
        #inputBox {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 0.9375rem;
            transition: all 0.2s;
        }
        
        #inputBox:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        #sendButton, #voiceButton {
            width: 42px;
            height: 42px;
            border: none;
            border-radius: 50%;
            background: #6366f1;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #sendButton:hover, #voiceButton:hover {
            background: #4f46e5;
        }
        
        #sendButton:disabled, #voiceButton:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 1rem;
            width: fit-content;
            margin-bottom: 1.5rem;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #cbd5e1;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .login-card {
                padding: 1.5rem;
            }
            
            .message {
                max-width: 90%;
            }
            
            #inputContainer {
                padding: 0.75rem 1rem;
            }
            
            #inputBox {
                padding: 0.625rem 0.875rem;
                font-size: 0.875rem;
            }
            
            #sendButton, #voiceButton {
                width: 36px;
                height: 36px;
            }
        }
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.5;
            color: #1e293b;
            background: #f8fafc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Login container */
        #loginContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            text-align: center;
        }
        
        .login-card {
            background: white;
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }
        
        .login-card h1 {
            font-size: 1.75rem;
            margin-bottom: 1rem;
            color: #1e293b;
        }
        
        .login-card p {
            color: #64748b;
            margin-bottom: 2rem;
        }
        
        #google-signin-button {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        /* Chat container */
        #appLayout {
            display: none;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Header */
        .app-header {
            padding: 1rem 1.5rem;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .sign-out-btn {
            background: #f1f5f9;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .sign-out-btn:hover {
            background: #e2e8f0;
        }
        
        /* Chat area */
        #chatContainer {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #f8fafc;
        }
        
        .message {
            margin-bottom: 1.5rem;
            max-width: 80%;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            margin-left: auto;
            text-align: right;
        }
        
        .assistant-message {
            margin-right: auto;
        }
        
        .message-content {
            display: inline-block;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-size: 0.9375rem;
            line-height: 1.5;
        }
        
        .user-message .message-content {
            background: #6366f1;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        
        .assistant-message .message-content {
            background: white;
            color: #1e293b;
            border-bottom-left-radius: 0.25rem;
        }
        
        /* Input area */
        #inputContainer {
            padding: 1rem 1.5rem;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.75rem;
        }
        
        #inputBox {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 0.9375rem;
            transition: all 0.2s;
        }
        
        #inputBox:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        #sendButton, #voiceButton {
            width: 42px;
            height: 42px;
            border: none;
            border-radius: 50%;
            background: #6366f1;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #sendButton:hover, #voiceButton:hover {
            background: #4f46e5;
        }
        
        #sendButton:disabled, #voiceButton:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 1rem;
            width: fit-content;
            margin-bottom: 1.5rem;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #cbd5e1;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .login-card {
                padding: 1.5rem;
            }
            
            .message {
                max-width: 90%;
            }
            
            #inputContainer {
                padding: 0.75rem 1rem;
            }
            
            #inputBox {
                padding: 0.625rem 0.875rem;
                font-size: 0.875rem;
            }
            
            #sendButton, #voiceButton {
                width: 36px;
                height: 36px;
            }
        }
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.5;
            color: var(--dark);
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Layout */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            padding: 1.5rem 0;
            z-index: 10;
        }
        
        .logo-container {
            padding: 0 1.5rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }
        
        .app-logo {
            height: 40px;
            width: auto;
        }
        
        .nav-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 0 1rem;
            margin-bottom: auto;
        }
        
        .nav-button {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border: none;
            background: none;
            cursor: pointer;
            width: 100%;
            text-align: left;
        }
        
        .nav-button:hover {
            background: var(--gray-100);
            color: var(--primary);
        }
        
        .nav-button.active {
            background: var(--primary-light);
            color: white;
        }
        
        .nav-button i {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        /* Content Pages */
        .content-page {
            display: none;
            height: 100%;
            flex-direction: column;
        }
        
        .content-page.active {
            display: flex;
        }
        
        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        
        .message.assistant {
            align-self: flex-start;
            background: var(--gray-100);
            border-bottom-left-radius: 0.25rem;
            color: var(--dark);
        }
        
        .message.user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Input Container */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            background: white;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
            z-index: 20;
        }
        
        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            display: flex;
            gap: 0.75rem;
        }
        
        #inputBox {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            transition: all 0.2s;
            resize: none;
            min-height: 56px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        #inputBox:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        .send-button, .voice-button {
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            border: none;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .send-button:hover, .voice-button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .send-button:active, .voice-button:active {
            transform: translateY(0);
        }
        
        .send-button i, .voice-button i {
            font-size: 1.25rem;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        
        .login-card {
            background: white;
            border-radius: 1rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            animation: slideUp 0.5s ease-out;
        }
        
        .login-header {
            margin-bottom: 2rem;
        }
        
        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .login-logo i {
            font-size: 2rem;
        }
        
        .login-card h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .login-card p {
            color: var(--gray-500);
            margin-bottom: 2rem;
        }
        
        .login-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            background: white;
            color: var(--dark);
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .google-signin-btn:hover {
            background: var(--gray-50);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .google-signin-btn img {
            width: 20px;
            height: 20px;
        }
        
        .privacy-note {
            font-size: 0.75rem;
            color: var(--gray-400);
            margin-top: 1.5rem;
            line-height: 1.5;
        }
        
        /* Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                flex-direction: row;
                padding: 1rem;
                border-bottom: 1px solid var(--gray-200);
            }
            
            .logo-container {
                display: none;
            }
            
            .nav-buttons {
                flex-direction: row;
                justify-content: space-around;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            .nav-button span {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
                padding-bottom: 100px;
            }
            
            .input-container {
                padding: 1rem;
            }
            
            .input-wrapper {
                gap: 0.5rem;
            }
            
            .send-button, .voice-button {
                width: 44px;
                height: 44px;
            }
            
            .login-card {
                padding: 1.5rem;
            }
        }
        
        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            body {
                background: #0f172a;
                color: white;
            }
            
            .sidebar {
                background: #1e293b;
                border-right: 1px solid #334155;
            }
            
            .logo-container {
                border-bottom-color: #334155;
            }
            
            .nav-button {
                color: #cbd5e1;
            }
            
            .nav-button:hover {
                background: #334155;
                color: white;
            }
            
            .nav-button.active {
                background: #4f46e5;
                color: white;
            }
            
            .chat-container, .login-card {
                background: #1e293b;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            }
            
            .message.assistant {
                background: #334155;
                color: #e2e8f0;
            }
            
            .message.user {
                background: #4f46e5;
                color: white;
            }
            
            #inputBox {
                background: #1e293b;
                border-color: #334155;
                color: white;
            }
            
            #inputBox::placeholder {
                color: #94a3b8;
            }
            
            .input-container {
                background: #1e293b;
                border-top: 1px solid #334155;
            }
            
            .login-card h1 {
                color: white;
            }
            
            .login-card p {
                color: #94a3b8;
            }
            
            .google-signin-btn {
                background: #334155;
                color: white;
                border-color: #475569;
            }
            
            .google-signin-btn:hover {
                background: #475569;
            }
            
            .privacy-note {
                color: #64748b;
            }
        }
    </style>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#6366f1">
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="./icon-192x192.png">
    <!-- Mobile Optimizations -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no" />
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
          --primary: #6366f1;
          --primary-dark: #4f46e5;
          --secondary: #8b5cf6;
          --accent: #06b6d4;
          --success: #10b981;
          --warning: #f59e0b;
          --error: #ef4444;
          --dark: #0f172a;
          --dark-light: #1e293b;
          --gray: #64748b;
          --gray-light: #f1f5f9;
          --white: #ffffff;
          --glass: rgba(255, 255, 255, 0.1);
          --glass-dark: rgba(0, 0, 0, 0.2);
        }
        
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }
        
        body, html {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
          background-size: 400% 400%;
          animation: gradientShift 15s ease infinite;
          color: var(--white);
          overflow-x: hidden;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
        
        @keyframes gradientShift {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
#cornerText {
 position: fixed;
 top: 20px;
 left: 20px;
 background: rgba(255,255,255,0.7);
 padding: 10px 15px;
 font-weight: bold;
 border-radius: 6px;
}
        .main-container {
          background: var(--glass);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 24px;
          padding: 40px;
          max-width: 700px;
          width: 95%;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
          margin: auto;
          text-align: center;
        }
        
        /* App Layout */
        .app-layout {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
          background-size: 400% 400%;
          animation: gradientShift 15s ease infinite;
        }
        
        .app-layout.active {
          display: flex;
        }
        
        .sidebar {
          width: 280px;
          background: var(--glass);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border-right: 1px solid rgba(255, 255, 255, 0.2);
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 24px;
        }
        
        .user-profile {
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 20px;
          background: var(--glass);
          backdrop-filter: blur(10px);
          border-radius: 16px;
          border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-avatar {
          width: 48px;
          height: 48px;
          border-radius: 50%;
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 600;
          font-size: 18px;
        }
        
        .user-info {
          flex: 1;
        }
        
        .user-name {
          font-weight: 600;
          color: var(--white);
          margin: 0 0 4px 0;
          font-size: 16px;
        }
        
        .user-email {
          font-size: 14px;
          color: rgba(255, 255, 255, 0.7);
          margin: 0;
        }
        
        .nav-tabs {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        
        .nav-tab {
          padding: 16px 20px;
          border-radius: 12px;
          background: transparent;
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: rgba(255, 255, 255, 0.7);
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 12px;
          font-size: 15px;
          font-weight: 500;
        }
        
        .nav-tab:hover {
          background: rgba(255, 255, 255, 0.1);
          color: var(--white);
          transform: translateX(4px);
        }
        
        .nav-tab.active {
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: var(--white);
          border-color: transparent;
          box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }
        
        .main-content {
          flex: 1;
          padding: 24px;
          overflow-y: auto;
        }
        
        .tab-content {
          display: none;
          height: 100%;
        }
        
        .tab-content.active {
          display: flex;
          flex-direction: column;
        }
        
        .content-header {
          margin-bottom: 24px;
        }
        
        .content-title {
          font-size: 2rem;
          font-weight: 700;
          color: var(--white);
          margin: 0 0 8px 0;
        }
        
        .content-subtitle {
          color: rgba(255, 255, 255, 0.7);
          margin: 0;
        }
        
        .main-container::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }
        
        .main-container:hover {
          transform: translateY(-2px);
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        .input-container {
          position: fixed;
          bottom: 32px;
          left: 50%;
          transform: translateX(-50%);
          width: 90%;
          max-width: 700px;
          display: flex;
          gap: 12px;
          align-items: center;
          z-index: 100;
        }
        
        .input-wrapper {
          flex: 1;
          position: relative;
        }
        
        .smart-input {
          width: 100%;
          padding: 18px 24px;
          border: none;
          border-radius: 50px;
          font-size: 16px;
          font-weight: 400;
          outline: none;
          background: var(--glass);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          color: var(--white);
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
          min-height: 56px;
          box-sizing: border-box;
        }
        
        .smart-input::placeholder {
          color: rgba(255, 255, 255, 0.7);
        }
        
        .smart-input:focus {
          transform: translateY(-2px);
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
          border-color: rgba(255, 255, 255, 0.4);
        }
        
        .action-button {
          padding: 18px 24px;
          font-size: 16px;
          font-weight: 600;
          border-radius: 50px;
          border: none;
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: var(--white);
          cursor: pointer;
          transition: all 0.3s ease;
          min-height: 56px;
          min-width: 120px;
          box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }
        
        .action-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 12px 40px rgba(99, 102, 241, 0.4);
        }
        
        .action-button:active {
          transform: translateY(0);
        }

        .voice-button {
          width: 56px;
          height: 56px;
          border-radius: 50%;
          border: none;
          background: linear-gradient(135deg, var(--success), var(--accent));
          color: var(--white);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          transition: all 0.3s ease;
          box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        }
        
        .voice-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 12px 40px rgba(16, 185, 129, 0.4);
        }
        
        .voice-button.recording {
          background: linear-gradient(135deg, var(--error), var(--warning));
          animation: pulse 2s infinite;
        }
        
        .chat-container {
          max-height: 60vh;
          overflow-y: auto;
          padding: 20px 0;
          scroll-behavior: smooth;
        }
        
        .message {
          margin: 16px 0;
          padding: 16px 20px;
          border-radius: 20px;
          max-width: 85%;
          word-wrap: break-word;
          animation: slideIn 0.3s ease;
        }
        
        .message.user {
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: var(--white);
          margin-left: auto;
          border-bottom-right-radius: 8px;
        }
        
        .message.assistant {
          background: var(--glass);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          color: var(--white);
          border-bottom-left-radius: 8px;
        }
        
        .typing-indicator {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 16px 20px;
          background: var(--glass);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          border-bottom-left-radius: 8px;
          max-width: 85%;
          margin: 16px 0;
        }
        
        .dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: rgba(255, 255, 255, 0.7);
          animation: typing 1.4s infinite;
        }
        
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
          0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
          30% { transform: translateY(-10px); opacity: 1; }
        }
        
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }
        
        .header {
          text-align: center;
          margin-bottom: 32px;
        }
        
        .logo-container {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 16px;
          margin-bottom: 16px;
        }
        
        .app-logo {
          width: 64px;
          height: 64px;
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
          transition: transform 0.3s ease;
        }
        
        .app-logo:hover {
          transform: scale(1.05);
        }
        
        .header h1 {
          font-size: 2.5rem;
          font-weight: 700;
          margin: 0;
          background: linear-gradient(135deg, var(--white), rgba(255, 255, 255, 0.8));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        
        .header p {
          font-size: 1.1rem;
          opacity: 0.9;
          font-weight: 400;
        }
        
        .feature-pills {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          justify-content: center;
          margin-top: 16px;
        }
        
        .pill {
          padding: 6px 12px;
          background: var(--glass);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          font-size: 0.85rem;
          color: rgba(255, 255, 255, 0.9);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
          .header h1 {
            font-size: 2rem;
          }
          
          .main-container {
            padding: 24px;
            margin: 0 16px;
          }
          
          .input-container {
            bottom: 16px;
            width: 95%;
            gap: 8px;
          }
          
          .smart-input {
            padding: 16px 20px;
            font-size: 16px;
          }
          
          .voice-button {
            width: 48px;
            height: 48px;
            font-size: 18px;
          }
          
          .action-button {
            padding: 16px 20px;
            min-width: 100px;
            font-size: 15px;
          }
        }
        
        @media (max-width: 480px) {
          .feature-pills {
            gap: 6px;
          }
          
          .pill {
            font-size: 0.8rem;
            padding: 4px 8px;
          }
          
          .header p {
            font-size: 1rem;
          }
        }
        
        /* Custom Scrollbar */
        .chat-container::-webkit-scrollbar {
          width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 3px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.3);
          border-radius: 3px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.5);
        }
        
        /* Dashboard Styles */
        .dashboard-container {
            padding: 2rem;
            color: white;
        }
        
        .welcome-message {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .action-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .action-card i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            color: var(--accent);
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .nav-tab {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        
        .nav-tab i {
            width: 24px;
            text-align: center;
        }
        
        .nav-tab:hover,
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-tab.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 500;
        }
        
        /* User Profile */
        .user-profile {
            margin-top: auto;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
        }
        
        .user-info {
            flex: 1;
            overflow: hidden;
        }
        
        .user-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-email {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Tab Content */
        /* Sidebar Navigation */
        .nav-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            margin: 0.5rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-button.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        
        .nav-button.sign-out {
            position: absolute;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .nav-button i {
            pointer-events: none;
        }
        
        /* Content Pages */
        .content-page {
            display: none;
            height: 100%;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .content-page.active {
            display: block;
        }
        
        /* Welcome Page Styles */
        .welcome-content {
          text-align: center;
          padding: 2rem;
          color: white;
        }
        
        .welcome-logo {
          width: 120px;
          height: 120px;
          margin-bottom: 1.5rem;
          animation: float 6s ease-in-out infinite;
        }
        
        .welcome-content h1 {
          font-size: 2.5rem;
          margin-bottom: 1rem;
          background: linear-gradient(45deg, #ff6b6b, #6b6bff);
          -webkit-background-clip: text;
          background-clip: text;
          -webkit-text-fill-color: transparent;
        }
        
        .welcome-content p {
          font-size: 1.2rem;
          margin-bottom: 2rem;
          color: #e0e0e0;
        }
        
        .welcome-buttons {
          display: flex;
          gap: 1rem;
          justify-content: center;
          margin-top: 2rem;
        }
        
        @keyframes float {
          0% { transform: translateY(0px); }
          50% { transform: translateY(-15px); }
          100% { transform: translateY(0px); }
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 420px;
            padding: 40px;
            text-align: center;
            transform: translateY(0);
            opacity: 1;
            transition: all 0.4s ease;
        }
        
        .login-header {
            margin-bottom: 32px;
        }
        
        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
            color: #6366f1;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .login-logo i {
            font-size: 2rem;
        }
        
        .login-card h1 {
            color: #1e293b;
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .login-card p {
            color: #64748b;
            font-size: 1rem;
            margin-bottom: 0;
        }
        
        .login-buttons {
            margin-bottom: 24px;
        }
        
        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px 24px;
            background: #fff;
            color: #1f2937;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .google-signin-btn:hover {
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .google-signin-btn:active {
            transform: translateY(0);
        }
        
        .google-signin-btn img {
            width: 20px;
            height: 20px;
        }
        
        .login-footer {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #f1f5f9;
        }
        
        .login-footer p {
            font-size: 0.75rem;
            color: #94a3b8;
            line-height: 1.5;
        }
    </style>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
    <!-- Floating Particles Background -->
    <div class="floating-particles" id="particles"></div>
    
    <!-- Login Page (before login) -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Smart Scheduler</span>
                </div>
                <h1>Welcome Back</h1>
                <p>Sign in to manage your schedule with AI</p>
            </div>
            
            <div class="login-buttons">
                <button id="authorize_button" class="google-signin-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    <span>Continue with Google</span>
                </button>
            </div>
            
            <div class="login-footer">
                <p>By continuing, you agree to our Terms of Service and Privacy Policy</p>
            </div>
        </div>
    </div>
    
    <!-- App Layout (after login) -->
    <div class="app-layout" id="appLayout" style="display: none;">
        <!-- Sidebar -->
        <header class="app-header">
            <h1>Smart Scheduler</h1>
            <button id="signout_button" class="signout-button" title="Sign out">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sign out</span>
            </button>
        </header>
        <div class="sidebar">
            <!-- App Logo -->
            <div class="logo-container" style="justify-content: center; margin: 1.5rem 0 2rem 0;">
                <img src="./icon-192x192.png" alt="Smart Scheduler" class="app-logo" style="width: 40px; height: 40px; border-radius: 8px;">
            </div>
            
            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button id="welcomeBtn" class="nav-button active" title="Home">
                    <i class="fas fa-home"></i>
                </button>
                <button id="chatBtn" class="nav-button" title="Chat">
                    <i class="fas fa-comment"></i>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Welcome Page (shown by default) -->
            <div class="content-page active" id="welcomePage">
                <div style="text-align: center; margin-top: 5rem;">
                    <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Welcome, <span id="welcomeName">User</span>! </h1>
                    <p style="color: #94a3b8; margin-bottom: 2rem;">How can I help you schedule today?</p>
                    
                    <!-- Quick Actions -->
                    <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 3rem;">
                        <button class="quick-action" onclick="document.getElementById('chatBtn').click()">
                            <i class="fas fa-plus"></i>
                            <span>New Event</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chat Page -->
            <div class="content-page" id="chatPage" style="display: none;">
                <div class="chat-container" id="chatContainer">
                    <div id="message" class="message assistant">
                        <strong> Assistant:</strong><br>
                        Welcome! I'm your smart scheduling assistant. How can I help you today?
                    </div>
                </div>
            </div>
        </div>    
    </div>
    
    <!-- Input Container (initially hidden) -->
    <div class="input-container" id="inputContainer" style="display: none;">
        <div class="input-wrapper">
            <input type="text" id="inputBox" class="smart-input" placeholder=" Tell me about your plans..." disabled />
        </div>
        <button id="voiceButton" class="voice-button" disabled></button>
    </div>

<script>
    // Note: These should be loaded from environment variables in production
    // For now, using CONFIG from config.js which handles environment variables
    const CLIENT_ID = window.CONFIG?.GOOGLE?.CLIENT_ID || 'CLIENT_ID_NOT_CONFIGURED';
    const TOGETHER_API_KEY = window.CONFIG?.TOGETHER_API?.KEY || 'API_KEY_NOT_CONFIGURED';
    const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

    let tokenClient, accessToken = null;
    let gapiInited = false, gisInited = false;
    let chatHistory = [];
    let questionCount = 0;
    let baseDate = new Date(); // Base date for the session
    let eventDetails = {
      date: null,
      time: null,
      attendees: null,
      location: null,
      attendeeEmails: []
    };

    // Validate API key format
    function validateApiKey(apiKey) {
      if (!apiKey || typeof apiKey !== 'string' || apiKey.length < 10) {
        console.error('Invalid API key format');
        return false;
      }
      return true;
    }

    // Function to track what information we still need
    function getMissingInfo() {
      const missing = [];
      if (!eventDetails.date) missing.push('date/day');
      if (!eventDetails.time) missing.push('time');
      if (!eventDetails.attendees) missing.push('who is attending');
      if (!eventDetails.location) missing.push('location');
      return missing;
    }

    // Function to get contextual missing info (for backward compatibility)
    function getContextualMissingInfo() {
      return getMissingInfo();
    }

    // Function to determine the next action needed
    function getNextAction() {
      if (!eventDetails.date) return 'Ask for date/day';
      if (!eventDetails.time) return 'Ask for time';
      if (!eventDetails.location) return 'Ask for location';
      if (requiresEmailInvitation() && eventDetails.attendeeEmails.length === 0) {
        return 'Ask for email address';
      }
      return 'Ready to create event';
    }

    // Function to parse date and time into a DateTime object
    function parseDateTime(dateStr, timeStr) {
      if (!dateStr || !timeStr) return null;

      // Use baseDate instead of current time for consistent calculations
      let targetDate = new Date(baseDate);

      // Parse date
      const dateLower = dateStr.toLowerCase();
      if (dateLower === 'today') {
        targetDate = new Date(baseDate);
      } else if (dateLower === 'tomorrow') {
        targetDate = new Date(baseDate.getTime() + 24 * 60 * 60 * 1000);
      } else if (dateLower.startsWith('next ')) {
        const day = dateLower.replace('next ', '');
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const targetDay = days.indexOf(day);
        if (targetDay !== -1) {
          const currentDay = baseDate.getDay();
          let daysToAdd = targetDay - currentDay;
          if (daysToAdd <= 0) daysToAdd += 7;
          targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
          console.log(`Next ${day}: base day ${currentDay}, target day ${targetDay}, days to add ${daysToAdd}`);
        }
      } else if (dateLower.startsWith('this ')) {
        const day = dateLower.replace('this ', '');
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const targetDay = days.indexOf(day);
        if (targetDay !== -1) {
          const currentDay = baseDate.getDay();
          let daysToAdd = targetDay - currentDay;
          if (daysToAdd < 0) daysToAdd += 7;
          targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
        }
      } else {
        // Handle just day names like "monday", "tuesday", etc.
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        if (days.includes(dateLower)) {
          const targetDay = days.indexOf(dateLower);
          if (targetDay !== -1) {
            const currentDay = baseDate.getDay();
            let daysToAdd = targetDay - currentDay;
            // If it's the same day or past, schedule for next week
            if (daysToAdd <= 0) daysToAdd += 7;
            targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
            console.log(`Scheduling for ${dateLower}: base day ${currentDay}, target day ${targetDay}, days to add ${daysToAdd}`);
          }
        }
      }

      // Parse time
      const timeLower = timeStr.toLowerCase();
      let hours = 0, minutes = 0;

      // Handle formats like "9 AM", "2:30 PM", "14:30"
      const timeMatch = timeLower.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)?/);
      if (timeMatch) {
        hours = parseInt(timeMatch[1]);
        minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;

        if (timeMatch[3]) {
          const isPM = timeMatch[3] === 'pm';
          if (isPM && hours !== 12) hours += 12;
          if (!isPM && hours === 12) hours = 0;
        }
      }

      // Set the time on the target date
      targetDate.setHours(hours, minutes, 0, 0);

      console.log(`Time parsing: "${timeStr}" -> hours: ${hours}, minutes: ${minutes}, final time: ${targetDate.toLocaleString()}`);

      return targetDate;
    }

    // Function to extract and update event details from user input
    function updateEventDetails(userInput) {
      const input = userInput.toLowerCase();

      // Extract date patterns (only if we don't already have a date)
      if (!eventDetails.date) {
        const datePatterns = [
          /(today|tomorrow|next \w+|this \w+)/i,
          /(\d{1,2}\/\d{1,2}|\d{1,2}-\d{1,2})/,
          /(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/i,
          /(january|february|march|april|may|june|july|august|september|october|november|december)/i
        ];

        let dateFound = false;
        for (const pattern of datePatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.date = match[0];
            dateFound = true;
            break;
          }
        }

        // If no date is mentioned, assume today
        if (!dateFound) {
          eventDetails.date = 'today';
        }
      }

      // Extract time patterns
      if (!eventDetails.time) {
        const timePatterns = [
          /(\d{1,2}:\d{2}\s*(am|pm))/i,
          /(\d{1,2}\s*(am|pm))/i,
          /(\d{1,2}:\d{2})/,
          /(\d{1,2}\s*o'clock)/i,
          /^(\d{1,2})$/  // Handle single digits like "9"
        ];

        for (const pattern of timePatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.time = match[0];
            console.log(`Time extracted: "${match[0]}" from input "${userInput}"`);
            break;
          }
        }
      }

      // If we have a date but no time, and the input looks like just a time, extract it
      if (eventDetails.date && !eventDetails.time) {
        const timeOnlyPatterns = [
          /^(\d{1,2}:\d{2}\s*(am|pm))$/i,
          /^(\d{1,2}\s*(am|pm))$/i,
          /^(\d{1,2}:\d{2})$/,
          /^(\d{1,2}\s*o'clock)$/i,
          /^(\d{1,2})$/  // Handle single digits like "9"
        ];

        for (const pattern of timeOnlyPatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.time = match[0];
            console.log(`Time-only extracted: "${match[0]}" from input "${userInput}"`);
            break;
          }
        }
      }

      // Extract attendees - prioritize patterns that include other people
      if (!eventDetails.attendees) {
        // First check for patterns that include other people
        const otherPeoplePatterns = [
          /(with\s+my\s+\w+)/i,  // "with my mom", "with my dad"
          /(and\s+my\s+\w+)/i,   // "and my mom"
          /(me\s+and\s+\w+)/i,   // "me and mom"
          /(\w+\s+and\s+me)/i,   // "mom and me"
          /(mom|mother|dad|father|brother|sister|family)/i,
          /(friend|friends|colleague|colleagues|team)/i,
          /(spouse|wife|husband|girlfriend|boyfriend|partner)/i,
          /(boss|manager|client|doctor|teacher)/i
        ];
        
        // Then check for solo patterns
        const soloPatterns = [
          /(myself|me|i|alone)/i,
          /(just\s+\w+)/i
        ];

        // Try other people patterns first
        for (const pattern of otherPeoplePatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.attendees = match[0];
            console.log(`Attendees extracted (with others): "${match[0]}"`);
            break;
          }
        }
        
        // If no other people found, try solo patterns
        if (!eventDetails.attendees) {
          for (const pattern of soloPatterns) {
            const match = input.match(pattern);
            if (match) {
              eventDetails.attendees = match[0];
              console.log(`Attendees extracted (solo): "${match[0]}"`);
              break;
            }
          }
        }
      }

      // Extract location
      if (!eventDetails.location) {
        const locationPatterns = [
          /(at|in|to)\s+(\w+)/i,
          /(bank|home|office|school|hospital|restaurant|cafe|store|mall|park|gym|library|church|airport)/i,
          /(the\s+\w+)/i
        ];

        for (const pattern of locationPatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.location = match[0];
            break;
          }
        }
      }

      // Extract email addresses for invitations
      const emailPattern = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
      const emailMatches = userInput.match(emailPattern);
      if (emailMatches) {
        emailMatches.forEach(email => {
          if (!eventDetails.attendeeEmails.includes(email)) {
            eventDetails.attendeeEmails.push(email);
            console.log(`Email added for invitation: ${email}`);
          }
        });
      }

      // Handle "no" responses to email requests
      if (input.includes('no') && input.length < 10) {
        console.log('User declined to provide email addresses');
      }
    }

    // Function to check if other people are mentioned in attendees
    function requiresEmailInvitation() {
      if (!eventDetails.attendees) {
        console.log('requiresEmailInvitation: No attendees found');
        return false;
      }
      
      const attendeesLower = eventDetails.attendees.toLowerCase();
      console.log(`requiresEmailInvitation: Checking attendees: "${eventDetails.attendees}"`);
      
      const otherPeopleKeywords = [
        'mom', 'mother', 'dad', 'father', 'brother', 'sister', 
        'friend', 'colleague', 'team', 'family', 'spouse', 
        'wife', 'husband', 'girlfriend', 'boyfriend', 'partner',
        'boss', 'manager', 'client', 'doctor', 'teacher'
      ];
      
      // Check if any keywords for other people are mentioned
      const mentionsOthers = otherPeopleKeywords.some(keyword => 
        attendeesLower.includes(keyword)
      );
      
      // Don't require email if it's just the user
      const justUser = attendeesLower.includes('myself') || 
                      attendeesLower.includes('me') || 
                      attendeesLower.includes('alone') ||
                      attendeesLower === 'i';
      
      const result = mentionsOthers && !justUser;
      console.log(`requiresEmailInvitation: mentionsOthers=${mentionsOthers}, justUser=${justUser}, result=${result}`);
      
      return result;
    }

    // Function to generate a smart event name using LLM
    async function generateSmartEventName() {
      const prompt = `Create a concise, descriptive event title based on these details:
- Date: ${eventDetails.date}
- Time: ${eventDetails.time}
- Attendees: ${eventDetails.attendees}
- Location: ${eventDetails.location}

Generate a natural, professional event title (2-6 words). Examples:
- "Bank Visit with Mom"
- "Team Meeting at Office"
- "Lunch with Friends"
- "Doctor Appointment"
- "Family Dinner"

Respond with ONLY the event title, no quotes or extra text.`;

      try {
        const body = {
          model: "mistralai/Mixtral-8x7B-Instruct-v0.1",
          messages: [
            {
              role: "system",
              content: "You are an expert at creating concise, professional event titles. Respond with only the event title, nothing else."
            },
            {
              role: "user",
              content: prompt
            }
          ],
          max_tokens: 50,
          temperature: 0.3
        };

        const response = await fetch("https://api.together.xyz/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${TOGETHER_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }

        const data = await response.json();
        const eventName = data.choices?.[0]?.message?.content?.trim() || "Event";
        
        console.log(`Generated smart event name: "${eventName}"`);
        return eventName;
      } catch (error) {
        console.error('Error generating smart event name:', error);
        // Fallback to a simple name
        return `${eventDetails.location ? eventDetails.location.charAt(0).toUpperCase() + eventDetails.location.slice(1) : 'Event'} ${eventDetails.attendees ? 'with ' + eventDetails.attendees : ''}`;
      }
    }

     // UI elements will be initialized in the onload function
     let authBtn, inputBox, msg, darkToggle, voiceButton;

     // Voice recognition setup
     let recognition;
     
     function setupVoiceRecognition() {
         if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
             recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
             recognition.continuous = false;
             recognition.interimResults = true;
             recognition.lang = 'en-US';

             recognition.onstart = () => {
                 if (voiceButton) voiceButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
             };

             recognition.onresult = (event) => {
                 if (!inputBox) return;
                 const transcript = Array.from(event.results)
                     .map(result => result[0])
                     .map(result => result.transcript)
                     .join('');
                 inputBox.value = transcript;
             };

             recognition.onend = () => {
                 if (voiceButton) voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
             };

             recognition.onerror = (event) => {
                 console.error('Speech recognition error', event.error);
                 if (voiceButton) voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
             };
         } else {
             console.warn('Speech Recognition API not supported in this browser');
         }
     }

    async function gapiLoaded() {
      try {
        console.log('Loading Google API client...');
        await new Promise((resolve, reject) => {
          gapi.load('client', {
            callback: resolve,
            onerror: reject
          });
        });
        await initializeGapi();
      } catch (error) {
        console.error('Failed to load Google API:', error);
      }
    }
    
    async function initializeGapi() {
      try {
        console.log('Initializing Google API client...');
        await gapi.client.init({
          discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        console.log('Google API client initialized successfully');
        maybeEnableButtons();
      } catch (error) {
        console.error('Failed to initialize Google API:', error);
      }
    }
    
    function gisLoaded() {
      try {
        console.log('Initializing Google Identity Services...');
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (resp) => {
            if (resp.error !== undefined) {
              console.error('OAuth error:', resp.error);
              return;
            }
            accessToken = resp.access_token;
            console.log('OAuth token received');
            handleAuthSuccess();
          },
        });
        gisInited = true;
        console.log('Google Identity Services initialized successfully');
        maybeEnableButtons();
      } catch (error) {
        console.error('Failed to initialize Google Identity Services:', error);
      }
    }
    
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        console.log('Google APIs initialized, enabling sign-in button');
        const authBtn = document.getElementById('authorize_button');
        if (authBtn) {
          authBtn.onclick = handleAuthClick;
          authBtn.disabled = false;
        }
      }
    }
    
    function handleAuthClick() {
      console.log('Auth button clicked');
      if (!tokenClient) {
        console.error('Token client not initialized');
        return;
      }
      
      if (gapi.client.getToken() === null) {
        console.log('Requesting new access token with consent');
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        console.log('Using existing access token');
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

     // Voice button click handler is now in initializeUI()
     
     // Auth button click handler will be set up in initializeUI()
     function setupAuthButton() {
       if (!authBtn) {
         authBtn = document.getElementById('authButton');
         if (!authBtn) {
           console.error('Auth button not found in the DOM');
           return;
         }
       }
       
       authBtn.onclick = () => {
         if (!tokenClient) {
           console.error('Token client not initialized');
           return;
         }
         
         tokenClient.callback = async (resp) => {
           if (resp.error) {
             console.error('Auth error:', resp.error);
             if (msg) msg.textContent = 'Auth error: ' + resp.error;
             return;
           }
           
           accessToken = resp.access_token;
           
           // After successful login
           async function handleAuthSuccess() {
             // Show app layout
             const loginContainer = document.getElementById('loginContainer');
             const appLayout = document.getElementById('appLayout');
             
             if (loginContainer) loginContainer.style.display = 'none';
             if (appLayout) appLayout.classList.add('active');
             
             // Load user profile
           await loadUserProfile();
           
           // Initialize navigation
           setupNavigation();
           
           // Show welcome page by default
           document.getElementById('welcomePage').classList.add('active');
         }
         handleAuthSuccess();
         
         // Switch to app layout
         document.getElementById('loginLayout').style.display = 'none';
         document.getElementById('appLayout').classList.add('active');
         
         // Enable input
         inputBox.disabled = false;
         voiceButton.disabled = false;
       };
       tokenClient.requestAccessToken();
     };
     
     // Setup navigation between pages
    function setupNavigation() {
      // Welcome button
      document.getElementById('welcomeBtn').addEventListener('click', () => {
        document.getElementById('welcomePage').style.display = 'block';
        document.getElementById('chatPage').style.display = 'none';
        document.getElementById('inputContainer').style.display = 'none';
        
        // Update active state
        document.getElementById('welcomeBtn').classList.add('active');
        document.getElementById('chatBtn').classList.remove('active');
      });
      
      // Chat button
      document.getElementById('chatBtn').addEventListener('click', () => {
        document.getElementById('welcomePage').style.display = 'none';
        document.getElementById('chatPage').style.display = 'block';
        document.getElementById('inputContainer').style.display = 'flex';
        
        // Update active state
        document.getElementById('welcomeBtn').classList.remove('active');
        document.getElementById('chatBtn').classList.add('active');
        
        // Focus input
        setTimeout(() => {
          const input = document.getElementById('inputBox');
          if (input) input.focus();
        }, 100);
      });
      
      // Sign out button
      document.getElementById('signOutBtn').addEventListener('click', () => {
        // Sign out logic
        if (accessToken) {
          google.accounts.oauth2.revoke(accessToken);
          accessToken = null;
        }
        
        // Reset UI
        document.getElementById('appLayout').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
        
        // Reset input
        const inputBox = document.getElementById('inputBox');
        inputBox.value = '';
        inputBox.disabled = true;
        
        // Reset message
        const msg = document.getElementById('message');
        if (msg) {
          msg.innerHTML = '<strong> Assistant:</strong><br>Welcome! Please sign in to get started with your smart scheduling assistant.';
        }
        
        // Show auth button
        document.getElementById('authorize_button').style.display = 'inline-block';
      });
    }

     // Tab switching functionality
     function setupTabs() {
       const tabs = document.querySelectorAll('.nav-tab');
       
       tabs.forEach(tab => {
         tab.addEventListener('click', () => {
           // Remove active class from all tabs and content
           document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
           document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
           
           // Add active class to clicked tab and corresponding content
           tab.classList.add('active');
           const tabId = tab.getAttribute('data-tab');
           document.getElementById(`${tabId}Tab`).classList.add('active');
           
           // If switching to chat, focus the input
           if (tabId === 'chat') {
             setTimeout(() => {
               const input = document.getElementById('inputBox');
               if (input) input.focus();
             }, 100);
           }
         });
       });
     }
     
     // Initialize dashboard functionality
     function initializeDashboard() {
       // Setup tab switching
       setupTabs();
       
       // Quick action buttons
       document.querySelectorAll('.action-card').forEach(card => {
         card.addEventListener('click', () => {
           const action = card.getAttribute('data-action');
           
           switch(action) {
             case 'schedule':
               // Switch to chat tab and focus input
               document.querySelector('.nav-tab[data-tab="chat"]').click();
               break;
               
             case 'upcoming':
               // Show upcoming events (placeholder)
               alert('Upcoming events feature coming soon!');
               break;
               
             case 'settings':
               // Show settings (placeholder)
               alert('Settings feature coming soon!');
               break;
           }
         });
       });
     }

     // Load user profile from Google
    async function loadUserProfile() {
      if (!gapi.client || !gapi.client.oauth2) {
        console.log('Google API not ready yet');
        return;
      }
      
      try {
        const response = await gapi.client.oauth2.userinfo.get();
        const user = response.result;
        
        // Update UI with user info
        const displayName = user.name || 'User';
        document.getElementById('welcomeName').textContent = displayName;
        
        // Set random avatar color
        const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#10b981', '#0ea5e9'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        document.documentElement.style.setProperty('--primary', randomColor);
        
        console.log('User profile loaded:', displayName);
        return displayName;
      } catch (error) {
        console.error('Error loading user profile:', error);
        return 'User';
      }
    }

     // Sign out handler
     signOutBtn.onclick = () => {
       if (accessToken) {
         google.accounts.oauth2.revoke(accessToken);
       }
       accessToken = null;
       inputBox.value = '';
       inputBox.disabled = true;
       voiceButton.disabled = true;
       msg.textContent = 'Signed out.';
       authBtn.style.display = 'inline-block';
       signOutBtn.style.display = 'none';
     };

        async function sendToLLM(text, isFinal = false) {
      chatHistory.push({ role: "user", content: text });

      // Get current date and time for the prompt
      const currentDateTime = new Date().toLocaleString();

      let systemPrompt = isFinal
        ? "Based on this conversation, create a calendar event. Return a JSON object with this format: {\"summary\": \"Event title\", \"dateTime\": \"2025-08-01T14:00:00Z\"}. Use ISO 8601 format and UTC time. Combine the date and time information to create the dateTime field."
        : `You are a direct and efficient scheduling assistant. You need to gather exactly 4 pieces of information in this order:

1) DATE/DAY (e.g., "Tuesday", "tomorrow", "January 15th")
2) TIME (e.g., "5 PM", "9:30 AM")
3) LOCATION (e.g., "bank", "restaurant", "home")
4) EMAIL for other people mentioned (if any)

Current date and time: {{CURRENT_DATETIME}}

RULES:
- Ask for missing information in order: Date  Time  Location  Email
- Be direct and clear in your questions
- If someone mentions other people (mom, dad, friend, etc.), ALWAYS ask for their email address
- Use simple, short questions like "Where are you going?" or "What's your mom's email address?"
- Don't create the event until you have all required information

Current information:
- Date: ${eventDetails.date || 'Missing'}
- Time: ${eventDetails.time || 'Missing'}
- Attendees: ${eventDetails.attendees || 'Just you'}
- Location: ${eventDetails.location || 'Missing'}
- Attendee Emails: ${eventDetails.attendeeEmails.length > 0 ? eventDetails.attendeeEmails.join(', ') : 'None needed'}

NEXT ACTION: ${getNextAction()}

Respond with ONE short, direct question to get the missing information.`;

      // Replace the placeholder with actual current date and time
      systemPrompt = systemPrompt.replace('{{CURRENT_DATETIME}}', currentDateTime);

      const body = {
        model: "mistralai/Mixtral-8x7B-Instruct-v0.1",
        messages: [
          {
            role: "system",
            content: systemPrompt
          },
          ...chatHistory
        ],
        max_tokens: 300,
        temperature: 0.7
      };

      try {
        if (!validateApiKey(TOGETHER_API_KEY)) {
          throw new Error('Invalid API key configuration');
        }

        const response = await fetch("https://api.together.xyz/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${TOGETHER_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(`API error: ${data.error.message || 'Unknown error'}`);
        }

        const reply = data.choices?.[0]?.message?.content || "I couldn't understand that.";
        chatHistory.push({ role: "assistant", content: reply });
        return reply;
      } catch (error) {
        console.error('LLM API error:', error);
        const errorMessage = "Sorry, I'm having trouble processing your request. Please try again.";
        chatHistory.push({ role: "assistant", content: errorMessage });
        return errorMessage;
      }
    }

    async function createEvent(summary, dateTime, attendeeEmails = []) {
      try {
        const endDate = new Date(dateTime.getTime() + 60 * 60 * 1000);
        const event = {
          summary,
          start: { dateTime: dateTime.toISOString(), timeZone: 'UTC' },
          end: { dateTime: endDate.toISOString(), timeZone: 'UTC' }
        };
        
        // Add attendees if emails are provided
        if (attendeeEmails && attendeeEmails.length > 0) {
          event.attendees = attendeeEmails.map(email => ({ email: email.trim() }));
        }
        
        const res = await gapi.client.calendar.events.insert({
          calendarId: 'primary',
          resource: event
        });
        return res.result.htmlLink;
      } catch (error) {
        console.error('Calendar API error:', error);
        throw new Error('Failed to create calendar event. Please check your permissions and try again.');
      }
    }

    async function createEventFromDetails() {
      try {
        // Generate a smart event name using LLM
        const summary = await generateSmartEventName();

        // Parse date and time to create a proper DateTime
        const dateTime = parseDateTime(eventDetails.date, eventDetails.time);

        if (!dateTime) {
          throw new Error('Could not parse the date and time information');
        }

        // Debug logging
        console.log('Base date for session:', baseDate.toLocaleString());
        console.log('Event details:', eventDetails);
        console.log('Parsed dateTime:', dateTime);
        console.log('Current real time:', new Date());

        // Validate that the date is in the future relative to base date (with some tolerance)
        const timeDiff = dateTime.getTime() - baseDate.getTime();
        const hoursDiff = timeDiff / (1000 * 60 * 60);

        if (hoursDiff < -1) { // Allow 1 hour tolerance for past events
          throw new Error(`Event date must be in the future. The specified time (${dateTime.toLocaleString()}) is in the past relative to the session start time (${baseDate.toLocaleString()}).`);
        }

        const eventLink = await createEvent(summary, dateTime, eventDetails.attendeeEmails);
        const inviteInfo = eventDetails.attendeeEmails.length > 0 ? ` (Invites sent to: ${eventDetails.attendeeEmails.join(', ')})` : '';
        msg.innerHTML = ` Event created: <a href="${eventLink}" target="_blank">${summary}</a>${inviteInfo}`;

        // Reset for next event
        questionCount = 0;
        chatHistory = [];
        eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
        // Reset base date for new session
        baseDate = new Date();
        console.log('New session started with base date:', baseDate.toLocaleString());

      } catch (error) {
        console.error('Event creation error:', error);
        msg.textContent = ` ${error.message}`;
        questionCount = 0;
        chatHistory = [];
        eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
      }
    }

    inputBox.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;
      const text = inputBox.value.trim();
      if (!text) return;

      msg.textContent = ' Thinking...';
      inputBox.value = '';
      inputBox.disabled = true;
      questionCount++;

      // Update event details with user input
      updateEventDetails(text);

      // Debug logging
      console.log('After updateEventDetails:', eventDetails);
      console.log('Has all info:', eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location);

      // Check if we have all required information
      const hasBasicInfo = eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location;
      const needsEmailInvitation = requiresEmailInvitation();
      const hasEmailsWhenNeeded = !needsEmailInvitation || eventDetails.attendeeEmails.length > 0;
      const hasAllInfo = hasBasicInfo && hasEmailsWhenNeeded;
      const isFinal = questionCount >= 6; // Fallback to prevent infinite loops

      console.log(`Event processing: hasBasicInfo=${hasBasicInfo}, needsEmailInvitation=${needsEmailInvitation}, hasEmailsWhenNeeded=${hasEmailsWhenNeeded}, hasAllInfo=${hasAllInfo}`);
      console.log(`Current eventDetails:`, eventDetails);

      // If we have all basic info but need emails, ask for them via AI
      if (hasBasicInfo && needsEmailInvitation && eventDetails.attendeeEmails.length === 0) {
        console.log('All basic info gathered, but need email for invitation - continuing to AI');
        // Continue to AI to ask for email
      }
      // If we have all info including emails (when needed), create event directly
      else if (hasAllInfo) {
        console.log('All information complete - creating event directly');
        msg.textContent = ' All information gathered! Creating your event...';
        await createEventFromDetails();
        return;
      }

      const reply = await sendToLLM(text, isFinal);

      if (isFinal) {
        try {
          const jsonMatch = reply.match(/{[^}]+}/);
          if (jsonMatch) {
            const parsed = JSON.parse(jsonMatch[0]);
            const { summary, dateTime } = parsed;

            // Validate date string
            const eventDate = new Date(dateTime);
            if (isNaN(eventDate.getTime())) {
              throw new Error('Invalid date format received from AI');
            }

            // Check if date is in the future relative to base date (with tolerance)
            const timeDiff = eventDate.getTime() - baseDate.getTime();
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            if (hoursDiff < -1) { // Allow 1 hour tolerance for past events
              throw new Error(`Event date must be in the future. The specified time (${eventDate.toLocaleString()}) is in the past relative to the session start time (${baseDate.toLocaleString()}).`);
            }

            // Generate smart event name instead of using basic summary
            const smartEventName = await generateSmartEventName();

            const eventLink = await createEvent(smartEventName, eventDate, eventDetails.attendeeEmails);
            const inviteInfo = eventDetails.attendeeEmails.length > 0 ? ` (Invites sent to: ${eventDetails.attendeeEmails.join(', ')})` : '';
            msg.innerHTML = ` Event created: <a href="${eventLink}" target="_blank">${smartEventName}</a>${inviteInfo}`;
            questionCount = 0;
            chatHistory = [];
            eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
            // Reset base date for new session
            baseDate = new Date();
            console.log('New session started with base date:', baseDate.toLocaleString());
            return;
          } else {
            throw new Error('No valid JSON found in response');
          }
        } catch (err) {
          console.error('Event creation error:', err);
          msg.textContent = ` ${err.message || "I couldn't understand the schedule details. Please try again."}`;
          questionCount = 0;
          chatHistory = [];
          eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
          // Reset base date for new session
          baseDate = new Date();
        }
      } else {
        // Check again if we now have all info after AI response
        const hasBasicInfoAfterAI = eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location;
        const needsEmailAfterAI = requiresEmailInvitation();
        const hasEmailsWhenNeededAfterAI = !needsEmailAfterAI || eventDetails.attendeeEmails.length > 0;
        const hasAllInfoAfterAI = hasBasicInfoAfterAI && hasEmailsWhenNeededAfterAI;

        if (hasAllInfoAfterAI) {
          msg.textContent = ' All information gathered! Creating your event...';
          await createEventFromDetails();
          return;
        }

        // Show progress indicator and gathered info
        const progressInfo = `<br><br><small> Progress: ${4 - getMissingInfo().length}/4 details gathered</small>`;

        const gatheredInfo = eventDetails.date || eventDetails.time || eventDetails.attendees || eventDetails.location
          ? `<br><small> Gathered: ${[eventDetails.date, eventDetails.time, eventDetails.attendees, eventDetails.location].filter(Boolean).join(', ')}</small>`
          : '';

        msg.innerHTML = `<strong> Assistant:</strong><br>${reply.replace(/\n/g, '<br>')}${progressInfo}${gatheredInfo}`;
      }

      // Re-enable input box after processing
      inputBox.disabled = false;
    });

    // Create floating particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 50;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (15 + Math.random() * 10) + 's';
        particlesContainer.appendChild(particle);
      }
    }
    
    // Enhanced message display with animations
    function displayMessage(content, type = 'assistant') {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = content;
      
      // Replace the current message or add new one
      const existingMessage = document.getElementById('message');
      if (existingMessage && type === 'assistant') {
        existingMessage.innerHTML = content;
      } else {
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }
    
    // Show typing indicator
    function showTyping() {
      const chatContainer = document.getElementById('chatContainer');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing';
      typingDiv.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatContainer.appendChild(typingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Google API initialization with better error handling
    async function initializeAPIs() {
      console.log('Initializing Google APIs...');
      
      // First check if gapi is loaded
      if (typeof gapi === 'undefined') {
        console.error('Google API client library not loaded');
        displayMessage('Error: Google API client library failed to load. Please refresh the page.', 'error');
        return;
      }

      // Load the Google API client library
      gapi.load('client', {
        callback: function() {
          console.log('Google API client loaded, initializing...');
          
          // Initialize with the API key and client ID
          gapi.client.init({
            apiKey: '', // Not needed for OAuth flows
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
            clientId: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/calendar',
          }).then(function() {
            console.log('Google API client initialized successfully');
            gapiInited = true;
            maybeEnableButtons();
            
            // Check if we have a token in the URL (OAuth redirect)
            checkForAccessToken();
            
          }).catch(function(error) {
            const errorMsg = 'Failed to initialize Google API client: ' + error.message;
            console.error(errorMsg, error);
            displayMessage(errorMsg, 'error');
          });
        },
        onerror: function() {
          const errorMsg = 'Failed to load Google API client library. Check your internet connection.';
          console.error(errorMsg);
          displayMessage(errorMsg, 'error');
          
          // Try again after a delay
          setTimeout(initializeAPIs, 3000);
        },
        timeout: 10000, // 10 seconds
        ontimeout: function() {
          const errorMsg = 'Timeout loading Google API client library. Please check your connection.';
          console.error(errorMsg);
          displayMessage(errorMsg, 'error');
        }
      });
    }
    
    async function gapiLoaded() {
      try {
        console.log('Loading Google API client...');
        await new Promise((resolve, reject) => {
          gapi.load('client', {
            callback: resolve,
            onerror: reject
          });
        });
        await initializeGapi();
      } catch (error) {
        console.error('Failed to load Google API:', error);
        alert('Failed to load Google API: ' + error.message);
      }
    }
    
    async function initializeGapi() {
      try {
        console.log('Initializing Google API client...');
        await gapi.client.init({
          discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        console.log('Google API client initialized successfully');
        maybeEnableButtons();
      } catch (error) {
        console.error('Failed to initialize Google API:', error);
        alert('Failed to initialize Google API: ' + error.message);
      }
    }
    
    // Global variables for buttons
    let signOutBtn;
    
    function gisLoaded() {
      try {
        console.log('Initializing Google Identity Services...');
        
        // First, make sure google.accounts is available
        if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
          const errorMsg = 'Google Identity Services not loaded. Make sure you have included the Google Identity Services script.';
          console.error(errorMsg);
          displayMessage(errorMsg, 'error');
          
          // Try again in 1 second if we haven't tried too many times
          if (typeof gisLoaded.retryCount === 'undefined') {
            gisLoaded.retryCount = 0;
          }
          
          if (gisLoaded.retryCount < 3) {
            gisLoaded.retryCount++;
            console.log(`Retrying Google Identity Services initialization (${gisLoaded.retryCount}/3)...`);
            setTimeout(gisLoaded, 1000);
          } else {
            displayMessage('Failed to load Google Identity Services after multiple attempts. Please refresh the page.', 'error');
          }
          return;
        }
        
        console.log('Google Identity Services loaded, initializing token client...');
        
        // Initialize the token client
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/calendar',
          prompt: 'consent',
          callback: (response) => {
            try {
              if (response && response.access_token) {
                accessToken = response.access_token;
                console.log('Access token received');
                
                // Set the token for gapi client if it's loaded
                if (gapi.client) {
                  gapi.client.setToken({
                    access_token: accessToken,
                    expires_in: response.expires_in || 3600,
                    token_type: 'Bearer'
                  });
                } else {
                  console.warn('gapi.client not available yet');
                }
                
                // Handle the successful authentication
                handleAuthSuccess();
              } else if (response && response.error) {
                const errorMsg = 'OAuth error: ' + (response.error_description || response.error);
                console.error(errorMsg);
                displayMessage(errorMsg, 'error');
              } else {
                console.error('Unexpected OAuth response:', response);
                displayMessage('Unexpected authentication response', 'error');
              }
            } catch (error) {
              console.error('Error in OAuth callback:', error);
              displayMessage('Error processing authentication response', 'error');
            }
          },
          error_callback: (error) => {
            try {
              if (error.error === 'popup_closed') {
                console.log('User closed the OAuth popup');
                return;
              }
              
              let errorMsg = 'Authentication error: ';
              if (error.error) {
                errorMsg += error.error;
                if (error.error_description) {
                  errorMsg += ' - ' + error.error_description;
                }
              } else {
                errorMsg += JSON.stringify(error);
              }
              
              console.error('OAuth error:', error);
              displayMessage(errorMsg, 'error');
              
              // Reset auth state on error
              tokenClient = null;
              gisInited = false;
              
            } catch (e) {
              console.error('Error in OAuth error callback:', e);
            }
          }
        });
        
        gisInited = true;
        console.log('Google Identity Services initialized successfully');
        maybeEnableButtons();
        
      } catch (error) {
        console.error('Failed to initialize Google Identity Services:', error);
        displayMessage('Failed to initialize authentication service: ' + (error.message || 'Unknown error'), 'error');
        
        // Try again after a delay with exponential backoff
        const retryDelay = Math.min(1000 * Math.pow(2, gisLoadRetryCount || 0), 10000);
        gisLoadRetryCount = (gisLoadRetryCount || 0) + 1;
        console.log(`Retrying Google Identity Services initialization in ${retryDelay}ms...`);
        
        setTimeout(gisLoaded, retryDelay);
      }
    }
    
    function handleAuthClick() {
      console.log('handleAuthClick called');
      
      // Show loading state
      const authButton = document.getElementById('authorize_button');
      const originalButtonText = authButton.innerHTML;
      authButton.disabled = true;
      authButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
      
      // Check if tokenClient is initialized
      if (!tokenClient) {
        console.error('Token client not initialized. Attempting to reinitialize...');
        // Try to reinitialize
        gisLoaded();
        
        // Show error to user
        displayMessage('Authentication service is initializing. Please try again in a moment.', 'warning');
        
        // Reset button state after a delay
        setTimeout(() => {
          authButton.disabled = false;
          authButton.innerHTML = originalButtonText;
        }, 2000);
        return;
      }
      
      try {
        console.log('Requesting access token...');
        
        // Check if we already have a token
        const hasToken = gapi.client && gapi.client.getToken() !== null;
        
        // Request token with appropriate prompt
        const options = hasToken ? { prompt: '' } : { prompt: 'consent' };
        console.log(`Requesting token with options:`, options);
        
        // Show a message to the user
        displayMessage('Opening Google sign-in...', 'info');
        
        // Request the token
        tokenClient.requestAccessToken(options);
        
        // Set a timeout to handle cases where the popup might be blocked
        const popupTimeout = setTimeout(() => {
          if (!gapi.client || !gapi.client.getToken()) {
            console.warn('Popup might be blocked. Please check your browser settings.');
            displayMessage('Popup blocked or taking too long. Please check your browser settings and try again.', 'warning');
            
            // Reset button state
            authButton.disabled = false;
            authButton.innerHTML = originalButtonText;
          }
        }, 10000); // 10 seconds timeout
        
        // Store the timeout ID to clear it if authentication succeeds
        window.authPopupTimeout = popupTimeout;
        
      } catch (error) {
        console.error('Error during authentication:', error);
        
        let errorMessage = 'Authentication error: ';
        if (error.error) {
          errorMessage += error.error;
          if (error.error_description) {
            errorMessage += ' - ' + error.error_description;
          }
        } else {
          errorMessage += error.message || 'Unknown error';
        }
        
        displayMessage(errorMessage, 'error');
        
        // Reset button state
        authButton.disabled = false;
        authButton.innerHTML = originalButtonText;
      }
    }
    
    // After successful login
    async function handleAuthSuccess() {
      try {
        console.log('handleAuthSuccess called');
        
        // Clear the popup timeout if it exists
        if (window.authPopupTimeout) {
          clearTimeout(window.authPopupTimeout);
          delete window.authPopupTimeout;
        }
        
        // Update UI to show authentication success
        const authButton = document.getElementById('authorize_button');
        if (authButton) {
          authButton.disabled = false;
          authButton.innerHTML = '<i class="fas fa-check"></i> Connected';
          authButton.style.backgroundColor = '#10b981'; // Green color for success
        }
        
        // Make sure gapi client is initialized with the token
        if (gapi.client && accessToken) {
          gapi.client.setToken({ 
            access_token: accessToken,
            token_type: 'Bearer',
            expires_in: 3600 // Default expiration time in seconds
          });
          
          console.log('Google API client token set successfully');
          
          // Show success message
          displayMessage('Successfully connected to Google Calendar!', 'success');
          
          // Update UI to show authenticated state
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('appLayout').style.display = 'flex';
          
          // Load user profile
          try {
            await loadUserProfile();
          } catch (profileError) {
            console.warn('Failed to load user profile:', profileError);
            // Continue even if profile loading fails
          }
          
          // Initialize Calendar API if not already done
          if (!gapi.client.calendar) {
            console.log('Initializing Calendar API...');
            await gapi.client.load('calendar', 'v3');
            console.log('Calendar API initialized');
          }
        }
        
        // Show app layout and hide login
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('appLayout').style.display = 'flex';
        
        // Load user profile and get display name
        const displayName = await loadUserProfile();
        
        // Initialize navigation
        setupNavigation();
        
        // Show welcome page by default
        document.getElementById('welcomePage').style.display = 'block';
        document.getElementById('chatPage').style.display = 'none';
        document.getElementById('inputContainer').style.display = 'none';
        
        // Update welcome message with user's name
        document.getElementById('welcomeName').textContent = displayName || 'User';
        
        // Show and enable input container for chat
        const inputContainer = document.getElementById('inputContainer');
        const inputBox = document.getElementById('inputBox');
        const voiceButton = document.getElementById('voiceButton');
        
        if (inputContainer) inputContainer.style.display = 'flex';
        if (inputBox) {
            inputBox.disabled = false;
            setTimeout(() => inputBox.focus(), 100);
        }
        if (voiceButton) voiceButton.disabled = false;
        
        console.log('Authentication successful, welcome page shown for', displayName);
      } catch (error) {
        console.error('Error in handleAuthSuccess:', error);
        alert('Error during authentication: ' + error.message);
      }
    }
    
    function handleSignoutClick() {
      console.log('handleSignoutClick called');
      
      // Get the sign out button and show loading state
      const signOutBtn = document.getElementById('signout_button');
      const originalButtonText = signOutBtn ? signOutBtn.innerHTML : '';
      if (signOutBtn) {
        signOutBtn.disabled = true;
        signOutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing out...';
      }
      
      // Show a message to the user
      displayMessage('Signing out...', 'info');
      
      try {
        // Clear any pending timeouts
        if (window.authPopupTimeout) {
          clearTimeout(window.authPopupTimeout);
          delete window.authPopupTimeout;
        }
        
        // Clear the access token from Google API client
        if (gapi.client) {
          const token = gapi.client.getToken();
          if (token && token.access_token) {
            // Try to revoke the token
            if (google && google.accounts && google.accounts.oauth2) {
              try {
                google.accounts.oauth2.revoke(token.access_token, () => {
                  console.log('Access token revoked');
                });
              } catch (revokeError) {
                console.warn('Error revoking token:', revokeError);
                // Continue with sign out even if revoke fails
              }
            }
            gapi.client.setToken(null);
            console.log('Cleared gapi client token');
          }
        }
        
        // Clear the access token
        accessToken = null;
        
        // Clear any stored tokens or user data
        localStorage.removeItem('google_auth_token');
        sessionStorage.clear();
        
        // Update UI to show logged out state
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('appLayout').style.display = 'none';
        
        // Reset the sign in button
        const authButton = document.getElementById('authorize_button');
        if (authButton) {
          authButton.disabled = false;
          authButton.style.display = 'inline-block';
          authButton.innerHTML = '<i class="fab fa-google"></i> Sign in with Google';
          authButton.style.backgroundColor = ''; // Reset any custom styles
        }
        
        // Hide and disable input container
        const inputContainer = document.getElementById('inputContainer');
        const inputBox = document.getElementById('inputBox');
        const voiceButton = document.getElementById('voiceButton');
        
        if (inputContainer) inputContainer.style.display = 'none';
        if (inputBox) inputBox.disabled = true;
        if (voiceButton) voiceButton.disabled = true;
        
        // Show success message
        displayMessage('You have been successfully signed out.', 'success');
        
        console.log('Successfully signed out');
        
      } catch (error) {
        console.error('Error signing out:', error);
        
        let errorMessage = 'Error signing out: ';
        if (error.error) {
          errorMessage += error.error;
          if (error.error_description) {
            errorMessage += ' - ' + error.error_description;
          }
        } else {
          errorMessage += error.message || 'Unknown error';
        }
        
        displayMessage(errorMessage, 'error');
      } finally {
        // Always reset the sign out button
        if (signOutBtn) {
          signOutBtn.disabled = false;
          signOutBtn.innerHTML = originalButtonText || '<i class="fas fa-sign-out-alt"></i> Sign out';
          signOutBtn.style.display = 'none';
        }
      }
      
      // Re-initialize the Google Identity Services for next sign-in
      setTimeout(() => {
        gisLoaded();
      }, 1000);
    }

    // Demo mode - bypass OAuth for now
    function testButtonClick() {
      console.log('Button clicked!');
      
      // For now, let's enable demo mode so you can see the app working
      const enableDemo = confirm('OAuth setup is complex. Would you like to try DEMO MODE instead?\n\nDemo mode lets you test all features without Google Calendar integration.');
      
      if (enableDemo) {
        // Enable demo mode
        accessToken = 'demo-token';
        
        // Update UI to show connected state
        document.getElementById('authorize_button').style.display = 'none';
        document.getElementById('signout_button').style.display = 'inline-block';
        document.getElementById('inputBox').disabled = false;
        document.getElementById('voiceButton').disabled = false;
        
        const msg = document.getElementById('message');
        msg.innerHTML = '<strong> Assistant:</strong><br> <strong>DEMO MODE ACTIVE!</strong><br>You can now test all Smart Scheduler features! Events won\'t be saved to Google Calendar, but you can see how everything works.<br><br>Try saying: "Schedule lunch with mom tomorrow at 1pm"';
        
        return;
      }
      
      // If they want real OAuth, show instructions
      alert('For real Google Calendar integration, you need to:\n\n1. Go to console.cloud.google.com\n2. APIs & Services  Credentials\n3. Edit your OAuth client\n4. Add these URLs:\n   - JavaScript origins: https://smart-scheduler-app.windsurf.build\n   - Redirect URIs: https://smart-scheduler-app.windsurf.build\n\nThen wait 2-3 minutes and try again.');
    }
    
    // Check for access token in URL
    function checkForAccessToken() {
      const hash = window.location.hash;
      if (hash.includes('access_token=')) {
        const params = new URLSearchParams(hash.substring(1));
        const token = params.get('access_token');
        if (token) {
          accessToken = token;
          console.log('Got access token:', token.substring(0, 20) + '...');
          
          // Update UI
          document.getElementById('authorize_button').style.display = 'none';
          document.getElementById('signout_button').style.display = 'inline-block';
          document.getElementById('inputBox').disabled = false;
          document.getElementById('voiceButton').disabled = false;
          
          const msg = document.getElementById('message');
          msg.innerHTML = '<strong> Assistant:</strong><br>Perfect! I\'m now connected to your Google Calendar. What would you like to schedule?';
          
          // Clear the hash
          window.location.hash = '';
        }
      }
    }

    // Initialize APIs with retry mechanism
    function initializeAPIs() {
      console.log('Page loaded, initializing APIs...');
      
      // Check if Google APIs are available
      if (typeof gapi === 'undefined') {
        console.log('Google API not available yet, retrying in 1 second...');
        setTimeout(initializeAPIs, 1000);
        return;
      }
      
      if (typeof google === 'undefined') {
        console.log('Google Identity Services not available yet, retrying in 1 second...');
        setTimeout(initializeAPIs, 1000);
        return;
      }
      
      // Both APIs are available, initialize them
      gapiLoaded();
      gisLoaded();
    }

    function initializeUI() {
      try {
        console.log('Initializing UI...');
        
        // Initialize UI elements with null checks
        authBtn = document.getElementById('authorize_button');
        inputBox = document.getElementById('inputBox');
        msg = document.getElementById('message');
        darkToggle = document.getElementById('darkToggle');
        voiceButton = document.getElementById('voiceButton');
        signOutBtn = document.getElementById('signout_button');
        
        // Set up auth button
        setupAuthButton();
        
        // Set up input box
        if (inputBox) {
          inputBox.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              const message = inputBox.value.trim();
              if (message) {
                sendToLLM(message);
                inputBox.value = '';
              }
            }
          });
        } else {
          console.warn('Input box not found');
        }
        
        // Set up voice button if it exists
        if (voiceButton) {
          setupVoiceRecognition();
          voiceButton.onclick = () => {
            if (recognition && inputBox && !inputBox.disabled) {
              recognition.start();
            }
          };
          console.log('Voice button initialized');
        } else {
          console.warn('Voice button not found in the DOM');
        }
        
        // Set up dark mode toggle if it exists
        if (darkToggle) {
          darkToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            // Save preference
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
          });
          
          // Load dark mode preference
          if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
          }
        } else {
          console.warn('Dark mode toggle not found');
        }
        
        // Set up sign out button if it exists
        if (signOutBtn) {
          signOutBtn.onclick = handleSignoutClick;
          console.log('Sign out button initialized');
        } else {
          console.warn('Sign out button not found');
        }
        
        console.log('UI initialization complete');
      } catch (error) {
        console.error('Error initializing UI:', error);
      }
    }
    
    // Input box event listener is already set up in initializeUI()
    // No need for duplicate code here
    
    // Initialize the app when the window loads
    window.onload = function() {
      try {
        // Initialize UI elements first
        initializeUI();
        
        // Check if we already have an access token from OAuth redirect
        checkForAccessToken();
        
        // Start initialization with a small delay to ensure scripts are loaded
        setTimeout(initializeAPIs, 500);
        
        // Set base date for the session
        baseDate = new Date();
        console.log('Session started with base date:', baseDate.toLocaleString());
        
        // Create floating particles
        createParticles();
        
        // Register PWA Service Worker
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        }
        
        // Initialize welcome page functionality
        const getStartedBtn = document.getElementById('getStartedBtn');
        if (getStartedBtn) {
          getStartedBtn.addEventListener('click', function() {
            const welcomeContainer = document.getElementById('welcomeContainer');
            const loginContainer = document.getElementById('loginContainer');
            if (welcomeContainer && loginContainer) {
              welcomeContainer.style.display = 'none';
              loginContainer.style.display = 'block';
            }
          });
        }
        
        // Add smooth scrolling to chat
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) {
          chatContainer.style.scrollBehavior = 'smooth';
        }
      } catch (error) {
        console.error('Error during app initialization:', error);
        displayMessage('An error occurred while initializing the app. Please refresh the page.', 'error');
      }
    };
</script>
</body>
</html>
