<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Smart Scheduler</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Smart Scheduler" />
    <!-- <link rel="apple-touch-icon" href="./icon-192.png" /> -->
    
    <!-- Mobile Optimizations -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    
    <!-- Google API Scripts - Loaded with proper error handling -->
    <script>
      // Global state
      let gapiInited = false;
      let gisInited = false;
      let tokenClient = null;
      let accessToken = null;
      
      // Configuration - Using environment variables would be better in production
      const API_KEY = 'AIzaSyBq1W8rv77mcFyZqYbsrEBJxYm6nvpdxcQ';
      const CLIENT_ID = '251900786787-rs2a373jkaetk9lmh49nch3tq5p3lnhp.apps.googleusercontent.com';
      const SCOPES = [
        'https://www.googleapis.com/auth/calendar',
        'https://www.googleapis.com/auth/calendar.events',
        'https://www.googleapis.com/auth/userinfo.profile',
        'https://www.googleapis.com/auth/userinfo.email',
        'https://www.googleapis.com/auth/contacts.readonly'  // For People API
      ].join(' ');
      
      // Function to initialize Google API client
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: [
            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
            'https://people.googleapis.com/$discovery/rest?version=v1'
          ]
        }).then(function() {
          gapiInited = true;
          console.log('Google API client initialized');
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        }).catch(function(error) {
          console.error('Error initializing Google API client:', error);
          showError('Failed to initialize Google services. Please refresh the page.');
        });
      }
      
      // Load the Google API client library and GIS
      function loadGoogleApi() {
        return new Promise((resolve, reject) => {
          // Load Google API client
          const gapiScript = document.createElement('script');
          gapiScript.src = 'https://apis.google.com/js/api.js';
          gapiScript.async = true;
          gapiScript.defer = true;
          
          // Load Google Identity Services
          const gisScript = document.createElement('script');
          gisScript.src = 'https://accounts.google.com/gsi/client';
          gisScript.async = true;
          gisScript.defer = true;
          
          let gapiLoaded = false;
          let gisLoaded = false;
          
          function checkAllLoaded() {
            if (gapiLoaded && gisLoaded) {
              console.log('Both Google API and GIS loaded');
              resolve();
            }
          }
          
          gapiScript.onload = function() {
            console.log('Google API client loaded');
            gapi.load('client:auth2', {
              callback: function() {
                gapiLoaded = true;
                initClient();
                checkAllLoaded();
              },
              onerror: function(error) {
                console.error('Error loading gapi client:', error);
                reject(error);
              },
              timeout: 10000,
              ontimeout: function() {
                console.error('Timeout loading gapi client');
                reject(new Error('Timeout loading Google API client'));
              }
            });
          };
          
          gapiScript.onerror = function() {
            console.error('Failed to load Google API client');
            reject(new Error('Failed to load Google API client'));
          };
          
          gisScript.onload = function() {
            console.log('Google Identity Services loaded');
            gisLoaded = true;
            checkAllLoaded();
          };
          
          gisScript.onerror = function() {
            console.error('Failed to load Google Identity Services');
            reject(new Error('Failed to load Google Identity Services'));
          };
          
          // Add both scripts to the page
          document.head.appendChild(gapiScript);
          document.head.appendChild(gisScript);
        });
      }
      
      // Update UI based on sign-in status
      function updateSigninStatus(isSignedIn) {
        const signinButton = document.getElementById('authorizeButton');
        if (signinButton) {
          signinButton.style.display = isSignedIn ? 'none' : 'flex';
        }
        if (isSignedIn) {
          handleAuthSuccess();
        }
      }
      
      // Handle successful authentication
      async function handleAuthSuccess() {
        console.log('Authentication successful');
        try {
          // Load user profile
          await loadUserProfile();
          
          // Show main app UI
          const loginContainer = document.getElementById('loginContainer');
          const appLayout = document.getElementById('appLayout');
          if (loginContainer) loginContainer.style.display = 'none';
          if (appLayout) appLayout.style.display = 'flex';
          
          // Initialize other components
          setupNavigation();
          setupTabs();
          
          console.log('App initialized successfully');
        } catch (error) {
          console.error('Error initializing app:', error);
          showError('Error initializing the application. Please try again.');
        }
      }
      
      // Initialize Google Sign-In when the page loads
      document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM fully loaded');
        
        try {
          // Set up sign-in button first so it's ready when scripts load
          const signInButton = document.getElementById('authorizeButton');
          if (signInButton) {
            signInButton.onclick = handleAuthClick;
            signInButton.disabled = true; // Disable until scripts are loaded
            signInButton.innerHTML = 'Loading Google services...';
          }
          
          // Load Google API and GIS
          await loadGoogleApi();
          
          // Enable sign-in button once everything is loaded
          if (signInButton) {
            signInButton.disabled = false;
            signInButton.innerHTML = 'Continue with Google';
          }
          
          console.log('Google services initialized successfully');
        } catch (error) {
          console.error('Error initializing Google services:', error);
          showError('Failed to load Google services. Please refresh the page.');
          
          const signInButton = document.getElementById('authorizeButton');
          if (signInButton) {
            signInButton.disabled = false;
            signInButton.innerHTML = 'Error - Click to Retry';
          }
        }
      });
      
      // Initialize Google APIs
      function initializeGoogleAPIs() {
        console.log('Initializing Google APIs...');
        
        // Check if Google API is loaded
        if (typeof google === 'undefined' || !google.accounts) {
          console.error('Google API not loaded');
          showError('Google authentication services failed to load. Please refresh the page.');
          return;
        }
        
        // Initialize Google Identity Services
        try {
          // Create token client
          window.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (response) => {
              if (response.error) {
                console.error('OAuth error:', response.error);
                showError('Failed to sign in. Please try again.');
                return;
              }
              accessToken = response.access_token;
              handleAuthSuccess();
            },
            error_callback: (error) => {
              console.error('OAuth error callback:', error);
              showError('Authentication error. Please try again.');
            }
          });
          
          // Enable sign-in button
          enableSignInButton();
          
          console.log('Google APIs initialized');
          
        } catch (error) {
          console.error('Failed to initialize Google APIs:', error);
          showError('Failed to initialize authentication. Please refresh the page.');
        }
      }
      
      // Check if both scripts are loaded
      function checkInitialization() {
        if (window.gapi && window.gapi.load && window.google && window.google.accounts) {
          initializeGoogleAPIs();
        } else {
          setTimeout(checkInitialization, 100);
        }
      }
      
      // Load Google API scripts
      function loadGoogleScripts() {
        console.log('Loading Google API scripts...');
        
        // Load Google Identity Services first (required for OAuth)
        const gisScript = document.createElement('script');
        gisScript.src = 'https://accounts.google.com/gsi/client';
        gisScript.async = true;
        gisScript.defer = true;
        
        gisScript.onload = function() {
          console.log('Google Identity Services loaded');
          
          // Now load the Google API client
          const gapiScript = document.createElement('script');
          gapiScript.src = 'https://apis.google.com/js/api.js';
          gapiScript.async = true;
          gapiScript.defer = true;
          
          gapiScript.onload = function() {
            console.log('Google API client loaded');
            // Initialize Google APIs
            initializeGoogleAPIs();
          };
          
          gapiScript.onerror = function() {
            console.error('Failed to load Google API client');
            showError('Failed to load required Google services. Please refresh the page.');
          };
          
          document.head.appendChild(gapiScript);
        };
        
        gisScript.onerror = function() {
          console.error('Failed to load Google Identity Services');
          showError('Failed to load authentication services. Please check your internet connection and refresh the page.');
        };
        
        document.head.appendChild(gisScript);
      }
      
      // Initialize Google API Client
      function initializeGAPI() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(() => {
          console.log('Google API client initialized');
          window.gapiInited = true;
          maybeEnableButtons();
        }).catch(error => {
          console.error('Error initializing Google API client:', error);
          showError('Error initializing Google services: ' + error.message);
        });
      }
      
      // Initialize Google Identity Services
      function initializeGIS() {
        try {
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (response) => {
              if (response.error) {
                console.error('OAuth error:', response.error);
                showError('Authentication error: ' + response.error);
                return;
              }
              accessToken = response.access_token;
              if (gapi.client) {
                gapi.client.setToken({ access_token: accessToken });
              }
              handleAuthSuccess();
            },
            error_callback: (error) => {
              console.error('OAuth error callback:', error);
              showError('Authentication error: ' + (error.message || 'Unknown error'));
            }
          });
          console.log('Google Identity Services initialized');
          window.gisInited = true;
          maybeEnableButtons();
        } catch (error) {
          console.error('Error initializing Google Identity Services:', error);
          showError('Error initializing authentication: ' + error.message);
        }
      }
      
      // Initialize Google API client
      function initializeGAPI() {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function() {
          console.log('Google API client initialized');
          gapiInited = true;
          maybeEnableButtons();
        }).catch(function(error) {
          console.error('Error initializing Google API client:', error);
          showError('Error initializing Google services: ' + error.message);
        });
      }
      
      // Initialize Google Identity Services
      function initializeGIS() {
        try {
          if (typeof google === 'undefined' || !google.accounts) {
            console.error('Google Identity Services not loaded');
            return;
          }
          
          console.log('Initializing Google Identity Services...');
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: function(response) {
              if (response.error) {
                console.error('OAuth error:', response.error);
                showError('Authentication error: ' + response.error);
                return;
              }
              
              console.log('OAuth token received');
              accessToken = response.access_token;
              
              // Set the token for gapi client
              if (gapi.client) {
                gapi.client.setToken({ access_token: accessToken });
              }
              
              // Handle successful authentication
              handleAuthSuccess();
            },
            error_callback: function(error) {
              console.error('OAuth error callback:', error);
              showError('Authentication error: ' + (error.message || 'Unknown error'));
            }
          });
          
          gisInited = true;
          console.log('Google Identity Services initialized');
          maybeEnableButtons();
          
        } catch (error) {
          console.error('Error initializing Google Identity Services:', error);
          showError('Error initializing authentication: ' + error.message);
        }
      }
      
      // Show error message to user
      function showError(message) {
        console.error('Error:', message);
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) {
          // Remove any existing error messages
          const existingErrors = loginContainer.querySelectorAll('.error-message');
          existingErrors.forEach(el => el.remove());
          
          const errorMessage = document.createElement('div');
          errorMessage.className = 'error-message';
          errorMessage.style.cssText = 'color: #ff4444; margin: 20px 0; padding: 15px; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336;';
          errorMessage.innerHTML = `
            <strong>Error:</strong> ${message}
            <div style="margin-top: 10px; font-size: 0.9em;">
              <button onclick="location.reload()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                Refresh Page
              </button>
            </div>
          `;
          
          loginContainer.insertBefore(errorMessage, loginContainer.firstChild);
          
          // Scroll to the error message
          setTimeout(() => {
            errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        } else {
          alert(message);
        }
      }
      
      // Enable sign-in button
      function enableSignInButton() {
        const authButton = document.getElementById('authorize_button');
        if (authButton) {
          authButton.onclick = handleAuthClick;
          authButton.disabled = false;
          authButton.textContent = 'Sign in with Google';
          console.log('Sign-in button enabled');
        }
      }
      
      // Handle sign-in button click
      function handleAuthClick(event) {
        if (event) event.preventDefault();
        
        const authButton = document.getElementById('authorizeButton');
        if (!authButton) {
          console.error('Sign-in button not found');
          showError('Sign-in button not found. Please refresh the page.');
          return false;
        }
        
        // Show loading state
        const originalText = authButton.innerHTML;
        authButton.disabled = true;
        authButton.innerHTML = '<span class="spinner"></span> Signing in...';
        
        // Check if Google API is loaded
        if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
          console.error('Google API not properly loaded');
          showError('Google authentication services not available. Please refresh the page.');
          authButton.disabled = false;
          authButton.innerHTML = originalText;
          return false;
        }
        
        // Initialize token client if not already done
        if (!window.tokenClient) {
          try {
            window.tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID,
              scope: SCOPES,
              callback: (response) => {
                if (response.error) {
                  console.error('OAuth error:', response.error);
                  showError('Failed to sign in. Please try again.');
                  const btn = document.getElementById('authorizeButton');
                  if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Continue with Google';
                  }
                  return;
                }
                // Success - store the token and proceed
                accessToken = response.access_token;
                console.log('OAuth token received');
                handleAuthSuccess();
              },
              error_callback: (error) => {
                console.error('OAuth error callback:', error);
                showError('Authentication error. Please try again.');
                const btn = document.getElementById('authorizeButton');
                if (btn) {
                  btn.disabled = false;
                  btn.innerHTML = 'Continue with Google';
                }
              }
            });
          } catch (error) {
            console.error('Error initializing token client:', error);
            showError('Failed to initialize authentication. Please refresh the page.');
            const btn = document.getElementById('authorizeButton');
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = 'Continue with Google';
            }
            return false;
          }
        }
        
        // Request token
        try {
          console.log('Requesting access token...');
          window.tokenClient.requestAccessToken();
        } catch (error) {
          console.error('Error requesting token:', error);
          showError('Failed to start sign in. Please try again.');
          const btn = document.getElementById('authorizeButton');
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'Continue with Google';
          }
        }
        
        return false;
      }

      // Handle successful authentication
      function handleAuthSuccess() {
        console.log('Authentication successful');
        
        // Hide login container and show app layout
        const loginContainer = document.getElementById('loginContainer');
        const appLayout = document.getElementById('appLayout');
        const inputContainer = document.getElementById('inputContainer');
        
        if (loginContainer) loginContainer.style.display = 'none';
        if (appLayout) appLayout.style.display = 'block';
        if (inputContainer) inputContainer.style.display = 'flex';
        
        // Load user profile
        loadUserProfile();
        
        // Initialize the rest of the app
        initializeApp();
      }

      // Initialize the rest of the app after authentication
      function initializeApp() {
        setupNavigation();
        setupTabs();
        initializeDashboard();
        createParticles();
      }

      // Handle sign out
      function handleSignout() {
        console.log('Signing out...');
        
        // Clear any stored tokens
        if (window.gapi && gapi.auth2) {
          const auth2 = gapi.auth2.getAuthInstance();
          if (auth2) {
            auth2.signOut().then(() => {
              console.log('User signed out from Google');
            });
          }
        }
        
        // Clear local state
        accessToken = null;
        gapiInited = false;
        gisInited = false;
        
        // Reset UI
        const loginContainer = document.getElementById('loginContainer');
        const appLayout = document.getElementById('appLayout');
        
        if (loginContainer) loginContainer.style.display = 'flex';
        if (appLayout) appLayout.style.display = 'none';
        
        // Clear any stored data
        localStorage.removeItem('access_token');
        localStorage.removeItem('user_profile');
        
        console.log('Sign out complete');
      }

      // Load user profile information
      function loadUserProfile() {
        if (!gapi.client) {
          console.error('Google API client not initialized');
          return;
        }
        
        // Try to get user info from Google People API
        gapi.client.people.people.get({
          resourceName: 'people/me',
          personFields: 'names,emailAddresses,photos'
        }).then(function(response) {
          const profile = response.result;
          console.log('User profile:', profile);
          
          // Update UI with user info
          const name = profile.names?.[0]?.displayName || 'User';
          const email = profile.emailAddresses?.[0]?.value || '';
          const photoUrl = profile.photos?.[0]?.url || '';
          
          updateUserProfileUI(name, photoUrl);
          
        }).catch(function(error) {
          console.error('Error loading user profile:', error);
          // Fallback to basic user info
          gapi.client.oauth2.userinfo.get().then(function(response) {
            const profile = response.result;
            updateUserProfileUI(profile.name, profile.picture);
          }).catch(function() {
            // If all else fails, just show a generic welcome
            updateUserProfileUI('User', '');
          });
        });
      }

      // Update the UI with user profile information
      function updateUserProfileUI(name, photoUrl) {
        const welcomeName = document.getElementById('welcomeName');
        const userAvatar = document.getElementById('userAvatar');
        
        if (welcomeName) welcomeName.textContent = name;
        
        if (userAvatar) {
          userAvatar.innerHTML = '';
          userAvatar.style.display = 'flex';
          
          if (photoUrl) {
            const img = document.createElement('img');
            img.src = photoUrl;
            img.alt = name;
            img.onload = () => userAvatar.classList.add('visible');
            userAvatar.appendChild(img);
          } else {
            // Fallback to initials
            const initials = name.split(' ')
              .map(part => part[0])
              .join('')
              .toUpperCase()
              .substring(0, 2);
              
            // Clear any previous error messages
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(el => el.remove());
            
              try {
                if (!tokenClient) {
                  throw new Error('Google Sign-In is not ready. Please refresh the page and try again.');
                }
                
                console.log('Requesting access token with scopes:', SCOPES);
                
                // Request the token
                tokenClient.requestAccessToken();
                
              } catch (error) {
                console.error('Sign-in error:', error);
                showError('Error during sign-in: ' + (error.message || 'Unknown error'));
                
                // Reset button state
                if (authButton) {
                  authButton.innerHTML = originalText;
                  authButton.disabled = false;
                }
              }
              
              return false;
            }
      
      // Handle successful authentication
      function handleAuthSuccess() {
        console.log('Authentication successful');
        
        // Hide login container and show app layout
        const loginContainer = document.getElementById('loginContainer');
        const appLayout = document.getElementById('appLayout');
        const inputContainer = document.getElementById('inputContainer');
        
        if (loginContainer) loginContainer.style.display = 'none';
        if (appLayout) appLayout.style.display = 'block';
        if (inputContainer) inputContainer.style.display = 'flex';
        
        // Load user profile
        loadUserProfile();
        
        // Initialize the rest of the app
        initializeApp();
      }
      
      // Initialize the rest of the app after authentication
      function initializeApp() {
        setupNavigation();
        setupTabs();
        initializeDashboard();
        createParticles();
      }
      
      // Handle sign out
      function handleSignout() {
        console.log('Signing out...');
        
        // Clear any stored tokens
        if (window.gapi && gapi.auth2) {
          const auth2 = gapi.auth2.getAuthInstance();
          if (auth2) {
            auth2.signOut().then(() => {
              console.log('User signed out from Google');
            });
          }
        }
        
        // Clear local state
        accessToken = null;
        gapiInited = false;
        gisInited = false;
        
        // Reset UI
        const loginContainer = document.getElementById('loginContainer');
        const appLayout = document.getElementById('appLayout');
        
        if (loginContainer) loginContainer.style.display = 'flex';
        if (appLayout) appLayout.style.display = 'none';
        
        // Clear any stored data
        localStorage.removeItem('access_token');
        localStorage.removeItem('user_profile');
        
        console.log('Sign out complete');
      }
      
      // Load user profile information
      async function loadUserProfile() {
        console.log('Loading user profile...');
        
        try {
          // Make sure gapi client is initialized
          if (!gapi.client) {
            throw new Error('Google API client not initialized');
          }
          
          // Get the user's profile information
          const response = await gapi.client.people.people.get({
            resourceName: 'people/me',
            personFields: 'names,emailAddresses,photos'
          });
          
          const profile = response.result;
          console.log('User profile loaded:', profile);
          
          // Update UI with user info
          const userName = profile.names ? profile.names[0].displayName : 'User';
          const email = profile.emailAddresses ? profile.emailAddresses[0].value : '';
          const photoUrl = profile.photos ? profile.photos[0].url : '';
          
          // Update UI elements
          updateUserProfileUI(userName, photoUrl, email);
          
          return profile;
          
        } catch (error) {
          console.error('Error loading user profile:', error);
          
          // Set default values
          updateUserProfileUI('User', null, '');
          
          // Only show error if it's not a network issue
          if (!navigator.onLine) {
            console.warn('Network is offline, using cached profile data');
          } else {
            showError('Could not load your profile information. Some features may be limited.');
          }
          
          throw error; // Re-throw to be handled by the caller
        }
      }
      
      // Update user profile UI elements
      function updateUserProfileUI(userName, photoUrl = null, email = '') {
        const userNameElements = document.querySelectorAll('.user-name');
        const userEmailElements = document.querySelectorAll('.user-email');
        const userAvatarElements = document.querySelectorAll('.user-avatar');
        const welcomeNameElements = document.querySelectorAll('#welcomeName');
        
        // Update welcome message with user's name
        welcomeNameElements.forEach(el => {
          if (el) el.textContent = userName;
        });
        
        // Update user info in the sidebar
        userNameElements.forEach(el => el.textContent = userName);
        userEmailElements.forEach(el => el.textContent = email);
        
        // Update avatar
        if (photoUrl) {
          userAvatarElements.forEach(el => {
            el.innerHTML = `<img src="${photoUrl}" alt="${userName}" onerror="this.onerror=null; this.textContent='${userName.substring(0, 2).toUpperCase()}';">`;
          });
        } else {
          // Fallback to initials
          const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
          userAvatarElements.forEach(el => {
            el.textContent = initials;
            el.style.backgroundColor = getRandomColor();
          });
        }
        
        // Make sure the welcome message is visible
        const welcomeMessage = document.querySelector('.welcome-message');
        if (welcomeMessage) {
          welcomeMessage.style.display = 'block';
        }
      }
      
      // Helper function to generate a random color for avatar backgrounds
      function getRandomColor() {
        const colors = [
          '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD',
          '#D4A5A5', '#9B786F', '#E8C07D', '#9C914F', '#D4D4D4'
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }
        }
      }
      
      // Setup all event listeners in one place
      function setupEventListeners() {
        console.log('Setting up event listeners');
        
        // Sign-in button - use event delegation for dynamic elements
        document.addEventListener('click', function(event) {
          // Check if the clicked element or its parent is the authorize button
          if (event.target.closest('#authorize_button')) {
            console.log('Authorize button clicked');
            event.preventDefault();
            handleAuthClick(event);
            return false;
          }
          // Check if the clicked element or its parent is the sign-out button
          else if (event.target.closest('#signout_button') || event.target.closest('#signOutBtn')) {
            console.log('Sign out button clicked');
            event.preventDefault();
            handleSignout(event);
            return false;
          }
          // Check if the clicked element or its parent is the voice button
          else if (event.target.closest('.voice-btn')) {
            console.log('Voice button clicked');
            event.preventDefault();
            toggleVoiceRecognition(event);
            return false;
          }
        });
        
        // Also set up direct event listeners as a fallback
        const authButton = document.getElementById('authorize_button');
        if (authButton) {
          authButton.onclick = function(event) {
            event.preventDefault();
            handleAuthClick(event);
            return false;
          };
          console.log('Direct auth button listener set');
        }
      }
      
      // Start loading Google scripts when the page loads
      document.addEventListener('DOMContentLoaded', async function() {
        console.log('DOM fully loaded');
        
        try {
          // Load Google API scripts
          console.log('Loading Google API scripts...');
          await new Promise((resolve) => {
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            script.onload = resolve;
            script.onerror = () => {
              console.error('Failed to load Google Identity Services');
              showError('Failed to load authentication service. Please refresh the page.');
            };
            document.head.appendChild(script);
          });
          
          // Load Google API client
          await new Promise((resolve) => {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.async = true;
            script.defer = true;
            script.onload = () => {
              gapi.load('client', resolve);
            };
            script.onerror = () => {
              console.error('Failed to load Google API client');
              showError('Failed to load Google services. Please refresh the page.');
            };
            document.head.appendChild(script);
          });
          
          console.log('Initializing Google APIs...');
          await initializeGoogleAPIs();
          
          // Initialize other components
          setupNavigation();
          setupTabs();
          createParticles();
          
          console.log('App initialization complete');
        } catch (error) {
          console.error('Initialization error:', error);
          showError('Failed to initialize the application. Please refresh the page.');
        }
      });
      
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --danger: #ef4444;
            --light: #f9fafb;
            --dark: #111827;
            --gray: #6b7280;
            --light-gray: #e5e7eb;
            --border-radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.5;
            color: var(--dark);
            background-color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        header {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .user-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: rgba(79, 70, 229, 0.1);
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            gap: 2rem;
            padding: 2rem 0;
        }
        
        /* View Toggle */
        .view-toggle {
            display: flex;
            background: white;
            border-radius: var(--border-radius);
            padding: 0.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .view-toggle-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray);
            border-radius: calc(var(--border-radius) - 4px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .view-toggle-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /* Chat View */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: calc(100vh - 200px);
            min-height: 500px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            line-height: 1.5;
        }
        
        .message-user {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-assistant {
            align-self: flex-start;
            background: var(--light-gray);
            color: var(--dark);
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--light-gray);
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            min-height: 48px;
            max-height: 150px;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        
        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .send-btn:hover {
            background: var(--primary-dark);
        }
        
        .send-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }
        
        /* Preview View */
        .preview-container {
            display: none;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            height: calc(100vh - 200px);
            min-height: 500px;
            overflow-y: auto;
        }
        
        .preview-container.active {
            display: block;
        }
        
        .event-preview {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .event-preview h2 {
            margin-bottom: 1.5rem;
            color: var(--primary);
        }
        
        .event-details {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 500;
            color: var(--gray);
            width: 120px;
            flex-shrink: 0;
        }
        
        .detail-value {
            flex: 1;
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 1rem 0;
            }
            
            .chat-container,
            .preview-container {
                height: auto;
                min-height: 400px;
            }
        }
        
        :root {
          --primary: #6366f1;
          --primary-dark: #4f46e5;
          --secondary: #8b5cf6;
          --accent: #06b6d4;
          --success: #10b981;
          --warning: #f59e0b;
          --error: #ef4444;
          --dark: #0f172a;
          --dark-light: #1e293b;
          --gray: #64748b;
          --gray-light: #f1f5f9;
          --white: #ffffff;
          --glass: rgba(255, 255, 255, 0.1);
          --glass-dark: rgba(0, 0, 0, 0.2);
        }
        
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }
        
        body, html {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
          background-size: 400% 400%;
          animation: gradientShift 15s ease infinite;
          color: var(--white);
          overflow-x: hidden;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
        
        @keyframes gradientShift {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
#cornerText {
 position: fixed;
 top: 20px;
 left: 20px;
 background: rgba(255,255,255,0.7);
 padding: 10px 15px;
 font-weight: bold;
 border-radius: 6px;
}
        .main-container {
          background: var(--glass);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 24px;
          padding: 40px;
          max-width: 700px;
          width: 95%;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
          margin: auto;
          text-align: center;
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        /* User Avatar Styles */
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            color: white;
            overflow: hidden;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Animation for when avatar loads */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-avatar.visible {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* App Layout */
        .app-layout {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
          background-size: 400% 400%;
          animation: gradientShift 15s ease infinite;
        }
        
        .app-layout.active {
          display: flex;
        }
        
        .sidebar {
          width: 280px;
          background: var(--glass);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border-right: 1px solid rgba(255, 255, 255, 0.2);
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 24px;
        }
        
        .user-profile {
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 20px;
          background: var(--glass);
          backdrop-filter: blur(10px);
          border-radius: 16px;
          border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-avatar {
          width: 48px;
          height: 48px;
          border-radius: 50%;
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 600;
          font-size: 18px;
        }
        
        .user-info {
          flex: 1;
        }
        
        .user-name {
          font-weight: 600;
          color: var(--white);
          margin: 0 0 4px 0;
          font-size: 16px;
        }
        
        .user-email {
          font-size: 14px;
          color: rgba(255, 255, 255, 0.7);
          margin: 0;
        }
        
        .nav-tabs {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        
        .nav-tab {
          padding: 16px 20px;
          border-radius: 12px;
          background: transparent;
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: rgba(255, 255, 255, 0.7);
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 12px;
          font-size: 15px;
          font-weight: 500;
        }
        
        .nav-tab:hover {
          background: rgba(255, 255, 255, 0.1);
          color: var(--white);
          transform: translateX(4px);
        }
        
        .nav-tab.active {
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: var(--white);
          border-color: transparent;
          box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }
        
        .main-content {
          flex: 1;
          padding: 24px;
          overflow-y: auto;
        }
        
        .tab-content {
          display: none;
          height: 100%;
        }
        
        .tab-content.active {
          display: flex;
          flex-direction: column;
        }
        
        .content-header {
          margin-bottom: 24px;
        }
        
        .content-title {
          font-size: 2rem;
          font-weight: 700;
          color: var(--white);
          margin: 0 0 8px 0;
        }
        
        .content-subtitle {
          color: rgba(255, 255, 255, 0.7);
          margin: 0;
        }
        
        .main-container::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }
        
        .main-container:hover {
          transform: translateY(-2px);
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        .input-container {
          position: fixed;
          bottom: 32px;
          left: 50%;
          transform: translateX(-50%);
          width: 90%;
          max-width: 700px;
          display: flex;
          gap: 12px;
          align-items: center;
          z-index: 100;
        }
        
        .input-wrapper {
          flex: 1;
          position: relative;
        }
        
        .smart-input {
          width: 100%;
          padding: 18px 24px;
          border: none;
          border-radius: 50px;
          font-size: 16px;
          font-weight: 400;
          outline: none;
          background: var(--glass);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          color: var(--white);
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
          min-height: 56px;
          box-sizing: border-box;
        }
        
        .smart-input::placeholder {
          color: rgba(255, 255, 255, 0.7);
        }
        
        .smart-input:focus {
          transform: translateY(-2px);
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
          border-color: rgba(255, 255, 255, 0.4);
        }
        
        .action-button {
          padding: 18px 24px;
          font-size: 16px;
          font-weight: 600;
          border-radius: 50px;
          border: none;
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: var(--white);
          cursor: pointer;
          transition: all 0.3s ease;
          min-height: 56px;
          min-width: 120px;
          box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }
        
        .action-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 12px 40px rgba(99, 102, 241, 0.4);
        }
        
        .action-button:active {
          transform: translateY(0);
        }

        .voice-button {
          width: 56px;
          height: 56px;
          border-radius: 50%;
          border: none;
          background: linear-gradient(135deg, var(--success), var(--accent));
          color: var(--white);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          transition: all 0.3s ease;
          box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        }
        
        .voice-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 12px 40px rgba(16, 185, 129, 0.4);
        }
        
        .voice-button.recording {
          background: linear-gradient(135deg, var(--error), var(--warning));
          animation: pulse 2s infinite;
        }
        
        .chat-container {
          max-height: 60vh;
          overflow-y: auto;
          padding: 20px 0;
          scroll-behavior: smooth;
        }
        
        .message {
          margin: 16px 0;
          padding: 16px 20px;
          border-radius: 20px;
          max-width: 85%;
          word-wrap: break-word;
          animation: slideIn 0.3s ease;
        }
        
        .message.user {
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: var(--white);
          margin-left: auto;
          border-bottom-right-radius: 8px;
        }
        
        .message.assistant {
          background: var(--glass);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          color: var(--white);
          border-bottom-left-radius: 8px;
        }
        
        .typing-indicator {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 16px 20px;
          background: var(--glass);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          border-bottom-left-radius: 8px;
          max-width: 85%;
          margin: 16px 0;
        }
        
        .dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: rgba(255, 255, 255, 0.7);
          animation: typing 1.4s infinite;
        }
        
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
          0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
          30% { transform: translateY(-10px); opacity: 1; }
        }
        
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }
        
        .header {
          text-align: center;
          margin-bottom: 32px;
        }
        
        .logo-container {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 16px;
          margin-bottom: 16px;
        }
        
        .app-logo {
          width: 64px;
          height: 64px;
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
          transition: transform 0.3s ease;
        }
        
        .app-logo:hover {
          transform: scale(1.05);
        }
        
        .header h1 {
          font-size: 2.5rem;
          font-weight: 700;
          margin: 0;
          background: linear-gradient(135deg, var(--white), rgba(255, 255, 255, 0.8));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        
        .header p {
          font-size: 1.1rem;
          opacity: 0.9;
          font-weight: 400;
        }
        
        .feature-pills {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          justify-content: center;
          margin-top: 16px;
        }
        
        .pill {
          padding: 6px 12px;
          background: var(--glass);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          font-size: 0.85rem;
          color: rgba(255, 255, 255, 0.9);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
          .header h1 {
            font-size: 2rem;
          }
          
          .main-container {
            padding: 24px;
            margin: 0 16px;
          }
          
          .input-container {
            bottom: 16px;
            width: 95%;
            gap: 8px;
          }
          
          .smart-input {
            padding: 16px 20px;
            font-size: 16px;
          }
          
          .voice-button {
            width: 48px;
            height: 48px;
            font-size: 18px;
          }
          
          .action-button {
            padding: 16px 20px;
            min-width: 100px;
            font-size: 15px;
          }
        }
        
        @media (max-width: 480px) {
          .feature-pills {
            gap: 6px;
          }
          
          .pill {
            font-size: 0.8rem;
            padding: 4px 8px;
          }
          
          .header p {
            font-size: 1rem;
          }
        }
        
        /* Custom Scrollbar */
        .chat-container::-webkit-scrollbar {
          width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 3px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.3);
          border-radius: 3px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.5);
        }
        
        /* Dashboard Styles */
        .dashboard-container {
            padding: 2rem;
            color: white;
        }
        
        .welcome-message {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .action-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .action-card i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            color: var(--accent);
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .nav-tab {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        
        .nav-tab i {
            width: 24px;
            text-align: center;
        }
        
        .nav-tab:hover,
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-tab.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 500;
        }
        
        /* User Profile */
        .user-profile {
            margin-top: auto;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
        }
        
        .user-info {
            flex: 1;
            overflow: hidden;
        }
        
        .user-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-email {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Tab Content */
        /* Sidebar Navigation */
        .nav-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            margin: 0.5rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-button.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        
        .nav-button.sign-out {
            position: absolute;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .nav-button i {
            pointer-events: none;
        }
        
        /* Content Pages */
        .content-page {
            display: none;
            height: 100%;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .content-page.active {
            display: block;
        }
        
        /* Welcome Page Styles */
        .welcome-content {
          text-align: center;
          padding: 2rem;
          color: white;
        }
        
        .welcome-logo {
          width: 120px;
          height: 120px;
          margin-bottom: 1.5rem;
          animation: float 6s ease-in-out infinite;
        }
        
        .welcome-content h1 {
          font-size: 2.5rem;
          margin-bottom: 1rem;
          background: linear-gradient(45deg, #ff6b6b, #6b6bff);
          -webkit-background-clip: text;
          background-clip: text;
          -webkit-text-fill-color: transparent;
        }
        
        .welcome-content p {
          font-size: 1.2rem;
          margin-bottom: 2rem;
          color: #e0e0e0;
        }
        
        .welcome-buttons {
          display: flex;
          gap: 1rem;
          justify-content: center;
          margin-top: 2rem;
        }
        
        @keyframes float {
          0% { transform: translateY(0px); }
          50% { transform: translateY(-15px); }
          100% { transform: translateY(0px); }
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 420px;
            padding: 40px;
            text-align: center;
            transform: translateY(0);
            opacity: 1;
            transition: all 0.4s ease;
        }
        
        .login-header {
            margin-bottom: 32px;
        }
        
        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
            color: #6366f1;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .login-logo i {
            font-size: 2rem;
        }
        
        .login-card h1 {
            color: #1e293b;
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .login-card p {
            color: #64748b;
            font-size: 1rem;
            margin-bottom: 0;
        }
        
        .login-buttons {
            margin-bottom: 24px;
        }
        
        .login-buttons .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 12px 24px;
            background: #ffffff;
            color: #1a1a1a;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .login-buttons .google-signin-btn.test-mode {
            background: #f5f5f5;
            margin-top: 12px;
        }
        
        .signout-btn {
            background: none;
            border: none;
            color: #9e9e9e;
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .signout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        
        .google-signin-btn:hover {
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .google-signin-btn:active {
            transform: translateY(0);
        }
        
        .google-signin-btn img {
            width: 20px;
            height: 20px;
        }
        
        .login-footer {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #f1f5f9;
        }
        
        .login-footer p {
            font-size: 0.75rem;
            color: #94a3b8;
            line-height: 1.5;
        }
        
        /* Welcome Preview Styles */
        .welcome-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            text-align: center;
            padding: 2rem;
        }
        
        .welcome-content {
            max-width: 500px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .welcome-logo {
            margin-bottom: 2rem;
        }
        
        .welcome-logo i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: white;
        }
        
        .welcome-logo h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .welcome-tagline {
            font-size: 1.25rem;
            margin-bottom: 2.5rem;
            opacity: 0.9;
        }
        
        /* Updated Welcome Message Styles */
        .welcome-message {
            text-align: center;
            margin-top: 5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .welcome-message h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #1e293b;
        }
        
        .welcome-subtitle {
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 2.5rem;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 3rem;
        }
        
        .quick-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }
        
        /* Sidebar Navigation */
        .nav-footer {
            margin-top: auto;
            padding: 1rem 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sign-out {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            justify-content: flex-start;
            padding: 0.75rem 1rem;
        }
        
        .sign-out span {
            display: inline-block;
            margin-left: 0.5rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* View Toggle */
        .view-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .view-toggle-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #94a3b8;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .view-toggle-btn.active {
            background: #6366f1;
            color: white;
        }
        
        .view-toggle-btn i {
            font-size: 1rem;
        }
        
        /* Chat Messages */
        .chat-messages {
            height: 100%;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .message-assistant {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
            border-bottom-left-radius: 4px;
        }
        
        /* Preview Container */
        .preview-container {
            display: none;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin: 1rem 0;
        }
        
        .event-preview h2 {
            color: #f1f5f9;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .event-details {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 500;
            color: #94a3b8;
            width: 120px;
            flex-shrink: 0;
        }
        
        .detail-value {
            color: #f1f5f9;
            flex: 1;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: #6366f1;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4f46e5;
        }
        
        .btn-primary:disabled {
            background: #4b5563;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Floating Particles Background -->
    <div class="floating-particles" id="particles"></div>
    
    <!-- Login Page (before login) -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <h1>Smart Scheduler</h1>
            <p>Welcome Back</p>
            <p class="subtext">Sign in to manage your schedule with AI</p>
            
            <div class="login-buttons">
                <button id="authorizeButton" class="google-signin-btn" onclick="handleAuthClick(event)">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    <span>Continue with Google</span>
                </button>
                <button id="testButton" class="google-signin-btn test-mode" onclick="testButtonClick()">
                    <i class="fab fa-google"></i>
                    <span>Continue in Test Mode</span>
                </button>
            </div>
            
            <div class="login-footer">
                <p>By continuing, you agree to our Terms of Service and Privacy Policy</p>
            </div>
        </div>
    </div>
    
    <!-- Welcome Preview Screen (shown before login) -->
    <div class="welcome-preview" id="welcomePreview" style="display: none;">
        <div class="welcome-content">
            <div class="welcome-logo">
                <i class="fas fa-calendar-alt"></i>
                <h1>Smart Scheduler</h1>
            </div>
            <p class="welcome-tagline">Your intelligent scheduling assistant</p>
            <button id="getStartedBtn" class="btn btn-primary">
                Get Started
            </button>
        </div>
    </div>

    <!-- App Layout (after login) -->
    <div class="app-layout" id="appLayout" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- App Logo -->
            <div class="logo-container">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0MDAgNDAwIiBmaWxsPSIjNjM2NmYxIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgcng9IjIwIiBmaWxsPSIjZmZmIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PUFyaWFsIGZvbnQtc2l6ZT0iMTIwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBhbGlnbm1lbnQtYmFzZWxpbmU9Im1pZGRsZSIgZmlsbD0iIzYzNjZmMSI+UzwvdGV4dD48L3N2Zz4=" alt="Smart Scheduler" class="app-logo">
            </div>
            
            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button id="welcomeBtn" class="nav-button active" title="Home">
                    <i class="fas fa-home"></i>
                </button>
                <button id="chatBtn" class="nav-button" title="Chat">
                    <i class="fas fa-comment"></i>
                </button>
            </div>
            
            <div class="nav-footer">
                <button id="signOutBtn" class="nav-button sign-out" title="Sign Out">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Welcome Page (shown by default) -->
            <div class="content-page active" id="welcomePage">
                <div class="welcome-message">
                    <h1>Welcome, <span id="welcomeName">User</span>! 👋</h1>
                    <p class="welcome-subtitle">How can I help you schedule today?</p>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button class="quick-action" id="newEventBtn">
                            <i class="fas fa-plus"></i>
                            <span>New Event</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chat Page -->
            <div class="content-page" id="chatPage" style="display: none;">
                <!-- View Toggle -->
                <div class="view-toggle">
                    <button id="chatViewBtn" class="view-toggle-btn active">
                        <i class="fas fa-comments"></i> Chat
                    </button>
                    <button id="previewViewBtn" class="view-toggle-btn">
                        <i class="fas fa-calendar-check"></i> Preview
                    </button>
                </div>

                <!-- Chat View -->
                <div id="chatView" class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message message-assistant">
                            <strong>🤖 Assistant:</strong><br>
                            Welcome! I'm your smart scheduling assistant. How can I help you today?
                        </div>
                    </div>
                </div>

                <!-- Preview View -->
                <div id="previewView" class="preview-container" style="display: none;">
                    <div class="user-info">
                        <div id="userAvatar" class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <span id="userName" class="user-name">User Name</span>
                            <span class="user-email" id="userEmail">user@example.com</span>
                        </div>
                        <button id="signout_button" class="signout-btn" title="Sign out">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                    <div class="event-preview">
                        <h2>Event Preview</h2>
                        <div class="event-details">
                            <div class="detail-row">
                                <div class="detail-label">Event Title</div>
                                <div class="detail-value" id="previewTitle">-</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Date & Time</div>
                                <div class="detail-value" id="previewDateTime">-</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Attendees</div>
                                <div class="detail-value" id="previewAttendees">-</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Location</div>
                                <div class="detail-value" id="previewLocation">-</div>
                            </div>
                        </div>
                        <button id="createEventBtn" class="btn btn-primary" disabled>
                            <i class="fas fa-calendar-plus"></i> Create Event
                        </button>
                    </div>
                </div>
        </div>    
    </div>
    
    <!-- Input Container (initially hidden) -->
    <div class="input-container" id="inputContainer" style="display: none;">
        <div class="input-wrapper">
            <input type="text" id="inputBox" class="smart-input" placeholder="✨ Tell me about your plans..." disabled />
        </div>
        <button id="voiceButton" class="voice-button" disabled>🎤</button>
    </div>

<script>
    // Google OAuth Configuration - using the one in head section with additional scopes
    let chatHistory = [];
    let questionCount = 0;
    let baseDate = new Date(); // Base date for the session
    let eventDetails = {
      date: null,
      time: null,
      attendees: null,
      location: null,
      attendeeEmails: []
    };

    // Validate API key format
    function validateApiKey(apiKey) {
      if (!apiKey || typeof apiKey !== 'string' || apiKey.length < 10) {
        console.error('Invalid API key format');
        return false;
      }
      return true;
    }

    // Function to track what information we still need
    function getMissingInfo() {
      const missing = [];
      if (!eventDetails.date) missing.push('date/day');
      if (!eventDetails.time) missing.push('time');
      if (!eventDetails.attendees) missing.push('who is attending');
      if (!eventDetails.location) missing.push('location');
      return missing;
    }

    // Function to get contextual missing info (for backward compatibility)
    function getContextualMissingInfo() {
      return getMissingInfo();
    }

    // Function to determine the next action needed
    function getNextAction() {
      if (!eventDetails.date) return 'Ask for date/day';
      if (!eventDetails.time) return 'Ask for time';
      if (!eventDetails.location) return 'Ask for location';
      if (requiresEmailInvitation() && eventDetails.attendeeEmails.length === 0) {
        return 'Ask for email address';
      }
      return 'Ready to create event';
    }

    // Function to parse date and time into a DateTime object
    function parseDateTime(dateStr, timeStr) {
      if (!dateStr || !timeStr) return null;

      // Use baseDate instead of current time for consistent calculations
      let targetDate = new Date(baseDate);

      // Parse date
      const dateLower = dateStr.toLowerCase();
      if (dateLower === 'today') {
        targetDate = new Date(baseDate);
      } else if (dateLower === 'tomorrow') {
        targetDate = new Date(baseDate.getTime() + 24 * 60 * 60 * 1000);
      } else if (dateLower.startsWith('next ')) {
        const day = dateLower.replace('next ', '');
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const targetDay = days.indexOf(day);
        if (targetDay !== -1) {
          const currentDay = baseDate.getDay();
          let daysToAdd = targetDay - currentDay;
          if (daysToAdd <= 0) daysToAdd += 7;
          targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
          console.log(`Next ${day}: base day ${currentDay}, target day ${targetDay}, days to add ${daysToAdd}`);
        }
      } else if (dateLower.startsWith('this ')) {
        const day = dateLower.replace('this ', '');
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const targetDay = days.indexOf(day);
        if (targetDay !== -1) {
          const currentDay = baseDate.getDay();
          let daysToAdd = targetDay - currentDay;
          if (daysToAdd < 0) daysToAdd += 7;
          targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
        }
      } else {
        // Handle just day names like "monday", "tuesday", etc.
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        if (days.includes(dateLower)) {
          const targetDay = days.indexOf(dateLower);
          if (targetDay !== -1) {
            const currentDay = baseDate.getDay();
            let daysToAdd = targetDay - currentDay;
            // If it's the same day or past, schedule for next week
            if (daysToAdd <= 0) daysToAdd += 7;
            targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
            console.log(`Scheduling for ${dateLower}: base day ${currentDay}, target day ${targetDay}, days to add ${daysToAdd}`);
          }
        }
      }

      // Parse time
      const timeLower = timeStr.toLowerCase();
      let hours = 0, minutes = 0;

      // Handle formats like "9 AM", "2:30 PM", "14:30"
      const timeMatch = timeLower.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)?/);
      if (timeMatch) {
        hours = parseInt(timeMatch[1]);
        minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;

        if (timeMatch[3]) {
          const isPM = timeMatch[3] === 'pm';
          if (isPM && hours !== 12) hours += 12;
          if (!isPM && hours === 12) hours = 0;
        }
      }

      // Set the time on the target date
      targetDate.setHours(hours, minutes, 0, 0);

      console.log(`Time parsing: "${timeStr}" -> hours: ${hours}, minutes: ${minutes}, final time: ${targetDate.toLocaleString()}`);

      return targetDate;
    }

    // Function to extract and update event details from user input
    function updateEventDetails(userInput) {
      // Store the previous state for comparison
      const previousState = window.eventDetails ? {...window.eventDetails} : null;
      
      // Initialize eventDetails if it doesn't exist
      if (!window.eventDetails) {
        window.eventDetails = {
          summary: '',
          date: null,
          time: null,
          attendees: null,
          location: null,
          attendeeEmails: []
        };
      }
      const input = userInput.toLowerCase();

      // Extract date patterns (only if we don't already have a date)
      if (!eventDetails.date) {
        const datePatterns = [
          /(today|tomorrow|next \w+|this \w+)/i,
          /(\d{1,2}\/\d{1,2}|\d{1,2}-\d{1,2})/,
          /(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/i,
          /(january|february|march|april|may|june|july|august|september|october|november|december)/i
        ];

        let dateFound = false;
        for (const pattern of datePatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.date = match[0];
            dateFound = true;
            break;
          }
        }

        // If no date is mentioned, assume today
        if (!dateFound) {
          eventDetails.date = 'today';
        }
      }

      // Extract time patterns
      if (!eventDetails.time) {
        const timePatterns = [
          /(\d{1,2}:\d{2}\s*(am|pm))/i,
          /(\d{1,2}\s*(am|pm))/i,
          /(\d{1,2}:\d{2})/,
          /(\d{1,2}\s*o'clock)/i,
          /^(\d{1,2})$/  // Handle single digits like "9"
        ];

        for (const pattern of timePatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.time = match[0];
            console.log(`Time extracted: "${match[0]}" from input "${userInput}"`);
            break;
          }
        }
      }

      // If we have a date but no time, and the input looks like just a time, extract it
      if (eventDetails.date && !eventDetails.time) {
        const timeOnlyPatterns = [
          /^(\d{1,2}:\d{2}\s*(am|pm))$/i,
          /^(\d{1,2}\s*(am|pm))$/i,
          /^(\d{1,2}:\d{2})$/,
          /^(\d{1,2}\s*o'clock)$/i,
          /^(\d{1,2})$/  // Handle single digits like "9"
        ];

        for (const pattern of timeOnlyPatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.time = match[0];
            console.log(`Time-only extracted: "${match[0]}" from input "${userInput}"`);
            break;
          }
        }
      }

      // Extract attendees - prioritize patterns that include other people
      if (!eventDetails.attendees) {
        // First check for patterns that include other people
        const otherPeoplePatterns = [
          /(with\s+my\s+\w+)/i,  // "with my mom", "with my dad"
          /(and\s+my\s+\w+)/i,   // "and my mom"
          /(me\s+and\s+\w+)/i,   // "me and mom"
          /(\w+\s+and\s+me)/i,   // "mom and me"
          /(mom|mother|dad|father|brother|sister|family)/i,
          /(friend|friends|colleague|colleagues|team)/i,
          /(spouse|wife|husband|girlfriend|boyfriend|partner)/i,
          /(boss|manager|client|doctor|teacher)/i
        ];
        
        // Then check for solo patterns
        const soloPatterns = [
          /(myself|me|i|alone)/i,
          /(just\s+\w+)/i
        ];

        // Try other people patterns first
        for (const pattern of otherPeoplePatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.attendees = match[0];
            console.log(`Attendees extracted (with others): "${match[0]}"`);
            break;
          }
        }
        
        // If no other people found, try solo patterns
        if (!eventDetails.attendees) {
          for (const pattern of soloPatterns) {
            const match = input.match(pattern);
            if (match) {
              eventDetails.attendees = match[0];
              console.log(`Attendees extracted (solo): "${match[0]}"`);
              break;
            }
          }
        }
      }

      // Extract location
      if (!eventDetails.location) {
        const locationPatterns = [
          /(at|in|to)\s+(\w+)/i,
          /(bank|home|office|school|hospital|restaurant|cafe|store|mall|park|gym|library|church|airport)/i,
          /(the\s+\w+)/i
        ];

        for (const pattern of locationPatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.location = match[0];
            break;
          }
        }
      }

      // Extract email addresses for invitations
      const emailPattern = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
      const emailMatches = userInput.match(emailPattern);
      if (emailMatches) {
        emailMatches.forEach(email => {
          if (!eventDetails.attendeeEmails.includes(email)) {
            eventDetails.attendeeEmails.push(email);
            console.log(`Email added for invitation: ${email}`);
          }
        });
      }

      // Handle "no" responses to email requests
      if (input.includes('no') && input.length < 10) {
        console.log('User declined to provide email addresses');
      }
      
      // Check if any details were actually updated
      const hasChanges = previousState ? 
        JSON.stringify(previousState) !== JSON.stringify(window.eventDetails) : 
        true;
      
      if (hasChanges) {
        console.log('Event details updated:', window.eventDetails);
        
        // Update the event preview if we're on the preview view
        if (window.updateEventPreview) {
          window.updateEventPreview();
        }
        
        // If we have all required fields, suggest creating the event
        if (window.eventDetails.date && 
            window.eventDetails.time && 
            window.eventDetails.attendees && 
            window.eventDetails.location) {
          
          // Only auto-switch to preview if we weren't already there
          const previewViewBtn = document.getElementById('previewViewBtn');
          if (previewViewBtn && !previewViewBtn.classList.contains('active')) {
            // Add a small delay to allow the UI to update
            setTimeout(() => {
              if (previewViewBtn && !previewViewBtn.classList.contains('active')) {
                previewViewBtn.click();
                // Add a message suggesting to create the event
                addAssistantMessage("I've updated the event preview. Would you like to create this event?");
              }
            }, 500);
          }
        }
      }
    }

    // Function to check if other people are mentioned in attendees
    function requiresEmailInvitation() {
      if (!eventDetails.attendees) {
        console.log('requiresEmailInvitation: No attendees found');
        return false;
      }
      
      const attendeesLower = eventDetails.attendees.toLowerCase();
      console.log(`requiresEmailInvitation: Checking attendees: "${eventDetails.attendees}"`);
      
      const otherPeopleKeywords = [
        'mom', 'mother', 'dad', 'father', 'brother', 'sister', 
        'friend', 'colleague', 'team', 'family', 'spouse', 
        'wife', 'husband', 'girlfriend', 'boyfriend', 'partner',
        'boss', 'manager', 'client', 'doctor', 'teacher'
      ];
      
      // Check if any keywords for other people are mentioned
      const mentionsOthers = otherPeopleKeywords.some(keyword => 
        attendeesLower.includes(keyword)
      );
      
      // Don't require email if it's just the user
      const justUser = attendeesLower.includes('myself') || 
                      attendeesLower.includes('me') || 
                      attendeesLower.includes('alone') ||
                      attendeesLower === 'i';
      
      const result = mentionsOthers && !justUser;
      console.log(`requiresEmailInvitation: mentionsOthers=${mentionsOthers}, justUser=${justUser}, result=${result}`);
      
      return result;
    }

    // Function to add an assistant message to the chat
    function addAssistantMessage(message) {
      const chatMessages = document.getElementById('chatMessages');
      if (!chatMessages) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message message-assistant';
      messageDiv.innerHTML = `<strong>🤖 Assistant:</strong><br>${message}`;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Function to generate a smart event name using LLM
    async function generateSmartEventName() {
      const prompt = `Create a concise, descriptive event title based on these details:
- Date: ${eventDetails.date}
- Time: ${eventDetails.time}
- Attendees: ${eventDetails.attendees}
- Location: ${eventDetails.location}

Generate a natural, professional event title (2-6 words). Examples:
- "Bank Visit with Mom"
- "Team Meeting at Office"
- "Lunch with Friends"
- "Doctor Appointment"
- "Family Dinner"

Respond with ONLY the event title, no quotes or extra text.`;

      try {
        const body = {
          model: "mistralai/Mixtral-8x7B-Instruct-v0.1",
          messages: [
            {
              role: "system",
              content: "You are an expert at creating concise, professional event titles. Respond with only the event title, nothing else."
            },
            {
              role: "user",
              content: prompt
            }
          ],
          max_tokens: 50,
          temperature: 0.3
        };

        const response = await fetch("https://api.together.xyz/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${TOGETHER_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }

        const data = await response.json();
        const eventName = data.choices?.[0]?.message?.content?.trim() || "Event";
        
        console.log(`Generated smart event name: "${eventName}"`);
        return eventName;
      } catch (error) {
        console.error('Error generating smart event name:', error);
        // Fallback to a simple name
        return `${eventDetails.location ? eventDetails.location.charAt(0).toUpperCase() + eventDetails.location.slice(1) : 'Event'} ${eventDetails.attendees ? 'with ' + eventDetails.attendees : ''}`;
      }
    }

         // Initialize elements safely
     let authBtn, signOutBtn, inputBox, msg;
     
     function initializeElements() {
         authBtn = document.getElementById('authorize_button');
         signOutBtn = document.getElementById('signout_button');
         inputBox = document.getElementById('inputBox');
         msg = document.getElementById('message');
         
         // Set up event listeners if elements exist
         if (authBtn) {
             authBtn.onclick = handleAuthClick;
         }
         
         if (signOutBtn) {
             signOutBtn.onclick = handleSignout;
         }
         
         if (inputBox) {
             inputBox.addEventListener('keypress', function(e) {
                 if (e.key === 'Enter') {
                     sendToLLM(this.value, true);
                     this.value = '';
                 }
             });
         }
     }
     
     // Initialize elements when DOM is loaded
     if (document.readyState === 'loading') {
         document.addEventListener('DOMContentLoaded', initializeElements);
     } else {
         initializeElements();
     }
     const darkToggle = document.getElementById('darkToggle');
     const voiceButton = document.getElementById('voiceButton');

     // Voice recognition setup
     let recognition = null;
     if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
       recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
       recognition.continuous = false;
       recognition.interimResults = false;
       recognition.lang = 'en-US';

       recognition.onstart = () => {
         voiceButton.classList.add('recording');
         voiceButton.textContent = '🔴';
       };

       recognition.onresult = (event) => {
         const transcript = event.results[0][0].transcript;
         inputBox.value = transcript;
         // Trigger the input event to process the voice input
         inputBox.dispatchEvent(new Event('input'));
       };

       recognition.onend = () => {
         voiceButton.classList.remove('recording');
         voiceButton.textContent = '🎤';
       };

       recognition.onerror = (event) => {
         console.error('Speech recognition error:', event.error);
         voiceButton.classList.remove('recording');
         voiceButton.textContent = '🎤';
       };
     }

    // Dark toggle functionality (element doesn't exist, so commenting out)
    // darkToggle.onclick = () => document.body.classList.toggle('dark');

    async function gapiLoaded() {
      try {
        console.log('Loading Google API client...');
        await new Promise((resolve, reject) => {
          gapi.load('client', {
            callback: resolve,
            onerror: reject
          });
        });
        await initializeGapi();
      } catch (error) {
        console.error('Failed to load Google API:', error);
      }
    }
    
    async function initializeGapi() {
      try {
        console.log('Initializing Google API client...');
        await gapi.client.init({
          discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        console.log('Google API client initialized successfully');
        maybeEnableButtons();
      } catch (error) {
        console.error('Failed to initialize Google API:', error);
      }
    }
    
    function gisLoaded() {
      try {
        console.log('Initializing Google Identity Services...');
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (resp) => {
            if (resp.error !== undefined) {
              console.error('OAuth error:', resp.error);
              return;
            }
            accessToken = resp.access_token;
            console.log('OAuth token received');
            handleAuthSuccess();
          },
        });
        gisInited = true;
        console.log('Google Identity Services initialized successfully');
        maybeEnableButtons();
      } catch (error) {
        console.error('Failed to initialize Google Identity Services:', error);
      }
    }
    
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        console.log('Google APIs initialized, enabling sign-in button');
        const authBtn = document.getElementById('authorize_button');
        if (authBtn) {
          authBtn.onclick = handleAuthClick;
          authBtn.disabled = false;
        }
      }
    }
    
    function handleAuthClick(event) {
      console.log('Auth button clicked');
      if (event) event.preventDefault();
      
      if (!window.tokenClient) {
        console.error('Token client not initialized');
        showError('Authentication service not ready. Please refresh the page.');
        // Try to initialize again
        initializeGoogleAPIs();
        return;
      }
      
      console.log('Requesting access token...');
      try {
        // Request access token
        window.tokenClient.callback = (response) => {
          if (response.error) {
            console.error('Auth error:', response.error);
            showError('Authentication failed. Please try again.');
            return;
          }
          console.log('Access token received');
          accessToken = response.access_token;
          handleAuthSuccess();
        };
        
        if (window.gapi && window.gapi.client && window.gapi.client.getToken() === null) {
          // Prompt the user to select a Google Account and ask for consent to share their data
          window.tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
          // Skip display of account chooser and consent dialog for an existing session
          window.tokenClient.requestAccessToken({ prompt: '' });
        }
      } catch (error) {
        console.error('Error during auth:', error);
        showError('An error occurred during authentication. Please try again.');
      }
    }

         // Voice button click handler
     voiceButton.onclick = () => {
       if (recognition && !inputBox.disabled) {
         recognition.start();
       }
     };

     authBtn.onclick = () => {
       tokenClient.callback = async (resp) => {
         if (resp.error) return msg.textContent = 'Auth error: ' + resp.error;
         accessToken = resp.access_token;
         
         // After successful login
    async function handleAuthSuccess() {
      console.log('Handling successful authentication...');
      
      // Get UI elements
      const loginContainer = document.getElementById('loginContainer');
      const welcomePreview = document.getElementById('welcomePreview');
      const appLayout = document.getElementById('appLayout');
      const inputContainer = document.getElementById('inputContainer');
      const welcomePage = document.getElementById('welcomePage');
      const chatPage = document.getElementById('chatPage');
      
      try {
        // Hide login and preview, show app layout
        if (loginContainer) loginContainer.style.display = 'none';
        if (welcomePreview) welcomePreview.style.display = 'none';
        if (appLayout) appLayout.style.display = 'flex';
        if (inputContainer) inputContainer.style.display = 'flex';
        
        // Show welcome page by default
        if (welcomePage) welcomePage.classList.add('active');
        if (chatPage) chatPage.classList.remove('active');
        
        // Load user profile
        await loadUserProfile();
        
        // Initialize navigation
        setupNavigation();
        
        // Enable input box
        const inputBox = document.getElementById('inputBox');
        if (inputBox) inputBox.disabled = false;
        
        console.log('Authentication flow completed successfully');
        
      } catch (error) {
        console.error('Error in handleAuthSuccess:', error);
        showError('Error initializing the application. Please refresh and try again.');
        
        // Reset UI to login state
        if (loginContainer) loginContainer.style.display = 'flex';
        if (appLayout) appLayout.style.display = 'none';
        if (inputContainer) inputContainer.style.display = 'none';
      }
    }
         handleAuthSuccess();
         
         // Switch to app layout
         document.getElementById('loginLayout').style.display = 'none';
         document.getElementById('appLayout').classList.add('active');
         
         // Enable input
         inputBox.disabled = false;
         voiceButton.disabled = false;
       };
       tokenClient.requestAccessToken();
     };
     
     // Setup navigation between pages
    function setupNavigation() {
      // Welcome button
      document.getElementById('welcomeBtn').addEventListener('click', () => {
        document.getElementById('welcomePage').style.display = 'block';
        document.getElementById('chatPage').style.display = 'none';
        document.getElementById('inputContainer').style.display = 'none';
        
        // Update active state
        document.getElementById('welcomeBtn').classList.add('active');
        document.getElementById('chatBtn').classList.remove('active');
      });
      
      // Chat button
      document.getElementById('chatBtn').addEventListener('click', () => {
        document.getElementById('welcomePage').style.display = 'none';
        document.getElementById('chatPage').style.display = 'block';
        document.getElementById('inputContainer').style.display = 'flex';
        
        // Update active state
        document.getElementById('welcomeBtn').classList.remove('active');
        document.getElementById('chatBtn').classList.add('active');
        
        // Focus input
        setTimeout(() => {
          const input = document.getElementById('inputBox');
          if (input) input.focus();
        }, 100);
      });
      
      // Sign out button
      document.getElementById('signOutBtn').addEventListener('click', () => {
        // Sign out logic
        if (accessToken) {
          google.accounts.oauth2.revoke(accessToken);
          accessToken = null;
        }
        
        // Reset UI
        document.getElementById('appLayout').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
        
        // Reset input
        const inputBox = document.getElementById('inputBox');
        inputBox.value = '';
        inputBox.disabled = true;
        
        // Reset message
        const msg = document.getElementById('message');
        if (msg) {
          msg.innerHTML = '<strong>🤖 Assistant:</strong><br>Welcome! Please sign in to get started with your smart scheduling assistant.';
        }
        
        // Show auth button
        document.getElementById('authorize_button').style.display = 'inline-block';
      });
    }

     // Tab switching functionality
     function setupTabs() {
       const tabs = document.querySelectorAll('.nav-tab');
       
       tabs.forEach(tab => {
         tab.addEventListener('click', () => {
           // Remove active class from all tabs and content
           document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
           document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
           
           // Add active class to clicked tab and corresponding content
           tab.classList.add('active');
           const tabId = tab.getAttribute('data-tab');
           document.getElementById(`${tabId}Tab`).classList.add('active');
           
           // If switching to chat, focus the input
           if (tabId === 'chat') {
             setTimeout(() => {
               const input = document.getElementById('inputBox');
               if (input) input.focus();
             }, 100);
           }
         });
       });
     }
     
     // Initialize dashboard functionality
     function initializeDashboard() {
       // Setup tab switching
       setupTabs();
       
       // Quick action buttons
       document.querySelectorAll('.action-card').forEach(card => {
         card.addEventListener('click', () => {
           const action = card.getAttribute('data-action');
           
           switch(action) {
             case 'schedule':
               // Switch to chat tab and focus input
               document.querySelector('.nav-tab[data-tab="chat"]').click();
               break;
               
             case 'upcoming':
               // Show upcoming events (placeholder)
               alert('Upcoming events feature coming soon!');
               break;
               
             case 'settings':
               // Show settings (placeholder)
               alert('Settings feature coming soon!');
               break;
           }
         });
       });
     }

     // Load user profile from Google
    async function loadUserProfile() {
      console.log('Loading user profile...');
      
      try {
        // Make sure gapi client is initialized
        if (!gapi.client) {
          throw new Error('Google API client not initialized');
        }
        
        // Get the user's profile information
        const response = await gapi.client.people.people.get({
          resourceName: 'people/me',
          personFields: 'names,emailAddresses,photos'
        });
        
        const profile = response.result;
        console.log('User profile loaded:', profile);
        
        // Update UI with user info
        const userName = profile.names ? profile.names[0].displayName : 'User';
        const email = profile.emailAddresses ? profile.emailAddresses[0].value : '';
        const photoUrl = profile.photos ? profile.photos[0].url : '';
        
        // Update UI elements
        updateUserProfileUI(userName, photoUrl, email);
        
        return profile;
        
      } catch (error) {
        console.error('Error loading user profile:', error);
        
        // Set default values
        updateUserProfileUI('User', null, '');
        
        // Only show error if it's not a network issue
        if (!navigator.onLine) {
          console.warn('Network is offline, using cached profile data');
        } else {
          showError('Could not load your profile information. Some features may be limited.');
        }
        
        throw error; // Re-throw to be handled by the caller
      }
    }
    
    // Update user profile UI elements
    function updateUserProfileUI(displayName, photoUrl = null, email = '') {
      const userNameElements = document.querySelectorAll('.user-name');
      const userEmailElements = document.querySelectorAll('.user-email');
      const userAvatarElements = document.querySelectorAll('.user-avatar');
      const welcomeNameElements = document.querySelectorAll('#welcomeName');
      
      // Update welcome message with user's name
      welcomeNameElements.forEach(el => {
        if (el) el.textContent = displayName;
      });
      
      // Update user info in the sidebar
      userNameElements.forEach(el => el.textContent = displayName);
      userEmailElements.forEach(el => el.textContent = email);
      
      // Update avatar
      if (photoUrl) {
        userAvatarElements.forEach(el => {
          el.innerHTML = ''; // Clear any existing content
          const img = document.createElement('img');
          img.src = photoUrl;
          img.alt = displayName;
          img.onerror = function() {
            // If image fails to load, fall back to initials
            showInitials(el, displayName);
          };
          el.appendChild(img);
          el.style.backgroundColor = 'transparent';
        });
      } else {
        // Fallback to initials
        userAvatarElements.forEach(el => {
          showInitials(el, displayName);
        });
      }
      
      // Helper function to show user initials
      function showInitials(element, name) {
        if (!name) return;
        
        const initials = name.split(' ')
          .map(part => part[0])
          .join('')
          .toUpperCase()
          .substring(0, 2);
        
        element.textContent = initials;
        element.style.backgroundColor = getRandomColor();
        
        // Ensure text is visible
        element.style.color = '#fff';
        element.style.display = 'flex';
        element.style.alignItems = 'center';
        element.style.justifyContent = 'center';
        element.style.borderRadius = '50%';
        element.style.width = '40px';
        element.style.height = '40px';
        element.style.fontSize = '16px';
        element.style.fontWeight = 'bold';
      }
      
      // Store in local storage for persistence
      try {
        localStorage.setItem('user_profile', JSON.stringify({
          name: displayName,
          email: email,
          photoUrl: photoUrl,
          lastUpdated: new Date().toISOString()
        }));
      } catch (e) {
        console.error('Error saving user profile to localStorage:', e);
      }
      
      // Make sure the welcome message is visible
      const welcomeMessage = document.querySelector('.welcome-message');
      if (welcomeMessage) {
        welcomeMessage.style.display = 'block';
      }
      
      console.log('UI updated for user:', displayName);
      return displayName;
    }

     // Sign out handler
     signOutBtn.onclick = () => {
       if (accessToken) {
         google.accounts.oauth2.revoke(accessToken);
       }
       accessToken = null;
       inputBox.value = '';
       inputBox.disabled = true;
       voiceButton.disabled = true;
       msg.textContent = 'Signed out.';
       authBtn.style.display = 'inline-block';
       signOutBtn.style.display = 'none';
     };

        async function sendToLLM(text, isFinal = false) {
      chatHistory.push({ role: "user", content: text });

      // Get current date and time for the prompt
      const currentDateTime = new Date().toLocaleString();

      let systemPrompt = isFinal
        ? "Based on this conversation, create a calendar event. Return a JSON object with this format: {\"summary\": \"Event title\", \"dateTime\": \"2025-08-01T14:00:00Z\"}. Use ISO 8601 format and UTC time. Combine the date and time information to create the dateTime field."
        : `You are a direct and efficient scheduling assistant. You need to gather exactly 4 pieces of information in this order:

1) DATE/DAY (e.g., "Tuesday", "tomorrow", "January 15th")
2) TIME (e.g., "5 PM", "9:30 AM")
3) LOCATION (e.g., "bank", "restaurant", "home")
4) EMAIL for other people mentioned (if any)

Current date and time: {{CURRENT_DATETIME}}

RULES:
- Ask for missing information in order: Date → Time → Location → Email
- Be direct and clear in your questions
- If someone mentions other people (mom, dad, friend, etc.), ALWAYS ask for their email address
- Use simple, short questions like "Where are you going?" or "What's your mom's email address?"
- Don't create the event until you have all required information

Current information:
- Date: ${eventDetails.date || 'Missing'}
- Time: ${eventDetails.time || 'Missing'}
- Attendees: ${eventDetails.attendees || 'Just you'}
- Location: ${eventDetails.location || 'Missing'}
- Attendee Emails: ${eventDetails.attendeeEmails.length > 0 ? eventDetails.attendeeEmails.join(', ') : 'None needed'}

NEXT ACTION: ${getNextAction()}

Respond with ONE short, direct question to get the missing information.`;

      // Replace the placeholder with actual current date and time
      systemPrompt = systemPrompt.replace('{{CURRENT_DATETIME}}', currentDateTime);

      const body = {
        model: "mistralai/Mixtral-8x7B-Instruct-v0.1",
        messages: [
          {
            role: "system",
            content: systemPrompt
          },
          ...chatHistory
        ],
        max_tokens: 300,
        temperature: 0.7
      };

      try {
        if (!validateApiKey(TOGETHER_API_KEY)) {
          throw new Error('Invalid API key configuration');
        }

        const response = await fetch("https://api.together.xyz/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${TOGETHER_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(`API error: ${data.error.message || 'Unknown error'}`);
        }

        const reply = data.choices?.[0]?.message?.content || "I couldn't understand that.";
        chatHistory.push({ role: "assistant", content: reply });
        return reply;
      } catch (error) {
        console.error('LLM API error:', error);
        const errorMessage = "Sorry, I'm having trouble processing your request. Please try again.";
        chatHistory.push({ role: "assistant", content: errorMessage });
        return errorMessage;
      }
    }

    async function createEvent(summary, dateTime, attendeeEmails = []) {
      try {
        const endDate = new Date(dateTime.getTime() + 60 * 60 * 1000);
        const event = {
          summary,
          start: { dateTime: dateTime.toISOString(), timeZone: 'UTC' },
          end: { dateTime: endDate.toISOString(), timeZone: 'UTC' }
        };
        
        // Add attendees if emails are provided
        if (attendeeEmails && attendeeEmails.length > 0) {
          event.attendees = attendeeEmails.map(email => ({ email: email.trim() }));
        }
        
        const res = await gapi.client.calendar.events.insert({
          calendarId: 'primary',
          resource: event
        });
        return res.result.htmlLink;
      } catch (error) {
        console.error('Calendar API error:', error);
        throw new Error('Failed to create calendar event. Please check your permissions and try again.');
      }
    }

    async function createEventFromDetails() {
      try {
        // Generate a smart event name using LLM
        const summary = await generateSmartEventName();
        
        // Parse date and time to create a proper DateTime
        const dateTime = parseDateTime(window.eventDetails.date, window.eventDetails.time);
        
        if (!dateTime) {
          throw new Error('Could not parse the date and time information');
        }
        
        // Debug logging
        console.log('Base date for session:', baseDate.toLocaleString());
        console.log('Event details:', window.eventDetails);
        console.log('Parsed dateTime:', dateTime);
        console.log('Current real time:', new Date());
        
        // Validate that the date is in the future relative to base date (with some tolerance)
        const timeDiff = dateTime.getTime() - baseDate.getTime();
        const hoursDiff = timeDiff / (1000 * 60 * 60);
        
        if (hoursDiff < -1) { // Allow 1 hour tolerance for past events
          throw new Error(`Event date must be in the future. The specified time (${dateTime.toLocaleString()}) is in the past relative to the session start time (${baseDate.toLocaleString()}).`);
        }
        
        // Create the event
        const eventLink = await createEvent(summary, dateTime, window.eventDetails.attendeeEmails || []);
        const inviteInfo = window.eventDetails.attendeeEmails?.length > 0 
          ? ` (Invites sent to: ${window.eventDetails.attendeeEmails.join(', ')})` 
          : '';
          
        // Show success message
        addAssistantMessage(`📅 Event created: <a href="${eventLink}" target="_blank">${summary}</a>${inviteInfo}`);

        // Reset for next event
        questionCount = 0;
        chatHistory = [];
        window.eventDetails = { 
          summary: '',
          date: null, 
          time: null, 
          attendees: null, 
          location: null, 
          attendeeEmails: [] 
        };
        
        // Reset base date for new session
        baseDate = new Date();
        console.log('New session started with base date:', baseDate.toLocaleString());
        
        // Update the preview to show empty fields
        if (window.updateEventPreview) {
          window.updateEventPreview();
        }
        
        // Switch back to chat view
        const chatViewBtn = document.getElementById('chatViewBtn');
        if (chatViewBtn) {
          chatViewBtn.click();
        }

      } catch (error) {
        console.error('Event creation error:', error);
        msg.textContent = `⚠️ ${error.message}`;
        questionCount = 0;
        chatHistory = [];
        eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
      }
    }

    inputBox.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;
      const text = inputBox.value.trim();
      if (!text) return;

      msg.textContent = '🤖 Thinking...';
      inputBox.value = '';
      inputBox.disabled = true;
      questionCount++;

      // Update event details with user input
      updateEventDetails(text);

      // Debug logging
      console.log('After updateEventDetails:', eventDetails);
      console.log('Has all info:', eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location);

      // Check if we have all required information
      const hasBasicInfo = eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location;
      const needsEmailInvitation = requiresEmailInvitation();
      const hasEmailsWhenNeeded = !needsEmailInvitation || eventDetails.attendeeEmails.length > 0;
      const hasAllInfo = hasBasicInfo && hasEmailsWhenNeeded;
      const isFinal = questionCount >= 6; // Fallback to prevent infinite loops

      console.log(`Event processing: hasBasicInfo=${hasBasicInfo}, needsEmailInvitation=${needsEmailInvitation}, hasEmailsWhenNeeded=${hasEmailsWhenNeeded}, hasAllInfo=${hasAllInfo}`);
      console.log(`Current eventDetails:`, eventDetails);

      // If we have all basic info but need emails, ask for them via AI
      if (hasBasicInfo && needsEmailInvitation && eventDetails.attendeeEmails.length === 0) {
        console.log('All basic info gathered, but need email for invitation - continuing to AI');
        // Continue to AI to ask for email
      }
      // If we have all info including emails (when needed), create event directly
      else if (hasAllInfo) {
        console.log('All information complete - creating event directly');
        msg.textContent = '🎯 All information gathered! Creating your event...';
        await createEventFromDetails();
        return;
      }

      const reply = await sendToLLM(text, isFinal);

      if (isFinal) {
        try {
          const jsonMatch = reply.match(/{[^}]+}/);
          if (jsonMatch) {
            const parsed = JSON.parse(jsonMatch[0]);
            const { summary, dateTime } = parsed;

            // Validate date string
            const eventDate = new Date(dateTime);
            if (isNaN(eventDate.getTime())) {
              throw new Error('Invalid date format received from AI');
            }

            // Check if date is in the future relative to base date (with tolerance)
            const timeDiff = eventDate.getTime() - baseDate.getTime();
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            if (hoursDiff < -1) { // Allow 1 hour tolerance for past events
              throw new Error(`Event date must be in the future. The specified time (${eventDate.toLocaleString()}) is in the past relative to the session start time (${baseDate.toLocaleString()}).`);
            }

            // Generate smart event name instead of using basic summary
            const smartEventName = await generateSmartEventName();

            const eventLink = await createEvent(smartEventName, eventDate, eventDetails.attendeeEmails);
            const inviteInfo = eventDetails.attendeeEmails.length > 0 ? ` (Invites sent to: ${eventDetails.attendeeEmails.join(', ')})` : '';
            msg.innerHTML = `📅 Event created: <a href="${eventLink}" target="_blank">${smartEventName}</a>${inviteInfo}`;
            questionCount = 0;
            chatHistory = [];
            eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
            // Reset base date for new session
            baseDate = new Date();
            console.log('New session started with base date:', baseDate.toLocaleString());
            return;
          } else {
            throw new Error('No valid JSON found in response');
          }
        } catch (err) {
          console.error('Event creation error:', err);
          msg.textContent = `⚠️ ${err.message || "I couldn't understand the schedule details. Please try again."}`;
          questionCount = 0;
          chatHistory = [];
          eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
          // Reset base date for new session
          baseDate = new Date();
        }
      } else {
        // Check again if we now have all info after AI response
        const hasBasicInfoAfterAI = eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location;
        const needsEmailAfterAI = requiresEmailInvitation();
        const hasEmailsWhenNeededAfterAI = !needsEmailAfterAI || eventDetails.attendeeEmails.length > 0;
        const hasAllInfoAfterAI = hasBasicInfoAfterAI && hasEmailsWhenNeededAfterAI;

        if (hasAllInfoAfterAI) {
          msg.textContent = '🎯 All information gathered! Creating your event...';
          await createEventFromDetails();
          return;
        }

        // Show progress indicator and gathered info
        const progressInfo = `<br><br><small>📋 Progress: ${4 - getMissingInfo().length}/4 details gathered</small>`;

        const gatheredInfo = eventDetails.date || eventDetails.time || eventDetails.attendees || eventDetails.location
          ? `<br><small>✅ Gathered: ${[eventDetails.date, eventDetails.time, eventDetails.attendees, eventDetails.location].filter(Boolean).join(', ')}</small>`
          : '';

        msg.innerHTML = `<strong>🤖 Assistant:</strong><br>${reply.replace(/\n/g, '<br>')}${progressInfo}${gatheredInfo}`;
      }

      // Re-enable input box after processing
      inputBox.disabled = false;
    });

    // Create floating particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 50;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (15 + Math.random() * 10) + 's';
        particlesContainer.appendChild(particle);
      }
    }
    
    // Enhanced message display with animations
    function displayMessage(content, type = 'assistant') {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = content;
      
      // Replace the current message or add new one
      const existingMessage = document.getElementById('message');
      if (existingMessage && type === 'assistant') {
        existingMessage.innerHTML = content;
      } else {
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }
    
    // Show typing indicator
    function showTyping() {
      const chatContainer = document.getElementById('chatContainer');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing';
      typingDiv.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatContainer.appendChild(typingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Google API initialization with better error handling and People API support
    async function gapiLoaded() {
      console.log('Google API script loaded');
      
      try {
        // Load the client library
        await new Promise((resolve, reject) => {
          gapi.load('client:auth2', {
            callback: resolve,
            onerror: reject,
            timeout: 10000, // 10 seconds
            ontimeout: () => reject(new Error('Timeout loading Google API client'))
          });
        });
        
        // Initialize the client with the API key and client ID
        console.log('Initializing Google API client...');
        await gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        });
        
        console.log('Google API client initialized with scopes:', SCOPES);
        gapiInited = true;
        maybeEnableButtons();
        
        // Check if user is already signed in
        const authInstance = gapi.auth2.getAuthInstance();
        if (authInstance && authInstance.isSignedIn && authInstance.isSignedIn.get()) {
          console.log('User already signed in');
          const user = authInstance.currentUser.get();
          accessToken = user.getAuthResponse().access_token;
          
          // Set the token for gapi client
          if (gapi.client) {
            gapi.client.setToken({ access_token: accessToken });
          }
          
          // Handle successful authentication
          await handleAuthSuccess();
        }
        
      } catch (error) {
        console.error('Failed to initialize Google API:', error);
        
        // Show error to user
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) {
          loginContainer.innerHTML += `
            <div class="error-message" style="color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;">
              Error initializing Google services. Please refresh the page.
              <br><small>${error.message || 'Unknown error occurred'}</small>
            </div>
          `;
        }
      }
    }
    
    function gisLoaded() {
      console.log('Google Identity Services script loaded');
      
      try {
        if (!window.google || !window.google.accounts || !window.google.accounts.oauth2) {
          throw new Error('Google Identity Services not properly loaded');
        }
        
        // Initialize the token client with all required scopes
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          prompt: 'consent',
          callback: async (response) => {
            const authButton = document.getElementById('authorize_button');
            
            if (response.error) {
              console.error('OAuth error:', response.error);
              
              // Reset button state
              if (authButton) {
                authButton.textContent = 'Sign in with Google';
                authButton.disabled = false;
              }
              
              if (response.error === 'popup_closed') {
                console.log('User closed the OAuth popup');
              } else if (response.error === 'access_denied') {
                console.warn('User denied the permission request');
                alert('Permission is required to access your Google Calendar. Please grant the requested permissions.');
              } else {
                console.error('OAuth error:', response.error);
                alert('Sign-in error: ' + (response.error_description || response.error));
              }
              return;
            }
            
            console.log('OAuth token received');
            accessToken = response.access_token;
            
            try {
              // Set the token for gapi client
              if (gapi.client) {
                gapi.client.setToken({ access_token: accessToken });
              }
              
              // Handle successful authentication
              await handleAuthSuccess();
              
            } catch (error) {
              console.error('Error after authentication:', error);
              
              // Show error to user
              const loginContainer = document.getElementById('loginContainer');
              if (loginContainer) {
                loginContainer.innerHTML += `
                  <div class="error-message" style="color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;">
                    Error after sign-in: ${error.message || 'Unknown error occurred'}
                  </div>
                `;
              }
              
              // Reset button state
              if (authButton) {
                authButton.textContent = 'Sign in with Google';
                authButton.disabled = false;
              }
            }
          }
        });
        
        gisInited = true;
        console.log('Google Identity Services initialized with scopes:', SCOPES);
        maybeEnableButtons();
        
        // Set up the sign-in button if it exists
        const authButton = document.getElementById('authorize_button');
        if (authButton) {
          authButton.onclick = handleAuthClick;
          authButton.style.display = 'inline-block';
          authButton.disabled = false;
          console.log('Sign-in button initialized');
        } else {
          console.warn('Sign-in button not found in the DOM');
        }
        
      } catch (error) {
        console.error('Error initializing Google Identity Services:', error);
        
        // Show error to user
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) {
          loginContainer.innerHTML += `
            <div class="error-message" style="color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;">
              Error initializing Google Sign-In. Please refresh the page.
              <br><small>${error.message || 'Unknown error occurred'}</small>
            </div>
          `;
        }
      }
    }
    
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('authorize_button').onclick = handleAuthClick;
        document.getElementById('signout_button').onclick = handleSignoutClick;
        console.log('Google APIs initialized successfully');
      }
    }
    
    function handleAuthClick() {
      console.log('Sign-in button clicked');
      
      const authButton = document.getElementById('authorize_button');
      if (!authButton) {
        console.error('Sign-in button not found');
        return;
      }
      
      // Show loading state
      const originalText = authButton.textContent;
      authButton.textContent = 'Loading...';
      authButton.disabled = true;
      
      // Clear any previous error messages
      const errorMessages = document.querySelectorAll('.error-message');
      errorMessages.forEach(el => el.remove());
      
      try {
        if (!tokenClient) {
          throw new Error('Google Sign-In is not ready. Please refresh the page and try again.');
        }
        
        if (!gapiInited || !gisInited) {
          throw new Error('Google services not fully loaded. Please wait and try again.');
        }
        
        console.log('Requesting access token with scopes:', SCOPES);
        
        // Request token with consent
        tokenClient.requestAccessToken({
          prompt: 'consent',
          // Add any additional parameters needed for your app
          // For example, you can add login_hint for a better user experience
          // login_hint: 'user@example.com'
        });
        
        // The callback in tokenClient will handle the response
        
      } catch (error) {
        console.error('Sign-in error:', error);
        
        // Show error to user
        const loginContainer = document.getElementById('loginContainer');
        const errorMessage = document.createElement('div');
        errorMessage.className = 'error-message';
        errorMessage.style.cssText = 'color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;';
        
        let errorText = `Error during sign-in: ${error.message || 'Unknown error occurred'}`;
        
        // Add more user-friendly messages for common errors
        if (error.message && error.message.includes('popup_blocked')) {
          errorText = 'The sign-in popup was blocked. Please allow popups for this site and try again.';
        } else if (error.message && error.message.includes('access_denied')) {
          errorText = 'Permission was denied. Please grant the requested permissions to use the app.';
        }
        
        errorMessage.textContent = errorText;
        
        if (loginContainer) {
          loginContainer.appendChild(errorMessage);
          
          // Scroll to the error message
          setTimeout(() => {
            errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        } else {
          // If login container is not found, show an alert as fallback
          alert(errorText);
        }
        
        // Reset button state
        if (authButton) {
          authButton.textContent = originalText;
          authButton.disabled = false;
        }
      }
    }
    
    // After successful login
    async function handleAuthSuccess() {
      console.log('Handling successful authentication...');
      
      // Update UI to show loading state
      const loginContainer = document.getElementById('loginContainer');
      const authButton = document.getElementById('authorize_button');
      
      if (authButton) {
        authButton.textContent = 'Loading profile...';
        authButton.disabled = true;
      }
      
      try {
        // Make sure gapi client is initialized with the token
        if (gapi.client && accessToken) {
          console.log('Setting access token for gapi client');
          gapi.client.setToken({ access_token: accessToken });
          
          // Initialize Calendar API if not already done
          if (!gapi.client.calendar) {
            console.log('Loading Calendar API...');
            await new Promise((resolve, reject) => {
              gapi.client.load('calendar', 'v3', resolve);
            });
            console.log('Calendar API loaded successfully');
          } else {
            console.log('Calendar API already loaded');
          }
        } else {
          console.warn('gapi.client not available or missing access token');
        }
        
        // Load user profile and get display name
        console.log('Loading user profile...');
        const displayName = await loadUserProfile();
        console.log('User profile loaded, display name:', displayName);
        
        // Now update the UI to show the app and hide login
        const appLayout = document.getElementById('appLayout');
        
        if (loginContainer) {
          // Start fading out the login container
          loginContainer.style.opacity = '0';
          loginContainer.style.pointerEvents = 'none';
          
          // After fade out, hide it completely and show the app
          setTimeout(() => {
            loginContainer.style.display = 'none';
            
            // Show the app layout with a nice fade-in effect
            if (appLayout) {
              appLayout.style.display = 'flex';
              appLayout.style.opacity = '0';
              
              // Trigger reflow
              void appLayout.offsetHeight;
              
              // Fade in
              appLayout.style.transition = 'opacity 0.5s ease-in-out';
              appLayout.style.opacity = '1';
            }
          }, 300);
        } else if (appLayout) {
          // Fallback if login container is not found
          appLayout.style.display = 'flex';
        }
        
        // Initialize navigation
        console.log('Setting up navigation...');
        setupNavigation();
        
        // Show welcome page by default
        const welcomePage = document.getElementById('welcomePage');
        const chatPage = document.getElementById('chatPage');
        const inputContainer = document.getElementById('inputContainer');
        
        if (welcomePage) welcomePage.style.display = 'block';
        if (chatPage) chatPage.style.display = 'none';
        
        // Update welcome message with user's name
        const welcomeName = document.getElementById('welcomeName');
        if (welcomeName) welcomeName.textContent = displayName || 'User';
        
        // Show and enable input container for chat
        const inputBox = document.getElementById('inputBox');
        const voiceButton = document.getElementById('voiceButton');
        
        if (inputContainer) {
          inputContainer.style.display = 'flex';
          inputContainer.style.opacity = '0';
          
          // Fade in the input container
          setTimeout(() => {
            inputContainer.style.transition = 'opacity 0.5s ease-in-out';
            inputContainer.style.opacity = '1';
          }, 100);
        }
        
        if (inputBox) {
          inputBox.disabled = false;
          
          // Focus the input box with a small delay
          setTimeout(() => {
            inputBox.focus();
            console.log('Input box focused');
          }, 100);
        }
        
        if (voiceButton) voiceButton.disabled = false;
        
        console.log('Authentication flow completed successfully');
        
      } catch (error) {
        console.error('Error in handleAuthSuccess:', error);
        
        // Show error to user
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) {
          const errorMessage = document.createElement('div');
          errorMessage.className = 'error-message';
          errorMessage.style.cssText = 'color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;';
          errorMessage.textContent = `Error initializing the app: ${error.message || 'Unknown error occurred'}`;
          
          loginContainer.appendChild(errorMessage);
          
          // Reset button state
          const authButton = document.getElementById('authorize_button');
          if (authButton) {
            authButton.textContent = 'Sign in with Google';
            authButton.disabled = false;
          }
        } else {
          // Fallback if login container is not found
          alert(`Error initializing the app: ${error.message || 'Unknown error occurred'}`);
        }
        
        // Re-throw the error to be caught by the caller if needed
        throw error;
      }
    // Function to handle user sign out
    function handleSignoutClick() {
      console.log('Handling sign out...');
      
      // Revoke the OAuth token
      const token = gapi.client.getToken();
      if (token && token.access_token) {
        try {
          google.accounts.oauth2.revoke(token.access_token, () => {
            console.log('Token revoked successfully');
          });
        } catch (error) {
          console.warn('Error revoking token:', error);
        }
        
        // Clear the token from gapi client
        gapi.client.setToken(null);
      }
      
      // Clear any stored tokens and reset state
      accessToken = null;
      gapiInited = false;
      gisInited = false;
      
      // Reset UI to logged out state
      const loginContainer = document.getElementById('loginContainer');
      const appLayout = document.getElementById('appLayout');
      const authButton = document.getElementById('authorize_button');
      
      if (loginContainer) {
        loginContainer.style.display = 'flex';
        loginContainer.style.opacity = '1';
        loginContainer.style.pointerEvents = 'auto';
      }
      
      if (appLayout) {
        appLayout.style.display = 'none';
      }
      
      if (authButton) {
        authButton.textContent = 'Sign in with Google';
        authButton.disabled = false;
      }
      
      // Clear any error messages
      const errorMessages = document.querySelectorAll('.error-message');
      errorMessages.forEach(el => el.remove());
      
      // Reset the token client
      tokenClient = null;
      
      console.log('Sign out completed');
      }
      accessToken = null;
      
      // Show login container and hide app layout
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('appLayout').style.display = 'none';
      document.getElementById('authorize_button').style.display = 'inline-block';
      document.getElementById('signout_button').style.display = 'none';
      
      // Hide and disable input container
      const inputContainer = document.getElementById('inputContainer');
      const inputBox = document.getElementById('inputBox');
      const voiceButton = document.getElementById('voiceButton');
      
      if (inputContainer) inputContainer.style.display = 'none';
      if (inputBox) inputBox.disabled = true;
      if (voiceButton) voiceButton.disabled = true;
      
      // Reset chat message
      const msg = document.getElementById('message');
      if (msg) {
        msg.innerHTML = '<strong>🤖 Assistant:</strong><br>You\'ve been signed out. Please sign in to continue.';
      }
    }

    // Demo mode - bypass OAuth for now
    function testButtonClick() {
      console.log('Button clicked!');
      
      // For now, let's enable demo mode so you can see the app working
      const enableDemo = confirm('OAuth setup is complex. Would you like to try DEMO MODE instead?\n\nDemo mode lets you test all features without Google Calendar integration.');
      
      if (enableDemo) {
        // Enable demo mode
        accessToken = 'demo-token';
        
        // Update UI to show connected state
        document.getElementById('authorize_button').style.display = 'none';
        document.getElementById('signout_button').style.display = 'inline-block';
        document.getElementById('inputBox').disabled = false;
        document.getElementById('voiceButton').disabled = false;
        
        const msg = document.getElementById('message');
        msg.innerHTML = '<strong>🤖 Assistant:</strong><br>🎆 <strong>DEMO MODE ACTIVE!</strong><br>You can now test all Smart Scheduler features! Events won\'t be saved to Google Calendar, but you can see how everything works.<br><br>Try saying: "Schedule lunch with mom tomorrow at 1pm"';
        
        return;
      }
      
      // If they want real OAuth, show instructions
      alert('For real Google Calendar integration, you need to:\n\n1. Go to console.cloud.google.com\n2. APIs & Services → Credentials\n3. Edit your OAuth client\n4. Add these URLs:\n   - JavaScript origins: https://smart-scheduler-app.windsurf.build\n   - Redirect URIs: https://smart-scheduler-app.windsurf.build\n\nThen wait 2-3 minutes and try again.');
    }
    
    // Check for access token in URL
    function checkForAccessToken() {
      const hash = window.location.hash;
      if (hash.includes('access_token=')) {
        const params = new URLSearchParams(hash.substring(1));
        const token = params.get('access_token');
        if (token) {
          accessToken = token;
          console.log('Got access token:', token.substring(0, 20) + '...');
          
          // Update UI
          document.getElementById('authorize_button').style.display = 'none';
          document.getElementById('signout_button').style.display = 'inline-block';
          document.getElementById('inputBox').disabled = false;
          document.getElementById('voiceButton').disabled = false;
          
          const msg = document.getElementById('message');
          msg.innerHTML = '<strong>🤖 Assistant:</strong><br>Perfect! I\'m now connected to your Google Calendar. What would you like to schedule?';
          
          // Clear the hash
          window.location.hash = '';
        }
      }
    }

    // Initialize APIs with retry mechanism
    function initializeAPIs() {
      console.log('Page loaded, initializing APIs...');
      
      // Check if Google APIs are available
      if (typeof gapi === 'undefined') {
        console.log('Google API not available yet, retrying in 1 second...');
        setTimeout(initializeAPIs, 1000);
        return;
      }
      
      if (typeof google === 'undefined') {
        console.log('Google Identity Services not available yet, retrying in 1 second...');
        setTimeout(initializeAPIs, 1000);
        return;
      }
      
      // Both APIs are available, initialize them
      gapiLoaded();
      gisLoaded();
    }

    // Initialize Google APIs
    const initGoogleApis = async () => {
      try {
        console.log('Initializing Google APIs...');
        
        // Initialize Google API client
        await initializeGapi();
        
        // Initialize Google Identity Services
        gisLoaded();
        
        // Set up event listeners
        setupNavigation();
        
        // Check for access token in URL (for OAuth redirect)
        checkForAccessToken();
        
        console.log('Google APIs initialized');
      } catch (error) {
        console.error('Error initializing Google APIs:', error);
        showError('Error initializing Google services. Please refresh the page.');
      }
    };

    // View toggle functionality
    function setupViewToggle() {
        const chatViewBtn = document.getElementById('chatViewBtn');
        const previewViewBtn = document.getElementById('previewViewBtn');
        const chatView = document.getElementById('chatView');
        const previewView = document.getElementById('previewView');
        
        if (!chatViewBtn || !previewViewBtn || !chatView || !previewView) return;
        
        // Show chat view by default
        chatView.style.display = 'flex';
        previewView.style.display = 'none';
        
        // Chat view button click handler
        chatViewBtn.addEventListener('click', function() {
            chatView.style.display = 'flex';
            previewView.style.display = 'none';
            chatViewBtn.classList.add('active');
            previewViewBtn.classList.remove('active');
        });
        
        // Preview view button click handler
        previewViewBtn.addEventListener('click', function() {
            chatView.style.display = 'none';
            previewView.style.display = 'block';
            chatViewBtn.classList.remove('active');
            previewViewBtn.classList.add('active');
            updateEventPreview();
        });
    }
    
    // Function to update the event preview
    function updateEventPreview() {
        if (!window.eventDetails) return;
        
        const previewTitle = document.getElementById('previewTitle');
        const previewDateTime = document.getElementById('previewDateTime');
        const previewAttendees = document.getElementById('previewAttendees');
        const previewLocation = document.getElementById('previewLocation');
        const createEventBtn = document.getElementById('createEventBtn');
        
        if (previewTitle) {
            previewTitle.textContent = window.eventDetails.summary || 'No title provided';
        }
        
        if (previewDateTime) {
            const dateTime = window.eventDetails.date && window.eventDetails.time 
                ? `${window.eventDetails.date} at ${window.eventDetails.time}` 
                : 'Not specified';
            previewDateTime.textContent = dateTime;
        }
        
        if (previewAttendees) {
            const attendees = window.eventDetails.attendees || 'Not specified';
            const attendeeEmails = window.eventDetails.attendeeEmails?.length > 0 
                ? ` (${window.eventDetails.attendeeEmails.join(', ')})` 
                : '';
            previewAttendees.textContent = `${attendees}${attendeeEmails}`;
        }
        
        if (previewLocation) {
            previewLocation.textContent = window.eventDetails.location || 'Not specified';
        }
        
        // Enable/disable create event button based on required fields
        if (createEventBtn) {
            const hasRequiredFields = window.eventDetails.date && 
                                   window.eventDetails.time && 
                                   window.eventDetails.attendees && 
                                   window.eventDetails.location;
            createEventBtn.disabled = !hasRequiredFields;
        }
    }
    
    // Make updateEventPreview available globally
    window.updateEventPreview = updateEventPreview;
    
    // Show welcome preview by default
    document.addEventListener('DOMContentLoaded', function() {
        const welcomePreview = document.getElementById('welcomePreview');
        const appLayout = document.getElementById('appLayout');
        const getStartedBtn = document.getElementById('getStartedBtn');
        
        // Show welcome preview initially
        if (welcomePreview) {
            welcomePreview.style.display = 'flex';
            appLayout.style.display = 'none';
        }
        
        // Handle Get Started button click
        if (getStartedBtn) {
            getStartedBtn.addEventListener('click', function() {
                if (welcomePreview) welcomePreview.style.display = 'none';
                if (appLayout) appLayout.style.display = 'flex';
                
                // Trigger Google Sign-In
                const signInBtn = document.getElementById('authorize_button');
                if (signInBtn) signInBtn.click();
            });
        }
    });
    
    // Initialize the app when the page loads
    window.onload = function() {
      console.log('Page loaded, initializing app...');
      
      // Set up view toggle functionality
      setupViewToggle();
      
      // Set up navigation between welcome and chat
      const welcomeBtn = document.getElementById('welcomeBtn');
      const chatBtn = document.getElementById('chatBtn');
      const welcomePage = document.getElementById('welcomePage');
      const chatPage = document.getElementById('chatPage');
      const newEventBtn = document.getElementById('newEventBtn');
      
      if (welcomeBtn && chatBtn && welcomePage && chatPage) {
          welcomeBtn.addEventListener('click', function() {
              welcomePage.classList.add('active');
              chatPage.classList.remove('active');
              welcomeBtn.classList.add('active');
              chatBtn.classList.remove('active');
          });
          
          chatBtn.addEventListener('click', function() {
              welcomePage.classList.remove('active');
              chatPage.classList.add('active');
              welcomeBtn.classList.remove('active');
              chatBtn.classList.add('active');
          });
      }
      
      // Handle New Event button click
      if (newEventBtn && chatBtn) {
          newEventBtn.addEventListener('click', function() {
              // Switch to chat view
              chatBtn.click();
              
              // Focus the input field
              const inputBox = document.getElementById('inputBox');
              if (inputBox) {
                  inputBox.focus();
              }
          });
      }
      
      
      // Set base date for the session
      baseDate = new Date();
      console.log('Base date set to:', baseDate);
      
      // Initialize Google APIs
      initGoogleApis();
      
      // Create floating particles
      createParticles();
      
      // Register Service Worker if available
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('Service Worker registered: ', registration);
          })
          .catch((registrationError) => {
            console.log('Service Worker registration failed: ', registrationError);
          });
      }
      
      // Initialize welcome page functionality
      const getStartedBtn = document.getElementById('getStartedBtn');
      if (getStartedBtn) {
        getStartedBtn.addEventListener('click', function() {
          document.getElementById('welcomeContainer').style.display = 'none';
          document.getElementById('loginContainer').style.display = 'block';
        });
      }
      
      // Handle Back to Welcome from login
      const signOutBtn = document.getElementById('signout_button');
      if (signOutBtn) {
        signOutBtn.addEventListener('click', function() {
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('welcomeContainer').style.display = 'block';
          document.getElementById('appLayout').classList.remove('active');
        });
      }
      
      // Add smooth scrolling to chat
      const chatContainer = document.getElementById('chatContainer');
      if (chatContainer) {
        chatContainer.style.scrollBehavior = 'smooth';
      }
    </script>
    
    <script>
        // View Toggle Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const chatViewBtn = document.getElementById('chatViewBtn');
            const previewViewBtn = document.getElementById('previewViewBtn');
            const chatView = document.getElementById('chatView');
            const previewView = document.getElementById('previewView');
            
            if (chatViewBtn && previewViewBtn && chatView && previewView) {
                // Show chat view by default
                chatView.style.display = 'flex';
                previewView.style.display = 'none';
                
                // Chat view button click handler
                chatViewBtn.addEventListener('click', function() {
                    chatView.style.display = 'flex';
                    previewView.style.display = 'none';
                    chatViewBtn.classList.add('active');
                    previewViewBtn.classList.remove('active');
                });
                
                // Preview view button click handler
                previewViewBtn.addEventListener('click', function() {
                    chatView.style.display = 'none';
                    previewView.style.display = 'block';
                    chatViewBtn.classList.remove('active');
                    previewViewBtn.classList.add('active');
                    updateEventPreview();
                });
                
                // Initialize with chat view active
                chatViewBtn.classList.add('active');
            }
            
            // Auto-resize textarea
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
        });
        
        // Function to update the event preview
        function updateEventPreview() {
            if (!window.eventDetails) return;
            
            const previewTitle = document.getElementById('previewTitle');
            const previewDateTime = document.getElementById('previewDateTime');
            const previewAttendees = document.getElementById('previewAttendees');
            const previewLocation = document.getElementById('previewLocation');
            const createEventBtn = document.getElementById('createEventBtn');
            
            if (previewTitle) {
                previewTitle.textContent = window.eventDetails.summary || 'No title provided';
            }
            
            if (previewDateTime) {
                const dateTime = window.eventDetails.date && window.eventDetails.time 
                    ? `${window.eventDetails.date} at ${window.eventDetails.time}` 
                    : 'Not specified';
                previewDateTime.textContent = dateTime;
            }
            
            if (previewAttendees) {
                const attendees = window.eventDetails.attendees || 'Not specified';
                const attendeeEmails = window.eventDetails.attendeeEmails?.length > 0 
                    ? ` (${window.eventDetails.attendeeEmails.join(', ')})` 
                    : '';
                previewAttendees.textContent = `${attendees}${attendeeEmails}`;
            }
            
            if (previewLocation) {
                previewLocation.textContent = window.eventDetails.location || 'Not specified';
            }
            
            // Enable/disable create event button based on required fields
            if (createEventBtn) {
                const hasRequiredFields = window.eventDetails.date && 
                                       window.eventDetails.time && 
                                       window.eventDetails.attendees && 
                                       window.eventDetails.location;
                createEventBtn.disabled = !hasRequiredFields;
            }
        }
        
        // Make updateEventPreview available globally
        window.updateEventPreview = updateEventPreview;
    </script>
</body>
</html>