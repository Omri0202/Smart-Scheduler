<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Smart Scheduler</title>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        body, html {
          margin: 0;
          padding: 0;
          font-family: Arial, sans-serif;
          height: 100%;
          background: white;
          color: black;
          transition: background-color 0.3s, color 0.3s;
        }

        #container {
          background: rgba(0, 0, 0, 0.03);
          max-width: 4000px;
          padding: 30px;
          border-radius: 15px;
          box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
          text-align: center;
          position: absolute;
          top: 50%;
          right: 40%;
          transform: translateY(-50%);
        }

        #logo {
          width: 80px;
          margin-bottom: 10px;
        }

        #name {
        width: 80px;
          top: 20px;
          right: 100px;
          background: rgba(0, 0, 0, 0.05);
          padding: 8px 12px;
          border-radius: 8px;
          font-weight: bold;
        }

        h2 {
          margin: 10px 0 20px;
        }

        input[type="text"] {
          width: 100%;
          padding: 12px;
          margin-top: 15px;
          font-size: 16px;
          border-radius: 8px;
          border: 2px solid #555;
        }

        button {
          margin-top: 15px;
          padding: 12px 20px;
          font-size: 16px;
          border-radius: 8px;
          border: none;
          background: #007BFF;
          color: white;
          cursor: pointer;
        }

        button:hover {
          background: #0056b3;
        }

        #message {
          margin-top: 15px;
          min-height: 30px;
        }

        #darkToggle {
          position: fixed;
          top: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.05);
          padding: 8px 12px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: bold;
        }

        .dark {
          background: #121212;
          color: white;
        }

        .dark #container {
          background: #1e1e1e;
        }

        .dark input,
        .dark button {
          background: #333;
          color: white;
        }

        .dark #darkToggle {
          background: rgba(255, 255, 255, 0.1);
          color: #00aaff;
        }

        #speechBtn {
          margin-left: 10px;
          padding: 10px 16px;
          border-radius: 50%;
          background: #28a745;
          color: white;
          border: none;
          cursor: pointer;
        }

        #speechBtn:hover {
          background: #1c7c33;
        }
    </style>
</head>
<body>
<div id="darkToggle">Toggle Dark Mode</div>

<div id="container">
    <img src="https://cdn-icons-png.flaticon.com/512/2784/2784445.png" id="logo" alt="Logo" />
    <input type="text" id="name" placeholder="Smart Scheduler" disabled />
    <h2>Let me plan your schedule</h2>
    <input type="text" id="inputBox" placeholder="What are your plans?" disabled />
    <button id="speechBtn">Speech to text üé§</button>
    <div id="message">Please sign in to get started.</div>
    <button id="authorize_button" style="display:none;">Authorize Google Calendar</button>
    <button id="signout_button" style="display:none;">Sign Out</button>
</div>

<script>
    const CLIENT_ID = '251900786787-rs2a373jkaetk9lmh49nch3tq5p3lnhp.apps.googleusercontent.com';
    const TOGETHER_API_KEY = '1e60c638e6c99899e27a3bec16b056dfd8fc1e5cace56a9c09e3a324f0de8f39';

    const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

    let tokenClient, accessToken = null;
    let gapiInited = false, gisInited = false;

    const authBtn = document.getElementById('authorize_button');
    const signOutBtn = document.getElementById('signout_button');
    const inputBox = document.getElementById('inputBox');
    const msg = document.getElementById('message');
    const darkToggle = document.getElementById('darkToggle');
    const speechBtn = document.getElementById('speechBtn');

    darkToggle.onclick = () => document.body.classList.toggle('dark');

    function gapiLoaded() {
      gapi.load('client', async () => {
        await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
        gapiInited = true;
        enableAuth();
      });
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
      enableAuth();
    }

    function enableAuth() {
      if (gapiInited && gisInited) authBtn.style.display = 'inline-block';
    }

    authBtn.onclick = () => {
      tokenClient.callback = (resp) => {
        if (resp.error) return msg.textContent = 'Auth error: ' + resp.error;
        accessToken = resp.access_token;
        msg.textContent = '‚úÖ Authorized! Type your plan.';
        inputBox.disabled = false;
        authBtn.style.display = 'none';
        signOutBtn.style.display = 'inline-block';
      };
      tokenClient.requestAccessToken();
    };

    signOutBtn.onclick = () => {
      google.accounts.oauth2.revoke(accessToken);
      accessToken = null;
      inputBox.value = '';
      inputBox.disabled = true;
      msg.textContent = 'Signed out.';
      authBtn.style.display = 'inline-block';
      signOutBtn.style.display = 'none';
    };

    async function sendToLLM(text) {
      const body = {
        model: "mistralai/Mixtral-8x7B-Instruct-v0.1",
        messages: [
          { role: "system", content: "You are an assistant that helps users plan their schedule. Ask follow-up questions and suggest options based on their message." },
          { role: "user", content: text }
        ],
        max_tokens: 300,
        temperature: 0.7
      };

      const response = await fetch("https://api.together.xyz/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${TOGETHER_API_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      const data = await response.json();
      return data.choices?.[0]?.message?.content || "I couldn't understand that.";
    }

    async function createEvent(summary, dateTime) {
      const endDate = new Date(dateTime.getTime() + 60 * 60 * 1000);
      const event = {
        summary,
        start: { dateTime: dateTime.toISOString(), timeZone: 'UTC' },
        end: { dateTime: endDate.toISOString(), timeZone: 'UTC' }
      };
      const res = await gapi.client.calendar.events.insert({
        calendarId: 'primary',
        resource: event
      });
      return res.result.htmlLink;
    }

    inputBox.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;
      const text = inputBox.value.trim();
      if (!text) return;

      msg.textContent = 'ü§ñ Thinking...';
      const reply = await sendToLLM(text);
      msg.innerHTML = `<strong>ü§ñ Assistant:</strong><br>${reply.replace(/\n/g, '<br>')}`;
      inputBox.value = '';
    });

    speechBtn.onclick = () => {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();
      msg.textContent = "üéôÔ∏è Listening...";

      recognition.onresult = async (event) => {
        const speechText = event.results[0][0].transcript;
        inputBox.value = speechText;
        msg.textContent = "üìù You said: " + speechText;
        const reply = await sendToLLM(speechText);
        msg.innerHTML = `<strong>ü§ñ Assistant:</strong><br>${reply.replace(/\n/g, '<br>')}`;
        inputBox.value = '';
      };

      recognition.onerror = (event) => {
        msg.textContent = '‚ùå Speech error: ' + event.error;
      };
    };

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
</script>
</body>
</html>
