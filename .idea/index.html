<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Smart Scheduler</title>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: white;
            color: black;
            height: 100%;
        }

        #darkToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.05);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .dark {
            background: #121212;
            color: white;
        }

        .dark #container {
            background: #1e1e1e;
        }

        .dark input,
        .dark button {
            background: #333;
            color: white;
        }

        .dark #darkToggle {
            background: rgba(255, 255, 255, 0.1);
            color: #00aaff;
        }

        #container {
            display: flex;
            flex-direction: column;
            max-width: 500px;
            padding: 30px;
            margin: 50px auto;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            background: rgba(0, 0, 0, 0.03);
        }

        #logo {
            width: 100px;
            margin: 0 auto 15px;
            border-radius: 8px;
        }

        h2 {
            margin: 10px 0 20px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            margin-top: 15px;
            border-radius: 8px;
            border: 2px solid #555;
        }

        button {
            margin-top: 15px;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            background: #007BFF;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        #speechBtn {
            margin-left: 10px;
            padding: 10px 16px;
            border-radius: 50%;
            background: #28a745;
            color: white;
            border: none;
            cursor: pointer;
        }

        #speechBtn:hover {
            background: #1c7c33;
        }

        #message {
            margin-top: 20px;
            min-height: 40px;
        }
    </style>
</head>
<body>
<div id="darkToggle">Toggle Dark Mode</div>

<div id="container">
    <img src="https://cdn-icons-png.flaticon.com/512/3652/3652191.png" id="logo" alt="Logo" />
    <h2>Let me plan your schedule</h2>
    <input type="text" id="inputBox" placeholder="What are your plans?" disabled />
    <button id="speechBtn">🎤</button>
    <div id="message">Please sign in to get started.</div>
    <button id="authorize_button" style="display:none;">Authorize Google Calendar</button>
    <button id="signout_button" style="display:none;">Sign Out</button>
</div>

<script>
    const CLIENT_ID = '251900786787-rs2a373jkaetk9lmh49nch3tq5p3lnhp.apps.googleusercontent.com';
    const TOGETHER_API_KEY = '1e60c638e6c99899e27a3bec16b056dfd8fc1e5cace56a9c09e3a324f0de8f39';

    const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

    let tokenClient, accessToken = null;
    let gapiInited = false, gisInited = false;

    const authBtn = document.getElementById('authorize_button');
    const signOutBtn = document.getElementById('signout_button');
    const inputBox = document.getElementById('inputBox');
    const msg = document.getElementById('message');
    const darkToggle = document.getElementById('darkToggle');
    const speechBtn = document.getElementById('speechBtn');

    darkToggle.onclick = () => document.body.classList.toggle('dark');

    let conversationState = {
      activity: null,
      time: null,
      date: null,
      person: null,
      inviteEmail: null,
      askedEmail: false,
      confirmedNoInvite: false
    };

    function gapiLoaded() {
      gapi.load('client', async () => {
        await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
        gapiInited = true;
        enableAuth();
      });
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '',
      });
      gisInited = true;
      enableAuth();
    }

    function enableAuth() {
      if (gapiInited && gisInited) authBtn.style.display = 'inline-block';
    }

    authBtn.onclick = () => {
      tokenClient.callback = (resp) => {
        if (resp.error) return msg.textContent = 'Auth error: ' + resp.error;
        accessToken = resp.access_token;
        msg.textContent = '✅ Authorized! Type your plan.';
        inputBox.disabled = false;
        authBtn.style.display = 'none';
        signOutBtn.style.display = 'inline-block';
      };
      tokenClient.requestAccessToken();
    };

    signOutBtn.onclick = () => {
      google.accounts.oauth2.revoke(accessToken);
      accessToken = null;
      inputBox.value = '';
      inputBox.disabled = true;
      msg.textContent = 'Signed out.';
      authBtn.style.display = 'inline-block';
      signOutBtn.style.display = 'none';
      resetConversation();
    };

    function resetConversation() {
      conversationState = {
        activity: null,
        time: null,
        date: null,
        person: null,
        inviteEmail: null,
        askedEmail: false,
        confirmedNoInvite: false
      };
    }

    async function sendToLLM(text) {
      const messages = [
        { role: "system", content: "You help schedule events. Extract date, time, activity, and people mentioned." },
        { role: "user", content: text }
      ];

      const body = {
        model: "mistralai/Mixtral-8x7B-Instruct-v0.1",
        messages,
        max_tokens: 300,
        temperature: 0.7
      };

      const response = await fetch("https://api.together.xyz/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${TOGETHER_API_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      const data = await response.json();
      return data.choices?.[0]?.message?.content || "I couldn't understand that.";
    }

    async function createEvent(summary, dateTime, attendees = []) {
      const endDate = new Date(dateTime.getTime() + 60 * 60 * 1000);
      const event = {
        summary,
        start: { dateTime: dateTime.toISOString(), timeZone: 'UTC' },
        end: { dateTime: endDate.toISOString(), timeZone: 'UTC' },
        attendees: attendees.map(email => ({ email }))
      };
      const res = await gapi.client.calendar.events.insert({
        calendarId: 'primary',
        resource: event
      });
      return res.result.htmlLink;
    }

    function tryAutoSchedule() {
      const { activity, time, date, person, inviteEmail, confirmedNoInvite } = conversationState;

      if (activity && time && date && (!person || inviteEmail || confirmedNoInvite)) {
        const dateTime = new Date(`${date}T${time}`);
        const attendees = inviteEmail ? [inviteEmail] : [];

        createEvent(activity, dateTime, attendees).then(link => {
          msg.innerHTML = `📅 Event created! <a href="${link}" target="_blank">View in Calendar</a>`;
          resetConversation();
        });
      }
    }

    inputBox.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;
      const text = inputBox.value.trim();
      if (!text) return;

      msg.textContent = '🤖 Thinking...';
      inputBox.disabled = true;

      // Handle email for invite
      if (conversationState.person && conversationState.askedEmail && !conversationState.inviteEmail && !conversationState.confirmedNoInvite) {
        if (text.toLowerCase().includes("no")) {
          conversationState.confirmedNoInvite = true;
          msg.textContent = 'Okay, not inviting anyone.';
        } else if (text.includes("@")) {
          conversationState.inviteEmail = text.trim();
          msg.textContent = 'Got the email!';
        } else {
          msg.textContent = 'Please enter a valid email or say no.';
        }
        inputBox.value = '';
        inputBox.disabled = false;
        tryAutoSchedule();
        return;
      }

      const reply = await sendToLLM(text);

      // Extract info with simple regex (for demo — you can improve)
      if (!conversationState.time) {
        const timeMatch = text.match(/\b\d{1,2}(:\d{2})?\s*(AM|PM|am|pm)?\b/);
        if (timeMatch) conversationState.time = convertTo24Hour(timeMatch[0]);
      }

      if (!conversationState.date) {
        const today = new Date();
        if (text.toLowerCase().includes("tomorrow")) {
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          conversationState.date = tomorrow.toISOString().split("T")[0];
        } else if (text.toLowerCase().includes("today")) {
          conversationState.date = today.toISOString().split("T")[0];
        } else {
          const dateMatch = text.match(/\b\d{4}-\d{2}-\d{2}\b/);
          if (dateMatch) conversationState.date = dateMatch[0];
        }
      }

      if (!conversationState.activity) {
        conversationState.activity = text;
      }

      if (!conversationState.person) {
        if (/my (mom|dad|sister|brother|friend)/i.test(text)) {
          conversationState.person = RegExp.$1;
          msg.textContent = `Do you want to invite your ${conversationState.person}? If yes, please enter their email.`;
          conversationState.askedEmail = true;
          inputBox.value = '';
          inputBox.disabled = false;
          return;
        }
      }

      msg.innerHTML = `<strong>🤖 Assistant:</strong><br>${reply.replace(/\n/g, '<br>')}`;
      inputBox.value = '';
      inputBox.disabled = false;

      tryAutoSchedule();
    });

    function convertTo24Hour(timeStr) {
      let [hour, min] = timeStr.split(/[: ]/);
      min = min || "00";
      const ampm = timeStr.toLowerCase().includes("pm") ? "PM" : "AM";

      hour = parseInt(hour);
      if (ampm === "PM" && hour < 12) hour += 12;
      if (ampm === "AM" && hour === 12) hour = 0;

      return `${hour.toString().padStart(2, '0')}:${min}`;
    }

    speechBtn.onclick = () => {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();
      msg.textContent = "🎙️ Listening...";

      recognition.onresult = async (event) => {
        inputBox.value = event.results[0][0].transcript;
        inputBox.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
      };

      recognition.onerror = (event) => {
        msg.textContent = '❌ Speech error: ' + event.error;
      };
    };

    window.onload = () => {
      gapiLoaded();
      gisLoaded();
    };
</script>
</body>
</html>
