<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Smart Scheduler</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: black;
            transition: background-color 0.3s, color 0.3s;
        }
        
        #cornerText {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 12px 18px;
            font-weight: bold;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        #auth_buttons {
            margin: 20px 0;
            text-align: center;
        }

        #signin_button, #signout_button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #signin_button:hover, #signout_button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #signout_button {
            background: #ea4335;
        }

        #container {
            background: rgba(255,255,255,0.95);
            max-width: 600px;
            margin: 5% auto 0;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            min-height: 60vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        #inputContainer {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            display: flex;
            gap: 12px;
            align-items: center;
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        input[type="text"] {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            outline: none;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            border-color: #667eea;
        }
        
        button {
            padding: 15px 25px;
            font-size: 16px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #voiceButton {
            padding: 15px;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        #voiceButton:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        #voiceButton.recording {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #message {
            margin-top: 20px;
            min-height: 40px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }
        
        #darkToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        #darkToggle:hover {
            background: rgba(255,255,255,1);
            transform: translateY(-2px);
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .error-popup {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            color: #b71c1c;
            font-size: 14px;
            animation: slideIn 0.3s ease-out;
        }
        
        .success-popup {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            color: #1b5e20;
            font-size: 14px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .info {
            color: #007bff;
            font-weight: bold;
        }
        
        body.dark {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 100%);
            color: white;
        }
        
        body.dark #container { 
            background: rgba(30, 30, 30, 0.95); 
            color: white; 
        }
        
        body.dark #inputContainer {
            background: rgba(30, 30, 30, 0.95);
        }
        
        body.dark input[type="text"] { 
            background: #333; 
            color: white; 
            border-color: #555;
        }
        
        body.dark #cornerText, body.dark #darkToggle {
            background: rgba(30, 30, 30, 0.9);
            color: #00aaff;
        }

        h2 {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }

        body.dark h2 {
            background: linear-gradient(45deg, #00aaff, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-indicator {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 14px;
            text-align: left;
        }

        body.dark .progress-indicator {
            background: rgba(0, 170, 255, 0.1);
            border-left-color: #00aaff;
        }

        .demo-note {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }

        .event-summary {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }

        body.dark .demo-note {
            background: rgba(255, 193, 7, 0.2);
        }

        body.dark .event-summary {
            background: rgba(40, 167, 69, 0.2);
        }
    </style>
</head>
<body>
    <div id="cornerText">let me plan your schedule</div>
    <div id="darkToggle">🌙 Toggle Dark Mode</div>

    <div id="container">
        <h2>Smart Scheduler</h2>
        <div id="auth_buttons">
            <button id="signin_button" onclick="handleAuthClick()">Sign in with Google</button>
            <button id="signout_button" onclick="handleSignoutClick()" style="display: none;">Sign Out</button>
        </div>
        
        <div class="demo-note">
            <strong>📋 Demo Mode</strong><br>
            This is a demonstration of the Smart Scheduler interface. In the full version, it would connect to Google Calendar and Together AI. Try typing scheduling requests below to see how the AI assistant works!
        </div>
        
        <div id="message">
            <span class="info">🤖 AI Assistant ready!</span><br>
            Try typing something like: "Meeting with mom tomorrow at 2 PM at the coffee shop"
        </div>
        
        <div id="eventsList"></div>
    </div>
    
    <div id="inputContainer">
        <input type="text" id="inputBox" placeholder="What are your plans? (e.g., 'Dentist appointment next Monday at 10 AM')" />
        <button id="voiceButton" title="Voice input (if supported)">🎤</button>
    </div>

    <script>
        // Google API Configuration for Local Development
        const GOOGLE_CONFIG = {
            apiKey: 'AIzaSyBq1W8rv77mcFyZqYbsrEBJxYm6nvpdxcQ',
            clientId: '251900786787-rs2a373jkaetk9lmh49nch3tq5p3lnhp.apps.googleusercontent.com',
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
            scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar',
            
            // OAuth configuration for local development
            redirect_uri: 'http://localhost:5173',
            ux_mode: 'popup',
            prompt: 'consent',
            access_type: 'offline',
            response_type: 'code',
            include_granted_scopes: true,
        };

        // Google API state
        let gapiInited = false;
        let gisInited = false;

        // Initialize Google API client
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: GOOGLE_CONFIG.apiKey,
                    discoveryDocs: GOOGLE_CONFIG.discoveryDocs,
                });
                gapiInited = true;
                maybeEnableButtons();
                checkAuthStatus();
            } catch (error) {
                console.error('Error initializing Google API client:', error);
            }
        }

        function gisLoaded() {
            gisInited = true;
            maybeEnableButtons();
            checkAuthStatus();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('signin_button').style.display = 'inline-block';
            }
        }

        // Check if user is already signed in
        function checkAuthStatus() {
            const token = localStorage.getItem('google_token');
            if (token && gapiInited && gapi.client && gapi.client.setToken) {
                try {
                    gapi.client.setToken(JSON.parse(token));
                    updateSigninStatus(true);
                } catch (error) {
                    console.error('Error setting token in checkAuthStatus:', error);
                    localStorage.removeItem('google_token');
                }
            }
        }

        // Handle Google Sign-in with improved error handling
        async function handleAuthClick() {
            try {
                // Clear any existing tokens first
                localStorage.removeItem('google_token');
                
                // Create token client
                const tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CONFIG.clientId,
                    scope: GOOGLE_CONFIG.scope,
                    prompt: 'consent',
                    ux_mode: 'popup',
                    callback: (response) => {
                        if (response && response.error) {
                            console.error('Auth error:', response.error);
                            showError('Authentication error. Please try again.');
                            return;
                        }
                        
                        if (response && response.access_token) {
                            // Store the token with expiration
                            const tokenData = {
                                ...response,
                                expires_at: Date.now() + (response.expires_in * 1000)
                            };
                            
                            localStorage.setItem('google_token', JSON.stringify(tokenData));
                            gapi.client.setToken(response);
                            updateSigninStatus(true);
                            document.getElementById('inputBox').disabled = false;
                            showSuccess('Successfully signed in!');
                            
                            // Don't redirect - stay on the same page
                            console.log('Authentication completed successfully');
                        }
                    }
                });

                // Request token - this will redirect to Google's OAuth page
                tokenClient.requestAccessToken();
                
            } catch (error) {
                console.error('Auth initialization error:', error);
                showError('Failed to initialize authentication. Please refresh the page and try again.');
            }
        }

        // Helper function to show error messages
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-popup';
            errorDiv.textContent = message;
            document.getElementById('message').prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Helper function to show success messages
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-popup';
            successDiv.textContent = message;
            document.getElementById('message').prepend(successDiv);
            setTimeout(() => successDiv.remove(), 5000);
        }

        // Handle Sign-out with cleanup
        function handleSignoutClick() {
            try {
                const token = gapi.client.getToken();
                if (token) {
                    google.accounts.oauth2.revoke(token.access_token, () => {
                        console.log('Token revoked');
                    });
                    gapi.client.setToken(null);
                }
                localStorage.removeItem('google_token');
                updateSigninStatus(false);
                showSuccess('Successfully signed out');
            } catch (error) {
                console.error('Sign out error:', error);
                // Force clear everything even if there was an error
                localStorage.removeItem('google_token');
                updateSigninStatus(false);
            }
        }

        // Update UI based on sign-in status
        function updateSigninStatus(isSignedIn) {
            const signinBtn = document.getElementById('signin_button');
            const signoutBtn = document.getElementById('signout_button');
            const inputBox = document.getElementById('inputBox');
            
            if (isSignedIn) {
                signinBtn.style.display = 'none';
                signoutBtn.style.display = 'inline-block';
                inputBox.disabled = false;
                document.getElementById('message').innerHTML = '<span class="success">✅ Successfully signed in! You can now create events.</span>';
            } else {
                signinBtn.style.display = 'inline-block';
                signoutBtn.style.display = 'none';
                inputBox.disabled = true;
                document.getElementById('message').innerHTML = '<span class="info">Please sign in to create events.</span>';
            }
        }

        // Create Google Calendar Event
        async function createCalendarEvent(eventDetails) {
            try {
                const event = {
                    'summary': eventDetails.title || 'New Event',
                    'location': eventDetails.location || '',
                    'description': 'Created with Smart Scheduler',
                    'start': {
                        'dateTime': eventDetails.fullDateTime.toISOString(),
                        'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    'end': {
                        'dateTime': new Date(eventDetails.fullDateTime.getTime() + 60 * 60 * 1000).toISOString(),
                        'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    'reminders': {
                        'useDefault': true
                    }
                };

                const response = await gapi.client.calendar.events.insert({
                    'calendarId': 'primary',
                    'resource': event
                });
                
                console.log('Event created:', response);
                return response;
            } catch (error) {
                console.error('Error creating event:', error);
                throw error;
            }
        }
        // Demo configuration
        const DEMO_MODE = true;
        
        let chatHistory = [];
        let questionCount = 0;
        let baseDate = new Date();
        let eventDetails = {
            date: null,
            time: null,
            attendees: null,
            location: null,
            title: null
        };
        let createdEvents = [];

        // DOM elements
        const inputBox = document.getElementById('inputBox');
        const msg = document.getElementById('message');
        const darkToggle = document.getElementById('darkToggle');
        const voiceButton = document.getElementById('voiceButton');
        const eventsList = document.getElementById('eventsList');

        // Voice recognition setup
        let recognition = null;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                voiceButton.classList.add('recording');
                voiceButton.textContent = '🔴';
                voiceButton.title = 'Listening...';
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                inputBox.value = transcript;
                processInput();
            };
            
            recognition.onend = () => {
                voiceButton.classList.remove('recording');
                voiceButton.textContent = '🎤';
                voiceButton.title = 'Voice input';
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                voiceButton.classList.remove('recording');
                voiceButton.textContent = '🎤';
                voiceButton.title = 'Voice input (error occurred)';
            };
        } else {
            voiceButton.style.display = 'none';
        }

        // Dark mode toggle
        darkToggle.onclick = () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            darkToggle.textContent = isDark ? '☀️ Toggle Light Mode' : '🌙 Toggle Dark Mode';
        };

        // Voice button click handler
        voiceButton.onclick = () => {
            if (recognition && !inputBox.disabled) {
                recognition.start();
            }
        };

        function getMissingInfo() {
            const missing = [];
            if (!eventDetails.date) missing.push('date/day');
            if (!eventDetails.time) missing.push('time');
            if (!eventDetails.attendees) missing.push('who is attending');
            if (!eventDetails.location) missing.push('location');
            return missing;
        }

        function parseDateTime(dateStr, timeStr) {
            if (!dateStr || !timeStr) return null;
            
            let targetDate = new Date(baseDate);
            
            const dateLower = dateStr.toLowerCase();
            if (dateLower === 'today') {
                targetDate = new Date(baseDate);
            } else if (dateLower === 'tomorrow') {
                targetDate = new Date(baseDate.getTime() + 24 * 60 * 60 * 1000);
            } else if (dateLower.startsWith('next ')) {
                const day = dateLower.replace('next ', '');
                const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const targetDay = days.indexOf(day);
                if (targetDay !== -1) {
                    const currentDay = baseDate.getDay();
                    let daysToAdd = targetDay - currentDay;
                    if (daysToAdd <= 0) daysToAdd += 7;
                    targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
                }
            } else {
                const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                if (days.includes(dateLower)) {
                    const targetDay = days.indexOf(dateLower);
                    if (targetDay !== -1) {
                        const currentDay = baseDate.getDay();
                        let daysToAdd = targetDay - currentDay;
                        if (daysToAdd <= 0) daysToAdd += 7;
                        targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
                    }
                }
            }
            
            const timeLower = timeStr.toLowerCase();
            let hours = 0, minutes = 0;
            
            const timeMatch = timeLower.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)?/);
            if (timeMatch) {
                hours = parseInt(timeMatch[1]);
                minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
                
                if (timeMatch[3]) {
                    const isPM = timeMatch[3] === 'pm';
                    if (isPM && hours !== 12) hours += 12;
                    if (!isPM && hours === 12) hours = 0;
                }
            }
            
            targetDate.setHours(hours, minutes, 0, 0);
            return targetDate;
        }

        function updateEventDetails(userInput) {
            const input = userInput.toLowerCase();
            
            // Extract title/activity
            if (!eventDetails.title) {
                const titlePatterns = [
                    /(meeting|appointment|lunch|dinner|call|interview|workout|class)/i,
                    /(dentist|doctor|bank|shopping|groceries)/i
                ];
                
                for (const pattern of titlePatterns) {
                    const match = userInput.match(pattern);
                    if (match) {
                        eventDetails.title = match[0];
                        break;
                    }
                }
            }
            
            if (!eventDetails.date) {
                const datePatterns = [
                    /(today|tomorrow|next \w+|this \w+)/i,
                    /(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/i,
                ];
                
                for (const pattern of datePatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        eventDetails.date = match[0];
                        break;
                    }
                }
                
                if (!eventDetails.date) {
                    eventDetails.date = 'today';
                }
            }
            
            if (!eventDetails.time) {
                const timePatterns = [
                    /(\d{1,2}:\d{2}\s*(am|pm))/i,
                    /(\d{1,2}\s*(am|pm))/i,
                    /(\d{1,2}:\d{2})/,
                    /(\d{1,2}\s*o'clock)/i,
                ];
                
                for (const pattern of timePatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        eventDetails.time = match[0];
                        break;
                    }
                }
            }
            
            if (!eventDetails.attendees) {
                const attendeePatterns = [
                    /(with )?(myself|me|i|alone)/i,
                    /(with )?(mom|mother|dad|father|brother|sister|family)/i,
                    /(with )?(friend|friends|colleague|colleagues|team)/i,
                ];
                
                for (const pattern of attendeePatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        eventDetails.attendees = match[0].replace('with ', '');
                        break;
                    }
                }
            }
            
            if (!eventDetails.location) {
                const locationPatterns = [
                    /(at|in|to)\s+(\w+\s*\w*)/i,
                    /(bank|home|office|school|hospital|restaurant|cafe|store|mall|park|gym|library|church|airport|coffee\s*shop)/i,
                ];
                
                for (const pattern of locationPatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        eventDetails.location = match[1] || match[0];
                        if (eventDetails.location.startsWith('at ') || 
                            eventDetails.location.startsWith('in ') || 
                            eventDetails.location.startsWith('to ')) {
                            eventDetails.location = eventDetails.location.substring(3);
                        }
                        break;
                    }
                }
            }
        }

        async function generateAIResponse(text) {
            // Simulate AI response based on missing information
            const missing = getMissingInfo();
            
            if (missing.length === 0) {
                return "Perfect! I have all the information I need. Let me create that event for you.";
            }
            
            const responses = {
                'date/day': [
                    "What day would you like to schedule this?",
                    "When would you like this to happen?",
                    "Which day works best for you?"
                ],
                'time': [
                    `What time on ${eventDetails.date || 'that day'}?`,
                    "What time would work best?",
                    "At what time should I schedule this?"
                ],
                'who is attending': [
                    "Who will be attending this event?",
                    "Will this be just for you, or will others join?",
                    "Who should I include in this event?"
                ],
                'location': [
                    "Where will this take place?",
                    "What's the location for this event?",
                    "Where should I set this to happen?"
                ]
            };
            
            const missingItem = missing[0];
            const possibleResponses = responses[missingItem] || ["Could you provide more details?"];
            const response = possibleResponses[Math.floor(Math.random() * possibleResponses.length)];
            
            return response;
        }

        function createEventSummary() {
            const title = eventDetails.title || 'Event';
            const dateTime = parseDateTime(eventDetails.date, eventDetails.time);
            const dateStr = dateTime ? dateTime.toLocaleDateString() : eventDetails.date;
            const timeStr = dateTime ? dateTime.toLocaleTimeString() : eventDetails.time;
            
            return {
                title: `${title} - ${eventDetails.attendees} at ${eventDetails.location}`,
                date: dateStr,
                time: timeStr,
                location: eventDetails.location,
                attendees: eventDetails.attendees,
                fullDateTime: dateTime
            };
        }

        function displayEvent(event) {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-summary';
            eventDiv.innerHTML = `
                <h4>📅 ${event.title}</h4>
                <p><strong>📅 Date:</strong> ${event.date}</p>
                <p><strong>🕐 Time:</strong> ${event.time}</p>
                <p><strong>📍 Location:</strong> ${event.location}</p>
                <p><strong>👥 Attendees:</strong> ${event.attendees}</p>
                <small><em>In the full version, this would be added to Google Calendar</em></small>
            `;
            
            eventsList.appendChild(eventDiv);
        }

        function resetSession() {
            questionCount = 0;
            chatHistory = [];
            eventDetails = { date: null, time: null, attendees: null, location: null, title: null };
            inputBox.disabled = false;
        }

        async function processInput() {
            const text = inputBox.value.trim();
            if (!text) return;

            // Check if user is signed in
            const token = localStorage.getItem('google_token');
            if (!token) {
                msg.innerHTML = '<span class="error">❌ Please sign in to create events.</span>';
                handleAuthClick();
                return;
            }

            msg.innerHTML = '<span class="info">🤖 Processing...</span>';
            inputBox.value = '';
            inputBox.disabled = true;
            questionCount++;
            
            // Update event details with user input
            updateEventDetails(text);
            
            const hasAllInfo = eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location;
            
            if (hasAllInfo) {
                try {
                    const event = createEventSummary();
                    // Create event in Google Calendar
                    const googleEvent = await createCalendarEvent(event);
                    createdEvents.push(event);
                    displayEvent(event);
                    
                    msg.innerHTML = `
                        <span class="success">✅ Event created successfully in Google Calendar!</span>
                        <div style="margin-top: 10px;">
                            <a href="${googleEvent.result.htmlLink}" target="_blank" style="color: #4285f4; text-decoration: none;">
                                View in Google Calendar
                            </a>
                        </div>
                        <br>Ready for your next event.`;
                } catch (error) {
                    console.error('Error creating event:', error);
                    msg.innerHTML = `
                        <span class="error">❌ Error creating event in Google Calendar.</span>
                        <div style="margin-top: 10px; color: #666; font-size: 14px;">
                            ${error.result ? error.result.error.message : 'Please try again.'}
                        </div>`;
                }
                resetSession();
                return;
            }
            
            // Generate AI response for missing information
            const aiResponse = await generateAIResponse(text);
            
            // Show progress
            const gatheredInfo = [
                eventDetails.title && `📋 ${eventDetails.title}`,
                eventDetails.date && `📅 ${eventDetails.date}`,
                eventDetails.time && `🕐 ${eventDetails.time}`,
                eventDetails.attendees && `👥 ${eventDetails.attendees}`,
                eventDetails.location && `📍 ${eventDetails.location}`
            ].filter(Boolean);
            
            const progressHTML = gatheredInfo.length > 0 
                ? `<div class="progress-indicator">
                     <strong>Gathered so far:</strong><br>${gatheredInfo.join('<br>')}
                   </div>` 
                : '';
            
            msg.innerHTML = `
                <strong>🤖 AI Assistant:</strong><br>
                ${aiResponse}
                ${progressHTML}
            `;
            
            inputBox.disabled = false;
        }

        // Event listeners
        inputBox.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                processInput();
            }
        });

        // Handle OAuth response when redirected back
        function handleOAuthResponse() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');
            
            if (error) {
                showError(`Authentication error: ${error}`);
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            if (code) {
                // We'll handle the code exchange in the background
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Initialize with better error handling
        window.onload = async () => {
            baseDate = new Date();
            console.log('Smart Scheduler loaded');
            
            try {
                // Initialize Google APIs
                gapiLoaded();
                gisLoaded();
                
                // Handle OAuth redirect
                handleOAuthResponse();
                
                // Check if we have a stored token
                const token = localStorage.getItem('google_token');
                if (token && gapiInited) {
                    try {
                        const tokenData = JSON.parse(token);
                        // Check if token is expired (with 5-minute buffer)
                        if (tokenData.expires_at > (Date.now() + 300000)) {
                            if (gapi.client && gapi.client.setToken) {
                                gapi.client.setToken(tokenData);
                                updateSigninStatus(true);
                                console.log('User is still signed in');
                            } else {
                                console.warn('GAPI client not ready, will retry token setup...');
                                // Retry after APIs are loaded
                                setTimeout(() => {
                                    if (gapi.client && gapi.client.setToken) {
                                        gapi.client.setToken(tokenData);
                                        updateSigninStatus(true);
                                        console.log('User signed in (delayed)');
                                    }
                                }, 1000);
                            }
                        } else {
                            console.log('Token expired, signing out...');
                            handleSignoutClick();
                        }
                    } catch (e) {
                        console.error('Error parsing stored token:', e);
                        localStorage.removeItem('google_token');
                    }
                } else if (token && !gapiInited) {
                    console.log('Token found but GAPI not ready, will check again after initialization');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize the application. Please refresh the page.');
            }
        };
    </script>
</body>
</html>