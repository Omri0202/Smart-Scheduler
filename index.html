<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Scheduler - Simple Sign In</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #f0f2f5;
        }
        .login-box {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #google-signin-button {
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
        }
        #status {
            margin-top: 1rem;
            color: #d32f2f;
            min-height: 1.5em;
        }
    </style>
</head>
<body>
    <div class="login-box">
        <h1>Smart Scheduler</h1>
        <p>Sign in to continue</p>
        
        <!-- Google Sign-In Button -->
        <div id="google-signin-button"></div>
        
        <div id="status"></div>
    </div>

    <!-- Load Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script>
        // Check if running as local file
        if (window.location.protocol === 'file:') {
            const status = document.getElementById('status');
            if (status) {
                status.innerHTML = `
                    <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 4px; margin: 10px 0;">
                        <strong>Error:</strong> This page must be run through a web server, not as a local file.<br><br>
                        <strong>Quick Fix:</strong> Open a terminal in this folder and run one of these commands, then visit http://localhost:8000
                        <ul style="text-align: left; margin: 10px 0 0 20px;">
                            <li>Python: <code>python -m http.server 8000</code></li>
                            <li>Node.js: <code>npx http-server -p 8000</code></li>
                            <li>PHP: <code>php -S localhost:8000</code></li>
                        </ul>
                    </div>
                `;
            }
            throw new Error('Must be run through a web server');
        }

        // Configuration
        const CLIENT_ID = '251900786787-rs2a373jkaetk9lmh49nch3tq5p3lnhp.apps.googleusercontent.com';
        let tokenClient; // Will hold the token client instance
        
        // Debug function
        function debugLog(message, data = '') {
            console.log(`[DEBUG] ${message}`, data);
            const status = document.getElementById('status');
            if (status) {
                status.textContent = message;
            }
        }

        // Initialize Google Identity Services
        function initGoogleIdentity() {
            try {
                // Initialize the token client
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/calendar',
                    callback: (response) => {
                        if (response.error) {
                            debugLog('Error during token request: ' + response.error);
                            return;
                        }
                        // Handle successful token response
                        debugLog('Access token received');
                        // You can now use the access token to make API calls
                        // For example: listCalendarEvents(response.access_token);
                    },
                    error_callback: (error) => {
                        console.error('Token Client Error:', error);
                        debugLog('Error during authentication');
                    }
                });
                
                // Initialize the Google Identity Services
                google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: true
                });
                
                // Render the sign-in button
                google.accounts.id.renderButton(
                    document.getElementById('google-signin-button'),
                    {
                        type: 'standard',
                        theme: 'outline',
                        size: 'large',
                        text: 'signin_with',
                        width: 250
                    }
                );
                
                // Try to show the One Tap prompt
                google.accounts.id.prompt(notification => {
                    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        debugLog('One Tap UI not shown (user might have dismissed it)');
                    }
                });
                
                debugLog('Google Sign-In initialized');
                
            } catch (error) {
                console.error('Error initializing Google Sign-In:', error);
                debugLog('Error initializing Google Sign-In');
            }
        }
        
        function handleCredentialResponse(response) {
            console.log('Google Sign-In response received');
            const statusDiv = document.getElementById('status');
            
            if (response.credential) {
                // ID token is available, user is signed in
                statusDiv.style.color = 'green';
                statusDiv.textContent = 'Success! Signing you in...';
                
                // Here you can decode the ID token if needed
                // const responsePayload = decodeJwtResponse(response.credential);
                
                // Request access token for Google APIs
                if (tokenClient) {
                    tokenClient.requestAccessToken();
                }
                
                // Redirect or update UI as needed
                setTimeout(() => {
                    // In a real app, you would redirect to your dashboard
                    // window.location.href = '/dashboard.html';
                    alert('Successfully signed in!');
                }, 1000);
            } else {
                // Handle error
                statusDiv.style.color = 'red';
                statusDiv.textContent = 'Error during sign-in. Please try again.';
                console.error('Sign-in error:', response);
            }
        }
        
        // Helper function to decode JWT
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        // Initialize when the page loads
        window.onload = function() {
            console.log('Page loaded, initializing Google Sign-In...');
            
            // Function to check if Google script is loaded
            function checkGoogleScript() {
                if (window.google && google.accounts) {
                    console.log('Google script loaded, initializing...');
                    initGoogleIdentity();
                    return true;
                }
                return false;
            }
            
            // Try to initialize immediately
            if (!checkGoogleScript()) {
                console.log('Google script not loaded yet, waiting...');
                // If not loaded, set up a listener for the script load
                const checkScript = setInterval(() => {
                    if (checkGoogleScript()) {
                        clearInterval(checkScript);
                    }
                }, 100);
                
                // Set a timeout in case the script fails to load
                setTimeout(() => {
                    if (!window.google || !google.accounts) {
                        clearInterval(checkScript);
                        console.error('Google Sign-In script failed to load');
                        const status = document.getElementById('status');
                        if (status) {
                            status.textContent = 'Error: Could not load Google Sign-In. Please refresh the page.';
                            status.style.color = '#d32f2f';
                        }
                    }
                }, 5000);
            }
        };
    </script>
</body>
</html>
