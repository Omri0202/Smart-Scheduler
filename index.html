<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Scheduler</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="src/css/styles.css">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#6366f1">
    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' https:;
      script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.google.com https://*.googleapis.com https://*.gstatic.com;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com;
      font-src 'self' https: data:;
      img-src 'self' data: https:;
      connect-src 'self' https:;
      frame-src 'self' https://*.google.com https://*.googleapis.com;
      media-src *;
    ">
</head>
<body>
    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <img src="logo.svg" alt="Smart Scheduler" class="login-logo" />
                <h1>Smart Scheduler</h1>
                <p>Your intelligent scheduling assistant</p>
            </div>
            
            <div class="login-content">
                <h2>Welcome Back</h2>
                <p class="login-subtitle">Sign in to access your schedule and manage events</p>
                
                <div id="errorContainer" class="error-message" style="display: none;"></div>
                
                <div class="login-options">
                    <button id="googleSignInBtn" class="google-signin-btn" disabled>
                        <img src="https://www.google.com/favicon.ico" alt="Google" class="provider-icon" />
                        <span>Continue with Google</span>
                    </button>
                    
                    <div class="divider">
                        <span>or</span>
                    </div>
                    
                    <form id="emailSignInForm" class="email-signin">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" placeholder="Enter your email" class="form-input" required />
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" name="password" placeholder="Enter your password" class="form-input" required />
                            <a href="#" class="forgot-password">Forgot password?</a>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Sign In</button>
                    </form>
                </div>
                
                <p class="signup-link">Don't have an account? <a href="#" id="showSignUp">Sign up</a></p>
            </div>
        </div>
    </div>
    
    <!-- App Container (initially hidden) -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- App header -->
        <header class="app-header">
            <div class="header-left">
                <button id="menuToggle" class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 id="welcomeMessage">Welcome to Smart Scheduler</h1>
            </div>
            <div class="header-right">
                <div class="profile-icon" id="profileIcon">
                    <span class="profile-initials">U</span>
                </div>
            </div>
        </header>
        
        <!-- Main content -->
        <main class="main-content">
            <!-- Chat interface will be rendered here -->
            <div id="chatContainer" class="chat-container"></div>
            
            <!-- Input area -->
            <div class="input-container">
                <form id="messageForm" class="message-form">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="Type your message or say 'Hey Siri, add an event'" 
                        class="message-input"
                        autocomplete="off"
                    />
                    <button type="button" id="voiceInputBtn" class="voice-input-btn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button type="submit" class="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                
                <div id="recordingIndicator" class="recording-indicator" style="display: none;">
                    <div class="pulse"></div>
                    <span>Listening...</span>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Google API Client -->
    <script>
        // Define the missing functions
        window.gapiLoaded = function() {
            console.log('Google API client loaded');
            // Initialize the app if not already initialized
            if (document.readyState === 'complete') {
                initializeApp();
            } else {
                window.addEventListener('load', initializeApp);
            }
        };

        window.gisLoaded = function() {
            console.log('Google Identity Services loaded');
            // The actual initialization will happen in initializeApp
        };

        window.handleGapiError = function() {
            console.error('Failed to load Google API client');
            showError('Failed to load Google services. Please check your connection and refresh the page.');
        };

        window.handleGisError = function() {
            console.error('Failed to load Google Identity Services');
            showError('Failed to load authentication services. Please check your connection and refresh the page.');
        };
    </script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" onerror="handleGapiError()"></script>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" onerror="handleGisError()"></script>
    
    <!-- Import the application configuration -->
    <script type="module">
        import { CONFIG } from './src/config.js';
        // Make config globally available
        window.CONFIG = CONFIG;
    </script>
    
    <!-- Import the main application logic -->
    <script type="module" src="./src/js/app.js"></script>
    
    <!-- Application Scripts -->
    <script type="module">
        import { CONFIG } from './src/config.js';
        
        // Make config globally available
        window.CONFIG = CONFIG;
        
        // Global state
        window.authState = {
            isSignedIn: false,
            userProfile: null,
            tokenClient: null,
            gapiInited: false,
            gisInited: false
        };
        
        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const errorContainer = document.getElementById('errorContainer');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const profileInitials = document.querySelectorAll('.profile-initials');
        
        // Update sign-in button state
        function updateSigninStatus() {
            const signInButton = document.getElementById('googleSignInBtn');
            if (signInButton) {
                const isReady = window.authState.gapiInited && window.authState.gisInited;
                signInButton.disabled = !isReady;
                signInButton.innerHTML = isReady 
                    ? '<img src="https://www.google.com/favicon.ico" alt="Google" class="provider-icon" /> <span>Continue with Google</span>'
                    : '<i class="fas fa-spinner fa-spin"></i> Loading...';
            }
        }
        
        function gisLoaded() {
            console.log('Google Identity Services loaded, initializing...');
            if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                console.error('Google Identity Services not loaded properly');
                showError('Failed to load authentication services. Please refresh the page.');
                return;
            }
            
            try {
                window.authState.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: window.CONFIG.GOOGLE.CLIENT_ID,
                    scope: window.CONFIG.GOOGLE.SCOPES,
                    callback: handleAuthResponse,
                    error_callback: (error) => {
                        console.error('Google auth error:', error);
                        if (error.type === 'popup_closed') {
                            showError('Sign in was canceled. Please try again.');
                        } else {
                            showError('Authentication error. Please try again.');
                        }
                    }
                });
                window.authState.gisInited = true;
                updateSigninStatus();
            } catch (error) {
                console.error('Error initializing Google Identity Services:', error);
                showError('Failed to initialize authentication services. Please refresh the page.');
            }
        }
        
        async function initializeGapiClient() {
            try {
                // First load the client library
                await new Promise((resolve, reject) => {
                    gapi.load('client:auth2', {
                        callback: resolve,
                        onerror: reject,
                        timeout: 10000,
                        ontimeout: () => reject(new Error('Timeout loading Google API client'))
                    });
                });

                console.log('Initializing GAPI client with config:', {
                    apiKey: window.CONFIG.GOOGLE.API_KEY,
                    clientId: window.CONFIG.GOOGLE.CLIENT_ID,
                    discoveryDocs: window.CONFIG.GOOGLE.DISCOVERY_DOCS,
                    scope: window.CONFIG.GOOGLE.SCOPES
                });

                // Initialize the client with API key and discovery docs
                await gapi.client.init({
                    apiKey: window.CONFIG.GOOGLE.API_KEY,
                    discoveryDocs: window.CONFIG.GOOGLE.DISCOVERY_DOCS,
                    clientId: window.CONFIG.GOOGLE.CLIENT_ID,
                    scope: window.CONFIG.GOOGLE.SCOPES
                });
                
                console.log('GAPI client initialized successfully');
                window.authState.gapiInited = true;
                updateSigninStatus();
                
                // Check for existing token
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance && authInstance.isSignedIn.get()) {
                    window.authState.isSignedIn = true;
                    updateUI(true);
                    await loadUserProfile();
                }
                
            } catch (error) {
                console.error('Error initializing GAPI client:', error);
                let errorMessage = 'Failed to initialize Google services. ';
                
                if (error.status === 400) {
                    errorMessage += 'Invalid API key or client ID. Please check your Google Cloud Console settings.';
                } else if (error.details) {
                    if (error.details.includes('ORIGIN')) {
                        errorMessage = 'Invalid domain. Please add ' + window.location.origin + ' to Authorized JavaScript origins in Google Cloud Console.';
                    } else {
                        errorMessage += error.details;
                    }
                } else if (error.message) {
                    errorMessage += error.message;
                }
                
                showError(errorMessage);
                throw error; // Re-throw to be caught by the caller
            }
        }
        
        function handleAuthResponse(response) {
            if (response && response.access_token) {
                window.authState.isSignedIn = true;
                localStorage.setItem('google_access_token', response.access_token);
                updateUI(true);
                loadUserProfile();
            } else {
                console.error('Error during authentication');
                showError('Authentication failed. Please try again.');
            }
        }
        
        function handleGoogleSignIn() {
            if (!window.authState.tokenClient) {
                console.error('Google token client not initialized');
                showError('Authentication service not ready. Please refresh the page.');
                return;
            }
            
            // Clear any existing tokens
            if (window.gapi && window.gapi.auth2) {
                const auth2 = window.gapi.auth2.getAuthInstance();
                if (auth2) {
                    auth2.signOut();
                }
            }
            
            // Clear any stored tokens
            localStorage.removeItem('google_access_token');
            
            // Request new access token with explicit consent
            try {
                window.authState.tokenClient.requestAccessToken({ prompt: 'consent' });
            } catch (error) {
                console.error('Error requesting access token:', error);
                showError('Error signing in. Please try again.');
            }
        }
        
        function updateUI(isSignedIn) {
            if (loginContainer) {
                loginContainer.style.display = isSignedIn ? 'none' : 'flex';
            }
            if (appContainer) {
                appContainer.style.display = isSignedIn ? 'block' : 'none';
            }
        }
        
        function showError(message) {
            if (errorContainer) {
                errorContainer.textContent = message;
                errorContainer.style.display = 'block';
                setTimeout(() => {
                    errorContainer.style.display = 'none';
                }, 5000);
            }
        }
        
        async function loadUserProfile() {
            try {
                if (!gapi.client) {
                    console.error('gapi.client is not available');
                    return;
                }
                
                // First try to get user info from People API
                let userName = 'User';
                let userEmail = '';
                
                try {
                    // Get basic profile info
                    const profileResponse = await gapi.client.people.people.get({
                        resourceName: 'people/me',
                        personFields: 'names,emailAddresses,photos'
                    });
                    
                    const profile = profileResponse.result;
                    if (profile.names && profile.names.length > 0) {
                        userName = profile.names[0].displayName || 'User';
                    }
                    if (profile.emailAddresses && profile.emailAddresses.length > 0) {
                        userEmail = profile.emailAddresses[0].value || '';
                    }
                    
                    console.log('User profile loaded:', { userName, userEmail });
                } catch (profileError) {
                    console.warn('Error loading user profile from People API, falling back to Calendar API', profileError);
                    
                    // Fallback to Calendar API if People API fails
                    const calendarResponse = await gapi.client.calendar.calendarList.get({
                        calendarId: 'primary'
                    });
                    
                    if (calendarResponse.result && calendarResponse.result.summary) {
                        userName = calendarResponse.result.summary;
                    }
                }
                
                const userInitial = userName.charAt(0).toUpperCase();
                
                // Update UI with user info
                profileInitials.forEach(el => {
                    el.textContent = userInitial;
                });
                
                if (welcomeMessage) {
                    welcomeMessage.textContent = `Welcome, ${userName}!`;
                }
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                if (error.status === 401) {
                    // Token expired, re-authenticate
                    handleGoogleSignIn();
                } else {
                    showError('Error loading profile. Please try again.');
                }
            }
        }
        
        // Initialize application
        function initializeApp() {
            console.log('Initializing application...');
            
            // Initialize Google APIs
            if (window.gapi) {
                // First load the client library
                gapi.load('client:auth2', {
                    callback: () => {
                        console.log('GAPI client loaded, initializing...');
                        initializeGapiClient().catch(error => {
                            console.error('Failed to initialize GAPI client:', error);
                            showError('Failed to initialize Google services. Please refresh the page.');
                        });
                    },
                    onerror: (error) => {
                        console.error('Failed to load GAPI client:', error);
                        showError('Failed to load Google services. Please check your connection.');
                    },
                    timeout: 10000,
                    ontimeout: () => showError('Connection to Google services timed out. Please refresh the page.')
                });
            } else {
                const error = 'Google API client not loaded. Check your internet connection and refresh the page.';
                console.error(error);
                showError(error);
            }
            
            // Initialize Google Identity Services
            if (window.google && window.google.accounts) {
                try {
                    initializeGis();
                } catch (error) {
                    console.error('Failed to initialize Google Identity Services:', error);
                    showError('Failed to initialize authentication services');
                }
            } else {
                const error = 'Google Identity Services not loaded. Check your internet connection and refresh the page.';
                console.error(error);
                showError(error);
            }
        }
        
        // Initialize Google Identity Services
        function initializeGis() {
            try {
                window.authState.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: window.CONFIG.GOOGLE.CLIENT_ID,
                    scope: window.CONFIG.GOOGLE.SCOPES,
                    callback: handleAuthResponse,
                    error_callback: (error) => {
                        console.error('Google auth error:', error);
                        showError('Authentication error. Please try again.');
                    }
                });
                window.authState.gisInited = true;
                updateSigninStatus();
            } catch (error) {
                console.error('Error initializing Google Identity Services:', error);
                showError('Failed to initialize authentication services');
            }
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting initialization...');
            
            // Set a timeout to show loading state
            const initTimeout = setTimeout(() => {
                if (!window.authState.gapiInited || !window.authState.gisInited) {
                    showError('Taking longer than expected to load. Please wait...');
                }
            }, 3000);
            
            // Initialize the application
            try {
                initializeApp();
                
                // Check initialization status
                const checkInitialization = setInterval(() => {
                    if (window.authState.gapiInited && window.authState.gisInited) {
                        clearTimeout(initTimeout);
                        clearInterval(checkInitialization);
                        console.log('Application initialized successfully');
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error initializing application:', error);
                showError('Failed to initialize application. Please refresh the page.');
            }
            
            // Update UI based on auth state (will be updated after initialization)
            updateUI(false);
            
            // Add event listeners
            if (googleSignInBtn) {
                googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            }
            
            // Email sign-in form
            const emailSignInForm = document.getElementById('emailSignInForm');
            if (emailSignInForm) {
                emailSignInForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    // Handle email/password sign-in
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    console.log('Email sign-in attempt:', { email });
                    // TODO: Implement email/password authentication
                });
            }
        });
    </script>
</body>
</html>
