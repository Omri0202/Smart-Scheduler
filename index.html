<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smart Scheduler</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="src/styles/main.css">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#6366f1">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js" defer></script>
    <script src="https://accounts.google.com/gsi/client" defer></script>
</head>
<body>
    <!-- Floating Particles Background -->
    <div class="floating-particles" id="particles"></div>
    
    <!-- Welcome Screen -->
    <div id="welcomeContainer" class="welcome-container">
        <div class="welcome-card">
            <img src="logo.svg" alt="Smart Scheduler" class="app-logo">
            <h1>Smart Scheduler</h1>
            <p>Your intelligent scheduling assistant powered by AI</p>
            <button id="getStartedBtn" class="primary-button">Get Started</button>
        </div>
    </div>
    
    <!-- Login Container -->
    <div id="loginContainer" class="login-container" style="display: none;">
        <div class="login-card">
            <div class="login-header">
                <img src="logo.svg" alt="Smart Scheduler" class="login-logo">
                <h1>Smart Scheduler</h1>
                <p>Your intelligent scheduling assistant</p>
            </div>
            
            <div class="login-content">
                <h2>Welcome Back</h2>
                <p class="login-subtitle">Sign in to access your schedule and manage events</p>
                
                <div class="login-options">
                    <button id="googleSignInBtn" class="google-signin-btn">
                        <img src="https://www.google.com/favicon.ico" alt="Google" class="provider-icon">
                        <span>Continue with Google</span>
                    </button>
                    
                    <div class="divider">
                        <span>or</span>
                    </div>
                    
                    <div class="email-signin">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" placeholder="Enter your email" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" placeholder="Enter your password" class="form-input">
                            <a href="#" class="forgot-password">Forgot password?</a>
                        </div>
                        
                        <button id="emailSignInBtn" class="primary-button">Sign In</button>
                    </div>
                </div>
                
                <div class="login-footer">
                    <p>Don't have an account? <a href="#" id="signUpLink">Sign up</a></p>
                    <button id="testButton" class="demo-button">Try Demo Mode</button>
                </div>
            </div>
            
            <div class="login-features">
                <h3>Smart Scheduling Made Easy</h3>
                <ul class="feature-list">
                    <li><i class="fas fa-check-circle"></i> Natural language event creation</li>
                    <li><i class="fas fa-check-circle"></i> Smart calendar management</li>
                    <li><i class="fas fa-check-circle"></i> Voice command support</li>
                    <li><i class="fas fa-check-circle"></i> Cross-platform sync</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Main App (initially hidden) -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <img src="logo.svg" alt="Smart Scheduler" class="logo">
                <h1>Smart Scheduler</h1>
            </div>
            
            <nav class="nav-links">
                <a href="#" class="nav-link active">Home</a>
                <a href="#" class="nav-link">Calendar</a>
                <a href="#" class="nav-link">Settings</a>
            </nav>
            
            <div class="user-actions">
                <div class="user-info">
                    <img id="userAvatar" src="" alt="User" class="user-avatar">
                    <span id="userName"></span>
                </div>
                <button id="signOutBtn" class="sign-out-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </button>
                <button class="mobile-menu-btn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </header>
        
        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <h3 class="mobile-menu-title">Menu</h3>
                <button class="close-menu-btn" id="closeMenuBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <nav class="mobile-nav-links">
                <a href="#" class="mobile-nav-link active">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="#" class="mobile-nav-link">
                    <i class="fas fa-calendar"></i>
                    <span>Calendar</span>
                </a>
                <a href="#" class="mobile-nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>
            
            <div class="mobile-user-profile">
                <div class="mobile-user-info">
                    <img id="mobileUserAvatar" src="" alt="User" class="mobile-user-avatar">
                    <div class="mobile-user-details">
                        <h4 id="mobileUserName">User Name</h4>
                        <p id="mobileUserEmail">user@example.com</p>
                    </div>
                </div>
                
                <div class="mobile-menu-footer">
                    <button class="mobile-menu-btn-secondary" id="mobileSignOutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Overlay -->
        <div class="overlay" id="overlay"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer">
                <div class="welcome-message">
                    <h2>Welcome to Smart Scheduler</h2>
                    <p>I'm your AI scheduling assistant. How can I help you today?</p>
                    <div class="suggestions">
                        <button class="suggestion-btn">Schedule a meeting</button>
                        <button class="suggestion-btn">Check my calendar</button>
                        <button class="suggestion-btn">Set a reminder</button>
                    </div>
                </div>
                
                <div class="messages" id="messages">
                    <!-- Messages will be added here dynamically -->
                </div>
                
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="input-container" id="inputContainer">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="inputBox" 
                        placeholder="Type your message or say something..."
                        autocomplete="off"
                    >
                    <button id="voiceButton" class="voice-button">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="sendButton" class="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="voice-recording" id="voiceRecording" style="display: none;">
                    <div class="recording-indicator">
                        <span class="pulse"></span>
                        <span>Listening...</span>
                    </div>
                    <button id="stopRecording" class="stop-recording">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Files -->
    <script type="module" src="src/js/config.js"></script>
    <script type="module" src="src/js/utils.js"></script>
    <script type="module" src="src/js/auth.js"></script>
    <script type="module" src="src/js/calendar.js"></script>
    <script type="module" src="src/js/llm.js"></script>
    <script type="module" src="src/js/ui.js"></script>
    <script type="module" src="src/js/main.js"></script>
    
    <script>
        // Global state
        let isAuthenticated = false;
        
        // DOM elements
        const welcomeContainer = document.getElementById('welcomeContainer');
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const signOutBtn = document.getElementById('signOutBtn');
        const mobileSignOutBtn = document.getElementById('mobileSignOutBtn');
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const closeMenuBtn = document.getElementById('closeMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        const overlay = document.getElementById('overlay');
        const inputBox = document.getElementById('inputBox');
        const sendButton = document.getElementById('sendButton');
        const voiceButton = document.getElementById('voiceButton');
        const voiceRecording = document.getElementById('voiceRecording');
        const stopRecording = document.getElementById('stopRecording');
        const chatContainer = document.getElementById('chatContainer');
        const testButton = document.getElementById('testButton');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const emailSignInBtn = document.getElementById('emailSignInBtn');
        const signUpLink = document.getElementById('signUpLink');
        const getStartedBtn = document.getElementById('getStartedBtn');
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Setup event listeners
            setupEventListeners();
            
            // Show welcome screen by default
            showWelcomeScreen();
        });
        
        // Set up event listeners
        function setupEventListeners() {
            // Navigation buttons
            if (getStartedBtn) getStartedBtn.addEventListener('click', showLoginScreen);
            if (testButton) testButton.addEventListener('click', startDemoMode);
            
            // Mobile menu
            if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleMobileMenu);
            if (closeMenuBtn) closeMenuBtn.addEventListener('click', closeMobileMenu);
            if (overlay) overlay.addEventListener('click', closeMobileMenu);
            
            // Authentication
            if (googleSignInBtn) googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            if (emailSignInBtn) emailSignInBtn.addEventListener('click', handleEmailSignIn);
            if (signUpLink) signUpLink.addEventListener('click', handleSignUp);
            
            // Chat functionality
            if (sendButton) sendButton.addEventListener('click', handleSendMessage);
            if (inputBox) {
                inputBox.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                });
            }
            
            // Voice input
            if (voiceButton) voiceButton.addEventListener('click', toggleVoiceInput);
            if (stopRecording) stopRecording.addEventListener('click', stopVoiceInput);
            
            // Sign out buttons
            if (signOutBtn) signOutBtn.addEventListener('click', handleSignOut);
            if (mobileSignOutBtn) mobileSignOutBtn.addEventListener('click', handleSignOut);
            
            // Suggestion buttons
            const suggestionButtons = document.querySelectorAll('.suggestion-btn');
            suggestionButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    inputBox.value = e.target.textContent;
                    handleSendMessage();
                });
            });
        }
        
        // Screen management functions
        function showWelcomeScreen() {
            if (welcomeContainer) welcomeContainer.style.display = 'flex';
            if (loginContainer) loginContainer.style.display = 'none';
            if (appContainer) appContainer.style.display = 'none';
        }
        
        function showLoginScreen() {
            if (welcomeContainer) welcomeContainer.style.display = 'none';
            if (loginContainer) loginContainer.style.display = 'flex';
            if (appContainer) appContainer.style.display = 'none';
        }
        
        function showAppScreen() {
            if (welcomeContainer) welcomeContainer.style.display = 'none';
            if (loginContainer) loginContainer.style.display = 'none';
            if (appContainer) appContainer.style.display = 'block';
        }
        
        function startDemoMode() {
            isAuthenticated = true;
            showAppScreen();
            showMessage('System', 'Demo mode activated. You can test the chat functionality.', 'system');
        }
        
        // Authentication handlers
        function handleGoogleSignIn() {
            if (tokenClient) {
                tokenClient.requestAccessToken();
            } else {
                showMessage('System', 'Google Sign-In is not available. Please try again later.', 'error');
            }
        }
        
        function handleEmailSignIn() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showMessage('System', 'Please enter both email and password.', 'error');
                return;
            }
            
            showMessage('System', 'Email authentication is not implemented in this demo. Please use Google Sign-In or Demo Mode.', 'system');
        }
        
        function handleSignUp(e) {
            e.preventDefault();
            showMessage('System', 'Account creation is not implemented in this demo. Please use Google Sign-In or Demo Mode.', 'system');
        }
        
        function handleSignOut() {
            const auth2 = gapi.auth2.getAuthInstance();
            if (auth2) {
                auth2.signOut().then(() => {
                    console.log('User signed out.');
                });
            }
            
            // Clear any stored tokens
            if (window.google && google.accounts) {
                google.accounts.id.revoke(localStorage.getItem('google_id'), done => {
                    console.log('Consent revoked');
                });
            }
            
            // Clear local state
            isAuthenticated = false;
            localStorage.removeItem('google_token');
            
            // Update UI
            showLoginScreen();
            closeMobileMenu();
            showMessage('System', 'You have been signed out.', 'system');
        }
        
        // Show message in chat
        function showMessage(sender, text, type = 'user') {
            const messagesContainer = document.getElementById('messages');
            if (!messagesContainer) return;
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            
            // Add avatar for assistant messages
            if (type === 'assistant' || type === 'system' || type === 'error' || type === 'success') {
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                if (type === 'assistant') {
                    avatar.innerHTML = '<i class="fas fa-robot"></i>';
                } else if (type === 'system' || type === 'success') {
                    avatar.innerHTML = '<i class="fas fa-info-circle"></i>';
                } else if (type === 'error') {
                    avatar.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                }
                messageElement.appendChild(avatar);
            }
            
            // Create message content container
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Add sender name
            const senderElement = document.createElement('div');
            senderElement.className = 'message-sender';
            senderElement.textContent = sender;
            messageContent.appendChild(senderElement);
            
            // Add message text
            const textElement = document.createElement('div');
            textElement.className = 'message-text';
            textElement.textContent = text;
            messageContent.appendChild(textElement);
            
            // Add timestamp
            const timeElement = document.createElement('div');
            timeElement.className = 'message-time';
            timeElement.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageContent.appendChild(timeElement);
            
            // Add message content to message element
            messageElement.appendChild(messageContent);
            
            // Add message to chat
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Voice input functions
        function toggleVoiceInput() {
            if (!recognition) return;
            
            try {
                recognition.start();
                voiceButton.style.display = 'none';
                voiceRecording.style.display = 'flex';
            } catch (error) {
                console.error('Error starting voice recognition:', error);
                showMessage('System', 'Error: Could not access microphone. Please check permissions.', 'error');
            }
        }
        
        function stopVoiceInput() {
            if (recognition) {
                recognition.stop();
            }
            voiceRecording.style.display = 'none';
            voiceButton.style.display = 'flex';
        }
        
        // Mobile menu functions
        function toggleMobileMenu() {
            if (mobileMenu) mobileMenu.classList.add('show');
            if (overlay) overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMobileMenu() {
            if (mobileMenu) mobileMenu.classList.remove('show');
            if (overlay) overlay.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        // Initialize speech recognition if available
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                if (inputBox) inputBox.value = transcript;
                handleSendMessage();
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                showMessage('System', 'Error: Could not process voice input. Please try again.', 'error');
            };
        } else if (voiceButton) {
            voiceButton.style.display = 'none';
        }
        
        // Chat functionality
        async function handleSendMessage() {
            const message = inputBox.value.trim();
            if (!message) return;
            
            // Add user message to chat
            showMessage('You', message, 'user');
            inputBox.value = '';
            
            // Show typing indicator
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) typingIndicator.style.display = 'flex';
            
            try {
                // In a real app, you would send this to your backend for processing
                // For now, we'll just create a simple event
                if (message.toLowerCase().includes('schedule') || message.toLowerCase().includes('meeting')) {
                    if (!isAuthenticated) {
                        showMessage('System', 'Please sign in to schedule events.', 'error');
                        return;
                    }
                    
                    // Create a sample event (in a real app, you'd parse the message)
                    const eventDetails = {
                        summary: 'Meeting',
                        description: 'Scheduled via Smart Scheduler',
                        startDateTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                        endDateTime: new Date(Date.now() + 25 * 60 * 60 * 1000).toISOString()
                    };
                    
                    const event = await createCalendarEvent(eventDetails);
                    const eventLink = event.htmlLink;
                    
                    showMessage('Assistant', `I've scheduled your meeting! You can view it here: <a href="${eventLink}" target="_blank">View Event</a>`, 'assistant');
                } else {
                    showMessage('Assistant', 'I can help you schedule events in your Google Calendar. Try saying "Schedule a meeting tomorrow at 2pm"', 'assistant');
                }
            } catch (error) {
                console.error('Error processing message:', error);
                showMessage('System', 'An error occurred while processing your request. Please try again.', 'error');
            } finally {
        let gapiInited = false;
        let gisInited = false;
        
        // Initialize Google APIs when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Load the Google API client library and set up sign-in
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = () => {
                gapi.load('client:auth2', initializeGapiClient);
            };
            document.head.appendChild(script);
            
            // Load the Google Identity Services library
            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.async = true;
            gisScript.defer = true;
            gisScript.onload = initializeGis;
            document.head.appendChild(gisScript);
        });
        
        // Initialize the Google API client
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                console.log('Google API client initialized');
                maybeEnableSignIn();
            } catch (error) {
                console.error('Error initializing Google API client:', error);
                showMessage('System', 'Error initializing Google services. Please try again later.', 'error');
            }
        }
        
        // Initialize Google Identity Services
        function initializeGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                prompt: 'select_account',
                callback: (response) => {
                    if (response && response.access_token) {
                        // User is signed in
                        isAuthenticated = true;
                        showAppScreen();
                        loadUserProfile();
                        showMessage('System', 'Successfully signed in! How can I help you schedule today?', 'success');
                    }
                }
            });
            gisInited = true;
            console.log('Google Identity Services initialized');
            maybeEnableSignIn();
        }
        
        // Enable the sign-in button if both libraries are loaded
        function maybeEnableSignIn() {
            if (gapiInited && gisInited) {
                if (googleSignInBtn) {
                    googleSignInBtn.disabled = false;
                }
            }
        }
        
        // Handle Google Sign-In
        function handleGoogleSignIn() {
            if (!tokenClient) {
                showMessage('System', 'Google Sign-In is not available. Please try again later.', 'error');
                return;
            }
            
            // Request access token
            tokenClient.requestAccessToken();
        }
        
        // Load the user's profile
        async function loadUserProfile() {
            try {
                const response = await gapi.client.people.people.get({
                    resourceName: 'people/me',
                    personFields: 'names,emailAddresses,photos'
                });
                
                const profile = response.result;
                const name = profile.names[0].displayName;
                const email = profile.emailAddresses[0].value;
                const photoUrl = profile.photos && profile.photos[0] ? profile.photos[0].url : '';
                
                // Update UI with user info
                const userNameElements = document.querySelectorAll('#userName, #mobileUserName');
                const userAvatarElements = document.querySelectorAll('#userAvatar, #mobileUserAvatar');
                const userEmailElement = document.querySelector('#mobileUserEmail');
                
                userNameElements.forEach(el => el.textContent = name);
                userAvatarElements.forEach(el => {
                    if (photoUrl) {
                        el.src = photoUrl;
                        el.style.display = 'block';
                    } else {
                        el.style.display = 'none';
                    }
                });
                
                if (userEmailElement) {
                    userEmailElement.textContent = email;
                }
                
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }
        
        // Create a calendar event
        async function createCalendarEvent(eventDetails) {
            if (!isAuthenticated) {
                showMessage('System', 'Please sign in to create events.', 'error');
                return;
            }
            
            try {
                const event = {
                    'summary': eventDetails.summary || 'New Event',
                    'location': eventDetails.location || '',
                    'description': eventDetails.description || '',
                    'start': {
                        'dateTime': eventDetails.startDateTime || new Date().toISOString(),
                        'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    'end': {
                        'dateTime': eventDetails.endDateTime || new Date(Date.now() + 60 * 60 * 1000).toISOString(),
                        'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    'attendees': eventDetails.attendees || [],
                    'reminders': {
                        'useDefault': true
                    }
                };
                
                const request = gapi.client.calendar.events.insert({
                    'calendarId': 'primary',
                    'resource': event
                });
                
                const response = await request;
                console.log('Event created:', response);
                return response.result;
                
            } catch (error) {
                console.error('Error creating event:', error);
                throw error;
            }
        }
        
        // Add CSS for the chat interface
        const style = document.createElement('style');
        style.textContent = `
            /* Chat message styles */
            .message {
                display: flex;
                margin-bottom: 16px;
                max-width: 85%;
            }
            
            .message.user {
                margin-left: auto;
                flex-direction: row-reverse;
            }
            
            .message-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background-color: #6366f1;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 0 8px;
                flex-shrink: 0;
            }
            
            .message-content {
                background-color: #f3f4f6;
                border-radius: 12px;
                padding: 12px 16px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            
            .user .message-content {
                background-color: #6366f1;
                color: white;
            }
            
            .message-sender {
                font-weight: 600;
                font-size: 0.875rem;
                margin-bottom: 4px;
            }
            
            .message-text {
                font-size: 0.9375rem;
                line-height: 1.5;
            }
            
            .message-time {
                font-size: 0.75rem;
                color: #6b7280;
                text-align: right;
                margin-top: 4px;
            }
            
            .user .message-time {
                color: rgba(255, 255, 255, 0.8);
            }
            
            /* Typing indicator */
            .typing-indicator {
                display: none;
                align-items: center;
                margin-bottom: 16px;
            }
            
            .typing-dot {
                width: 8px;
                height: 8px;
                background-color: #9ca3af;
                border-radius: 50%;
                margin: 0 2px;
                animation: typing 1.4s infinite ease-in-out;
            }
            
            .typing-dot:nth-child(1) { animation-delay: 0s; }
            .typing-dot:nth-child(2) { animation-delay: 0.2s; }
            .typing-dot:nth-child(3) { animation-delay: 0.4s; }
            
            @keyframes typing {
                0%, 60%, 100% { transform: translateY(0); }
                30% { transform: translateY(-6px); }
            }
            
            /* Voice recording indicator */
            .voice-recording {
                display: none;
                align-items: center;
                justify-content: center;
                padding: 12px;
                background-color: #fef2f2;
                border-radius: 12px;
                margin: 12px 0;
            }
            
            .recording-indicator {
                display: flex;
                align-items: center;
                color: #dc2626;
                font-weight: 500;
            }
            
            .pulse {
                width: 12px;
                height: 12px;
                background-color: #dc2626;
                border-radius: 50%;
                margin-right: 8px;
                animation: pulse 1.5s infinite;
            }
            
            @keyframes pulse {
                0% { transform: scale(0.95); opacity: 0.8; }
                70% { transform: scale(1.2); opacity: 1; }
                100% { transform: scale(0.95); opacity: 0.8; }
            }
            
            .stop-recording {
                background: none;
                border: none;
                color: #dc2626;
                cursor: pointer;
                margin-left: 16px;
                font-size: 1.25rem;
            }
        `;
        document.head.appendChild(style);
        
        // Google API client initialization
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: 'YOUR_API_KEY', // Replace with your API key
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: 'YOUR_CLIENT_ID', // Replace with your client ID
                scope: 'https://www.googleapis.com/auth/calendar',
                callback: (response) => {
                    if (response && response.access_token) {
                        accessToken = response.access_token;
                        localStorage.setItem('google_access_token', accessToken);
                        
                        if (elements.loginContainer) elements.loginContainer.style.display = 'none';
                        if (elements.appLayout) elements.appLayout.style.display = 'block';
                        
                        // Load user profile
                        loadUserProfile();
                        
                        // Add welcome message
                        if (window.ui) {
                            window.ui.addMessage("You've successfully signed in! How can I help you schedule today?", 'assistant');
                        }
                    }
                }
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (elements.googleSignInBtn) {
                elements.googleSignInBtn.style.display = gisInited ? 'block' : 'none';
            }
        }
        
        function handleAuthClick() {
            if (!accessToken) {
                tokenClient.requestAccessToken();
            } else {
                google.accounts.oauth2.revoke(accessToken, () => {
                    accessToken = null;
                    localStorage.removeItem('google_access_token');
                    
                    if (elements.appLayout) elements.appLayout.style.display = 'none';
                    if (elements.loginContainer) elements.loginContainer.style.display = 'flex';
                    
                    // Clear chat
                    if (elements.chatContainer) elements.chatContainer.innerHTML = '';
                });
            }
        }
    </script>
</body>
</html>
