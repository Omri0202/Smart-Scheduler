<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Smart Scheduler</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Smart Scheduler" />
    <!-- <link rel="apple-touch-icon" href="./icon-192.png" /> -->
    
    <!-- Mobile Optimizations -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    
    <!-- Load Google Authentication -->
    <script src="google-auth.js" defer></script>
      
      // Google API and Identity Services initialization moved to google-auth.js
      
      // Authentication, sign-out, and user profile code moved to google-auth.js
      
      // Start loading Google scripts when the page loads
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded');
        
        // Load Google scripts
        loadGoogleScripts();
        
        // Setup event listeners
        setupEventListeners();
      });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
          --primary: #6366f1;
          --primary-dark: #4f46e5;
          --secondary: #8b5cf6;
          --accent: #06b6d4;
          --success: #10b981;
          --warning: #f59e0b;
          --error: #ef4444;
          --dark: #0f172a;
          --dark-light: #1e293b;
          --gray: #64748b;
          --gray-light: #f1f5f9;
          --white: #ffffff;
          --glass: rgba(255, 255, 255, 0.1);
          --glass-dark: rgba(0, 0, 0, 0.2);
        }
        
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }
        
        body, html {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
          background-size: 400% 400%;
          animation: gradientShift 15s ease infinite;
          color: var(--white);
          overflow-x: hidden;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }
        
        @keyframes gradientShift {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
#cornerText {
 position: fixed;
 top: 20px;
 left: 20px;
 background: rgba(255,255,255,0.7);
 padding: 10px 15px;
 font-weight: bold;
 border-radius: 6px;
}
        .main-container {
          background: var(--glass);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 24px;
          padding: 40px;
          max-width: 700px;
          width: 95%;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
          margin: auto;
          text-align: center;
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        /* User Avatar Styles */
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            color: white;
            overflow: hidden;
            border: 3px solid #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Animation for when avatar loads */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-avatar.visible {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* App Layout */
        .app-layout {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
          background-size: 400% 400%;
          animation: gradientShift 15s ease infinite;
        }
        
        .app-layout.active {
          display: flex;
        }
        
        .sidebar {
          width: 280px;
          background: var(--glass);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border-right: 1px solid rgba(255, 255, 255, 0.2);
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 24px;
        }
        
        .user-profile {
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 20px;
          background: var(--glass);
          backdrop-filter: blur(10px);
          border-radius: 16px;
          border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-avatar {
          width: 48px;
          height: 48px;
          border-radius: 50%;
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: 600;
          font-size: 18px;
        }
        
        .user-info {
          flex: 1;
        }
        
        .user-name {
          font-weight: 600;
          color: var(--white);
          margin: 0 0 4px 0;
          font-size: 16px;
        }
        
        .user-email {
          font-size: 14px;
          color: rgba(255, 255, 255, 0.7);
          margin: 0;
        }
        
        .nav-tabs {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        
        .nav-tab {
          padding: 16px 20px;
          border-radius: 12px;
          background: transparent;
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: rgba(255, 255, 255, 0.7);
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 12px;
          font-size: 15px;
          font-weight: 500;
        }
        
        .nav-tab:hover {
          background: rgba(255, 255, 255, 0.1);
          color: var(--white);
          transform: translateX(4px);
        }
        
        .nav-tab.active {
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: var(--white);
          border-color: transparent;
          box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }
        
        .main-content {
          flex: 1;
          padding: 24px;
          overflow-y: auto;
        }
        
        .tab-content {
          display: none;
          height: 100%;
        }
        
        .tab-content.active {
          display: flex;
          flex-direction: column;
        }
        
        .content-header {
          margin-bottom: 24px;
        }
        
        .content-title {
          font-size: 2rem;
          font-weight: 700;
          color: var(--white);
          margin: 0 0 8px 0;
        }
        
        .content-subtitle {
          color: rgba(255, 255, 255, 0.7);
          margin: 0;
        }
        
        .main-container::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 1px;
          background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }
        
        .main-container:hover {
          transform: translateY(-2px);
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        .input-container {
          position: fixed;
          bottom: 32px;
          left: 50%;
          transform: translateX(-50%);
          width: 90%;
          max-width: 700px;
          display: flex;
          gap: 12px;
          align-items: center;
          z-index: 100;
        }
        
        .input-wrapper {
          flex: 1;
          position: relative;
        }
        
        .smart-input {
          width: 100%;
          padding: 18px 24px;
          border: none;
          border-radius: 50px;
          font-size: 16px;
          font-weight: 400;
          outline: none;
          background: var(--glass);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          color: var(--white);
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
          min-height: 56px;
          box-sizing: border-box;
        }
        
        .smart-input::placeholder {
          color: rgba(255, 255, 255, 0.7);
        }
        
        .smart-input:focus {
          transform: translateY(-2px);
          box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
          border-color: rgba(255, 255, 255, 0.4);
        }
        
        .action-button {
          padding: 18px 24px;
          font-size: 16px;
          font-weight: 600;
          border-radius: 50px;
          border: none;
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: var(--white);
          cursor: pointer;
          transition: all 0.3s ease;
          min-height: 56px;
          min-width: 120px;
          box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }
        
        .action-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 12px 40px rgba(99, 102, 241, 0.4);
        }
        
        .action-button:active {
          transform: translateY(0);
        }

        .voice-button {
          width: 56px;
          height: 56px;
          border-radius: 50%;
          border: none;
          background: linear-gradient(135deg, var(--success), var(--accent));
          color: var(--white);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          transition: all 0.3s ease;
          box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        }
        
        .voice-button:hover {
          transform: translateY(-2px);
          box-shadow: 0 12px 40px rgba(16, 185, 129, 0.4);
        }
        
        .voice-button.recording {
          background: linear-gradient(135deg, var(--error), var(--warning));
          animation: pulse 2s infinite;
        }
        
        .chat-container {
          max-height: 60vh;
          overflow-y: auto;
          padding: 20px 0;
          scroll-behavior: smooth;
        }
        
        .message {
          margin: 16px 0;
          padding: 16px 20px;
          border-radius: 20px;
          max-width: 85%;
          word-wrap: break-word;
          animation: slideIn 0.3s ease;
        }
        
        .message.user {
          background: linear-gradient(135deg, var(--primary), var(--secondary));
          color: var(--white);
          margin-left: auto;
          border-bottom-right-radius: 8px;
        }
        
        .message.assistant {
          background: var(--glass);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          color: var(--white);
          border-bottom-left-radius: 8px;
        }
        
        .typing-indicator {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 16px 20px;
          background: var(--glass);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          border-bottom-left-radius: 8px;
          max-width: 85%;
          margin: 16px 0;
        }
        
        .dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: rgba(255, 255, 255, 0.7);
          animation: typing 1.4s infinite;
        }
        
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
          0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
          30% { transform: translateY(-10px); opacity: 1; }
        }
        
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }
        
        .header {
          text-align: center;
          margin-bottom: 32px;
        }
        
        .logo-container {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 16px;
          margin-bottom: 16px;
        }
        
        .app-logo {
          width: 64px;
          height: 64px;
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
          transition: transform 0.3s ease;
        }
        
        .app-logo:hover {
          transform: scale(1.05);
        }
        
        .header h1 {
          font-size: 2.5rem;
          font-weight: 700;
          margin: 0;
          background: linear-gradient(135deg, var(--white), rgba(255, 255, 255, 0.8));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
        }
        
        .header p {
          font-size: 1.1rem;
          opacity: 0.9;
          font-weight: 400;
        }
        
        .feature-pills {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
          justify-content: center;
          margin-top: 16px;
        }
        
        .pill {
          padding: 6px 12px;
          background: var(--glass);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 20px;
          font-size: 0.85rem;
          color: rgba(255, 255, 255, 0.9);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
          .header h1 {
            font-size: 2rem;
          }
          
          .main-container {
            padding: 24px;
            margin: 0 16px;
          }
          
          .input-container {
            bottom: 16px;
            width: 95%;
            gap: 8px;
          }
          
          .smart-input {
            padding: 16px 20px;
            font-size: 16px;
          }
          
          .voice-button {
            width: 48px;
            height: 48px;
            font-size: 18px;
          }
          
          .action-button {
            padding: 16px 20px;
            min-width: 100px;
            font-size: 15px;
          }
        }
        
        @media (max-width: 480px) {
          .feature-pills {
            gap: 6px;
          }
          
          .pill {
            font-size: 0.8rem;
            padding: 4px 8px;
          }
          
          .header p {
            font-size: 1rem;
          }
        }
        
        /* Custom Scrollbar */
        .chat-container::-webkit-scrollbar {
          width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 3px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.3);
          border-radius: 3px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
          background: rgba(255, 255, 255, 0.5);
        }
        
        /* Dashboard Styles */
        .dashboard-container {
            padding: 2rem;
            color: white;
        }
        
        .welcome-message {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 2rem;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .action-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .action-card i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            color: var(--accent);
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            margin: 2rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .nav-tab {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        
        .nav-tab i {
            width: 24px;
            text-align: center;
        }
        
        .nav-tab:hover,
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-tab.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 500;
        }
        
        /* User Profile */
        .user-profile {
            margin-top: auto;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: white;
        }
        
        .user-info {
            flex: 1;
            overflow: hidden;
        }
        
        .user-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-email {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Tab Content */
        /* Sidebar Navigation */
        .nav-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            margin: 0.5rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-button.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        
        .nav-button.sign-out {
            position: absolute;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .nav-button i {
            pointer-events: none;
        }
        
        /* Content Pages */
        .content-page {
            display: none;
            height: 100%;
            padding: 2rem;
            overflow-y: auto;
        }
        
        .content-page.active {
            display: block;
        }
        
        /* Welcome Page Styles */
        .welcome-content {
          text-align: center;
          padding: 2rem;
          color: white;
        }
        
        .welcome-logo {
          width: 120px;
          height: 120px;
          margin-bottom: 1.5rem;
          animation: float 6s ease-in-out infinite;
        }
        
        .welcome-content h1 {
          font-size: 2.5rem;
          margin-bottom: 1rem;
          background: linear-gradient(45deg, #ff6b6b, #6b6bff);
          -webkit-background-clip: text;
          background-clip: text;
          -webkit-text-fill-color: transparent;
        }
        
        .welcome-content p {
          font-size: 1.2rem;
          margin-bottom: 2rem;
          color: #e0e0e0;
        }
        
        .welcome-buttons {
          display: flex;
          gap: 1rem;
          justify-content: center;
          margin-top: 2rem;
        }
        
        @keyframes float {
          0% { transform: translateY(0px); }
          50% { transform: translateY(-15px); }
          100% { transform: translateY(0px); }
        }
        
        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 420px;
            padding: 40px;
            text-align: center;
            transform: translateY(0);
            opacity: 1;
            transition: all 0.4s ease;
        }
        
        .login-header {
            margin-bottom: 32px;
        }
        
        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
            color: #6366f1;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .login-logo i {
            font-size: 2rem;
        }
        
        .login-card h1 {
            color: #1e293b;
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .login-card p {
            color: #64748b;
            font-size: 1rem;
            margin-bottom: 0;
        }
        
        .login-buttons {
            margin-bottom: 24px;
        }
        
        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px 24px;
            background: #fff;
            color: #1f2937;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .google-signin-btn:hover {
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .google-signin-btn:active {
            transform: translateY(0);
        }
        
        .google-signin-btn img {
            width: 20px;
            height: 20px;
        }
        
        .login-footer {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #f1f5f9;
        }
        
        .login-footer p {
            font-size: 0.75rem;
            color: #94a3b8;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <!-- Floating Particles Background -->
    <div class="floating-particles" id="particles"></div>
    
    <!-- Login Page (before login) -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <!-- User Avatar (initially hidden) -->
            <div id="userAvatar" class="user-avatar" style="display: none;">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Smart Scheduler</span>
                </div>
                <h1>Welcome Back</h1>
                <p>Sign in to manage your schedule with AI</p>
            </div>
            
            <div class="login-buttons">
                <button id="authorize_button" class="google-signin-btn">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                    <span>Continue with Google</span>
                </button>
            </div>
            
            <div class="login-footer">
                <p>By continuing, you agree to our Terms of Service and Privacy Policy</p>
            </div>
        </div>
    </div>
    
    <!-- App Layout (after login) -->
    <div class="app-layout" id="appLayout" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- App Logo -->
            <div class="logo-container" style="justify-content: center; margin: 1.5rem 0 2rem 0;">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0MDAgNDAwIiBmaWxsPSIjNjM2NmYxIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgcng9IjIwIiBmaWxsPSIjZmZmIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PUFyaWFsIGZvbnQtc2l6ZT0iMTIwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBhbGlnbm1lbnQtYmFzZWxpbmU9Im1pZGRsZSIgZmlsbD0iIzYzNjZmMSI+UzwvdGV4dD48L3N2Zz4=" alt="Smart Scheduler" class="app-logo">
            </div>
            
            <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button id="welcomeBtn" class="nav-button active" title="Home">
                    <i class="fas fa-home"></i>
                </button>
                <button id="chatBtn" class="nav-button" title="Chat">
                    <i class="fas fa-comment"></i>
                </button>
                <button id="signOutBtn" class="nav-button sign-out" title="Sign Out">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Welcome Page (shown by default) -->
            <div class="content-page active" id="welcomePage">
                <div style="text-align: center; margin-top: 5rem;">
                    <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Welcome, <span id="welcomeName">User</span>! ðŸ‘‹</h1>
                    <p style="color: #94a3b8; margin-bottom: 2rem;">How can I help you schedule today?</p>
                    
                    <!-- Quick Actions -->
                    <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 3rem;">
                        <button class="quick-action" onclick="document.getElementById('chatBtn').click()">
                            <i class="fas fa-plus"></i>
                            <span>New Event</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chat Page -->
            <div class="content-page" id="chatPage" style="display: none;">
                <div class="chat-container" id="chatContainer">
                    <div id="message" class="message assistant">
                        <strong>ðŸ¤– Assistant:</strong><br>
                        Welcome! I'm your smart scheduling assistant. How can I help you today?
                    </div>
                </div>
            </div>
        </div>    
    </div>
    
    <!-- Input Container (initially hidden) -->
    <div class="input-container" id="inputContainer" style="display: none;">
        <div class="input-wrapper">
            <input type="text" id="inputBox" class="smart-input" placeholder="âœ¨ Tell me about your plans..." disabled />
        </div>
        <button id="voiceButton" class="voice-button" disabled>ðŸŽ¤</button>
    </div>

<script>
    // Google OAuth Configuration - using the one in head section with additional scopes
    let chatHistory = [];
    let questionCount = 0;
    let baseDate = new Date(); // Base date for the session
    let eventDetails = {
      date: null,
      time: null,
      attendees: null,
      location: null,
      attendeeEmails: []
    };
    
    // Add event listener for the authorize button
    document.addEventListener('DOMContentLoaded', function() {
      const authButton = document.getElementById('authorize_button');
      if (authButton) {
        authButton.addEventListener('click', handleAuthClick);
      } else {
        console.error('Authorize button not found');
      }
    });

    // Validate API key format
    function validateApiKey(apiKey) {
      if (!apiKey || typeof apiKey !== 'string' || apiKey.length < 10) {
        console.error('Invalid API key format');
        return false;
      }
      return true;
    }

    // Function to track what information we still need
    function getMissingInfo() {
      const missing = [];
      if (!eventDetails.date) missing.push('date/day');
      if (!eventDetails.time) missing.push('time');
      if (!eventDetails.attendees) missing.push('who is attending');
      if (!eventDetails.location) missing.push('location');
      return missing;
    }

    // Function to get contextual missing info (for backward compatibility)
    function getContextualMissingInfo() {
      return getMissingInfo();
    }

    // Function to determine the next action needed
    function getNextAction() {
      if (!eventDetails.date) return 'Ask for date/day';
      if (!eventDetails.time) return 'Ask for time';
      if (!eventDetails.location) return 'Ask for location';
      if (requiresEmailInvitation() && eventDetails.attendeeEmails.length === 0) {
        return 'Ask for email address';
      }
      return 'Ready to create event';
    }

    // Function to parse date and time into a DateTime object
    function parseDateTime(dateStr, timeStr) {
      if (!dateStr || !timeStr) return null;

      // Use baseDate instead of current time for consistent calculations
      let targetDate = new Date(baseDate);

      // Parse date
      const dateLower = dateStr.toLowerCase();
      if (dateLower === 'today') {
        targetDate = new Date(baseDate);
      } else if (dateLower === 'tomorrow') {
        targetDate = new Date(baseDate.getTime() + 24 * 60 * 60 * 1000);
      } else if (dateLower.startsWith('next ')) {
        const day = dateLower.replace('next ', '');
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const targetDay = days.indexOf(day);
        if (targetDay !== -1) {
          const currentDay = baseDate.getDay();
          let daysToAdd = targetDay - currentDay;
          if (daysToAdd <= 0) daysToAdd += 7;
          targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
          console.log(`Next ${day}: base day ${currentDay}, target day ${targetDay}, days to add ${daysToAdd}`);
        }
      } else if (dateLower.startsWith('this ')) {
        const day = dateLower.replace('this ', '');
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const targetDay = days.indexOf(day);
        if (targetDay !== -1) {
          const currentDay = baseDate.getDay();
          let daysToAdd = targetDay - currentDay;
          if (daysToAdd < 0) daysToAdd += 7;
          targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
        }
      } else {
        // Handle just day names like "monday", "tuesday", etc.
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        if (days.includes(dateLower)) {
          const targetDay = days.indexOf(dateLower);
          if (targetDay !== -1) {
            const currentDay = baseDate.getDay();
            let daysToAdd = targetDay - currentDay;
            // If it's the same day or past, schedule for next week
            if (daysToAdd <= 0) daysToAdd += 7;
            targetDate = new Date(baseDate.getTime() + daysToAdd * 24 * 60 * 60 * 1000);
            console.log(`Scheduling for ${dateLower}: base day ${currentDay}, target day ${targetDay}, days to add ${daysToAdd}`);
          }
        }
      }

      // Parse time
      const timeLower = timeStr.toLowerCase();
      let hours = 0, minutes = 0;

      // Handle formats like "9 AM", "2:30 PM", "14:30"
      const timeMatch = timeLower.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)?/);
      if (timeMatch) {
        hours = parseInt(timeMatch[1]);
        minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;

        if (timeMatch[3]) {
          const isPM = timeMatch[3] === 'pm';
          if (isPM && hours !== 12) hours += 12;
          if (!isPM && hours === 12) hours = 0;
        }
      }

      // Set the time on the target date
      targetDate.setHours(hours, minutes, 0, 0);

      console.log(`Time parsing: "${timeStr}" -> hours: ${hours}, minutes: ${minutes}, final time: ${targetDate.toLocaleString()}`);

      return targetDate;
    }

    // Function to extract and update event details from user input
    function updateEventDetails(userInput) {
      const input = userInput.toLowerCase();

      // Extract date patterns (only if we don't already have a date)
      if (!eventDetails.date) {
        const datePatterns = [
          /(today|tomorrow|next \w+|this \w+)/i,
          /(\d{1,2}\/\d{1,2}|\d{1,2}-\d{1,2})/,
          /(monday|tuesday|wednesday|thursday|friday|saturday|sunday)/i,
          /(january|february|march|april|may|june|july|august|september|october|november|december)/i
        ];

        let dateFound = false;
        for (const pattern of datePatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.date = match[0];
            dateFound = true;
            break;
          }
        }

        // If no date is mentioned, assume today
        if (!dateFound) {
          eventDetails.date = 'today';
        }
      }

      // Extract time patterns
      if (!eventDetails.time) {
        const timePatterns = [
          /(\d{1,2}:\d{2}\s*(am|pm))/i,
          /(\d{1,2}\s*(am|pm))/i,
          /(\d{1,2}:\d{2})/,
          /(\d{1,2}\s*o'clock)/i,
          /^(\d{1,2})$/  // Handle single digits like "9"
        ];

        for (const pattern of timePatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.time = match[0];
            console.log(`Time extracted: "${match[0]}" from input "${userInput}"`);
            break;
          }
        }
      }

      // If we have a date but no time, and the input looks like just a time, extract it
      if (eventDetails.date && !eventDetails.time) {
        const timeOnlyPatterns = [
          /^(\d{1,2}:\d{2}\s*(am|pm))$/i,
          /^(\d{1,2}\s*(am|pm))$/i,
          /^(\d{1,2}:\d{2})$/,
          /^(\d{1,2}\s*o'clock)$/i,
          /^(\d{1,2})$/  // Handle single digits like "9"
        ];

        for (const pattern of timeOnlyPatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.time = match[0];
            console.log(`Time-only extracted: "${match[0]}" from input "${userInput}"`);
            break;
          }
        }
      }

      // Extract attendees - prioritize patterns that include other people
      if (!eventDetails.attendees) {
        // First check for patterns that include other people
        const otherPeoplePatterns = [
          /(with\s+my\s+\w+)/i,  // "with my mom", "with my dad"
          /(and\s+my\s+\w+)/i,   // "and my mom"
          /(me\s+and\s+\w+)/i,   // "me and mom"
          /(\w+\s+and\s+me)/i,   // "mom and me"
          /(mom|mother|dad|father|brother|sister|family)/i,
          /(friend|friends|colleague|colleagues|team)/i,
          /(spouse|wife|husband|girlfriend|boyfriend|partner)/i,
          /(boss|manager|client|doctor|teacher)/i
        ];
        
        // Then check for solo patterns
        const soloPatterns = [
          /(myself|me|i|alone)/i,
          /(just\s+\w+)/i
        ];

        // Try other people patterns first
        for (const pattern of otherPeoplePatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.attendees = match[0];
            console.log(`Attendees extracted (with others): "${match[0]}"`);
            break;
          }
        }
        
        // If no other people found, try solo patterns
        if (!eventDetails.attendees) {
          for (const pattern of soloPatterns) {
            const match = input.match(pattern);
            if (match) {
              eventDetails.attendees = match[0];
              console.log(`Attendees extracted (solo): "${match[0]}"`);
              break;
            }
          }
        }
      }

      // Extract location
      if (!eventDetails.location) {
        const locationPatterns = [
          /(at|in|to)\s+(\w+)/i,
          /(bank|home|office|school|hospital|restaurant|cafe|store|mall|park|gym|library|church|airport)/i,
          /(the\s+\w+)/i
        ];

        for (const pattern of locationPatterns) {
          const match = input.match(pattern);
          if (match) {
            eventDetails.location = match[0];
            break;
          }
        }
      }

      // Extract email addresses for invitations
      const emailPattern = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
      const emailMatches = userInput.match(emailPattern);
      if (emailMatches) {
        emailMatches.forEach(email => {
          if (!eventDetails.attendeeEmails.includes(email)) {
            eventDetails.attendeeEmails.push(email);
            console.log(`Email added for invitation: ${email}`);
          }
        });
      }

      // Handle "no" responses to email requests
      if (input.includes('no') && input.length < 10) {
        console.log('User declined to provide email addresses');
      }
    }

    // Function to check if other people are mentioned in attendees
    function requiresEmailInvitation() {
      if (!eventDetails.attendees) {
        console.log('requiresEmailInvitation: No attendees found');
        return false;
      }
      
      const attendeesLower = eventDetails.attendees.toLowerCase();
      console.log(`requiresEmailInvitation: Checking attendees: "${eventDetails.attendees}"`);
      
      const otherPeopleKeywords = [
        'mom', 'mother', 'dad', 'father', 'brother', 'sister', 
        'friend', 'colleague', 'team', 'family', 'spouse', 
        'wife', 'husband', 'girlfriend', 'boyfriend', 'partner',
        'boss', 'manager', 'client', 'doctor', 'teacher'
      ];
      
      // Check if any keywords for other people are mentioned
      const mentionsOthers = otherPeopleKeywords.some(keyword => 
        attendeesLower.includes(keyword)
      );
      
      // Don't require email if it's just the user
      const justUser = attendeesLower.includes('myself') || 
                      attendeesLower.includes('me') || 
                      attendeesLower.includes('alone') ||
                      attendeesLower === 'i';
      
      const result = mentionsOthers && !justUser;
      console.log(`requiresEmailInvitation: mentionsOthers=${mentionsOthers}, justUser=${justUser}, result=${result}`);
      
      return result;
    }

    // Function to generate a smart event name using LLM
    async function generateSmartEventName() {
      const prompt = `Create a concise, descriptive event title based on these details:
- Date: ${eventDetails.date}
- Time: ${eventDetails.time}
- Attendees: ${eventDetails.attendees}
- Location: ${eventDetails.location}

Generate a natural, professional event title (2-6 words). Examples:
- "Bank Visit with Mom"
- "Team Meeting at Office"
- "Lunch with Friends"
- "Doctor Appointment"
- "Family Dinner"

Respond with ONLY the event title, no quotes or extra text.`;

      try {
        const body = {
          model: "mistralai/Mixtral-8x7B-Instruct-v0.1",
          messages: [
            {
              role: "system",
              content: "You are an expert at creating concise, professional event titles. Respond with only the event title, nothing else."
            },
            {
              role: "user",
              content: prompt
            }
          ],
          max_tokens: 50,
          temperature: 0.3
        };

        const response = await fetch("https://api.together.xyz/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${TOGETHER_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }

        const data = await response.json();
        const eventName = data.choices?.[0]?.message?.content?.trim() || "Event";
        
        console.log(`Generated smart event name: "${eventName}"`);
        return eventName;
      } catch (error) {
        console.error('Error generating smart event name:', error);
        // Fallback to a simple name
        return `${eventDetails.location ? eventDetails.location.charAt(0).toUpperCase() + eventDetails.location.slice(1) : 'Event'} ${eventDetails.attendees ? 'with ' + eventDetails.attendees : ''}`;
      }
    }

         const authBtn = document.getElementById('authorize_button');
     const signOutBtn = document.getElementById('signout_button');
     const inputBox = document.getElementById('inputBox');
     const msg = document.getElementById('message');
     const darkToggle = document.getElementById('darkToggle');
     const voiceButton = document.getElementById('voiceButton');

     // Voice recognition setup
     let recognition = null;
     if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
       recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
       recognition.continuous = false;
       recognition.interimResults = false;
       recognition.lang = 'en-US';

       recognition.onstart = () => {
         voiceButton.classList.add('recording');
         voiceButton.textContent = 'ðŸ”´';
       };

       recognition.onresult = (event) => {
         const transcript = event.results[0][0].transcript;
         inputBox.value = transcript;
         // Trigger the input event to process the voice input
         inputBox.dispatchEvent(new Event('input'));
       };

       recognition.onend = () => {
         voiceButton.classList.remove('recording');
         voiceButton.textContent = 'ðŸŽ¤';
       };

       recognition.onerror = (event) => {
         console.error('Speech recognition error:', event.error);
         voiceButton.classList.remove('recording');
         voiceButton.textContent = 'ðŸŽ¤';
       };
     }

    // Dark toggle functionality (element doesn't exist, so commenting out)
    // darkToggle.onclick = () => document.body.classList.toggle('dark');

    async function gapiLoaded() {
      try {
        console.log('Loading Google API client...');
        await new Promise((resolve, reject) => {
          gapi.load('client', {
            callback: resolve,
            onerror: reject
          });
        });
        await initializeGapi();
      } catch (error) {
        console.error('Failed to load Google API:', error);
      }
    }
    
    async function initializeGapi() {
      try {
        console.log('Initializing Google API client...');
        await gapi.client.init({
          discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        console.log('Google API client initialized successfully');
        maybeEnableButtons();
      } catch (error) {
        console.error('Failed to initialize Google API:', error);
      }
    }
    
    function gisLoaded() {
      try {
        console.log('Initializing Google Identity Services...');
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (resp) => {
            if (resp.error !== undefined) {
              console.error('OAuth error:', resp.error);
              return;
            }
            accessToken = resp.access_token;
            console.log('OAuth token received');
            handleAuthSuccess();
          },
        });
        gisInited = true;
        console.log('Google Identity Services initialized successfully');
        maybeEnableButtons();
      } catch (error) {
        console.error('Failed to initialize Google Identity Services:', error);
      }
    }
    
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        console.log('Google APIs initialized, enabling sign-in button');
        const authBtn = document.getElementById('authorize_button');
        if (authBtn) {
          authBtn.onclick = handleAuthClick;
          authBtn.disabled = false;
        }
      }
    }
    
    function handleAuthClick() {
      console.log('Auth button clicked');
      if (!tokenClient) {
        console.error('Token client not initialized');
        return;
      }
      
      if (gapi.client.getToken() === null) {
        console.log('Requesting new access token with consent');
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        console.log('Using existing access token');
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

         // Voice button click handler
     voiceButton.onclick = () => {
       if (recognition && !inputBox.disabled) {
         recognition.start();
       }
     };

     authBtn.onclick = () => {
       tokenClient.callback = async (resp) => {
         if (resp.error) return msg.textContent = 'Auth error: ' + resp.error;
         accessToken = resp.access_token;
         
         // After successful login
         async function handleAuthSuccess() {
           // Show app layout
           document.getElementById('loginContainer').style.display = 'none';
           document.getElementById('appLayout').classList.add('active');
           
           // Load user profile
           await loadUserProfile();
           
           // Initialize navigation
           setupNavigation();
           
           // Show welcome page by default
           document.getElementById('welcomePage').classList.add('active');
         }
         handleAuthSuccess();
         
         // Switch to app layout
         document.getElementById('loginLayout').style.display = 'none';
         document.getElementById('appLayout').classList.add('active');
         
         // Enable input
         inputBox.disabled = false;
         voiceButton.disabled = false;
       };
       tokenClient.requestAccessToken();
     };
     
     // Setup navigation between pages
    function setupNavigation() {
      // Welcome button
      document.getElementById('welcomeBtn').addEventListener('click', () => {
        document.getElementById('welcomePage').style.display = 'block';
        document.getElementById('chatPage').style.display = 'none';
        document.getElementById('inputContainer').style.display = 'none';
        
        // Update active state
        document.getElementById('welcomeBtn').classList.add('active');
        document.getElementById('chatBtn').classList.remove('active');
      });
      
      // Chat button
      document.getElementById('chatBtn').addEventListener('click', () => {
        document.getElementById('welcomePage').style.display = 'none';
        document.getElementById('chatPage').style.display = 'block';
        document.getElementById('inputContainer').style.display = 'flex';
        
        // Update active state
        document.getElementById('welcomeBtn').classList.remove('active');
        document.getElementById('chatBtn').classList.add('active');
        
        // Focus input
        setTimeout(() => {
          const input = document.getElementById('inputBox');
          if (input) input.focus();
        }, 100);
      });
      
      // Sign out button
      document.getElementById('signOutBtn').addEventListener('click', () => {
        // Sign out logic
        if (accessToken) {
          google.accounts.oauth2.revoke(accessToken);
          accessToken = null;
        }
        
        // Reset UI
        document.getElementById('appLayout').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'flex';
        
        // Reset input
        const inputBox = document.getElementById('inputBox');
        inputBox.value = '';
        inputBox.disabled = true;
        
        // Reset message
        const msg = document.getElementById('message');
        if (msg) {
          msg.innerHTML = '<strong>ðŸ¤– Assistant:</strong><br>Welcome! Please sign in to get started with your smart scheduling assistant.';
        }
        
        // Show auth button
        document.getElementById('authorize_button').style.display = 'inline-block';
      });
    }

     // Tab switching functionality
     function setupTabs() {
       const tabs = document.querySelectorAll('.nav-tab');
       
       tabs.forEach(tab => {
         tab.addEventListener('click', () => {
           // Remove active class from all tabs and content
           document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
           document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
           
           // Add active class to clicked tab and corresponding content
           tab.classList.add('active');
           const tabId = tab.getAttribute('data-tab');
           document.getElementById(`${tabId}Tab`).classList.add('active');
           
           // If switching to chat, focus the input
           if (tabId === 'chat') {
             setTimeout(() => {
               const input = document.getElementById('inputBox');
               if (input) input.focus();
             }, 100);
           }
         });
       });
     }
     
     // Initialize dashboard functionality
     function initializeDashboard() {
       // Setup tab switching
       setupTabs();
       
       // Quick action buttons
       document.querySelectorAll('.action-card').forEach(card => {
         card.addEventListener('click', () => {
           const action = card.getAttribute('data-action');
           
           switch(action) {
             case 'schedule':
               // Switch to chat tab and focus input
               document.querySelector('.nav-tab[data-tab="chat"]').click();
               break;
               
             case 'upcoming':
               // Show upcoming events (placeholder)
               alert('Upcoming events feature coming soon!');
               break;
               
             case 'settings':
               // Show settings (placeholder)
               alert('Settings feature coming soon!');
               break;
           }
         });
       });
     }

     // Load user profile from Google
    async function loadUserProfile() {
      console.log('Loading user profile...');
      
      if (!gapi.client) {
        console.warn('Google API client not initialized');
        return 'User';
      }
      
      // Helper function to get user info from OAuth2 userinfo
      const getUserInfoFromOAuth2 = async () => {
        try {
          const response = await gapi.client.oauth2.userinfo.get();
          const user = response.result;
          const displayName = user.name || user.email?.split('@')[0] || 'User';
          updateUserProfileUI(displayName, user.picture);
          return displayName;
        } catch (error) {
          console.error('Error getting user info from OAuth2:', error);
          throw error;
        }
      };
      
      try {
        // First try to get user info from the People API
        try {
          console.log('Attempting to fetch user info from People API...');
          
          // Check if People API is available
          if (!gapi.client.people) {
            console.log('People API not loaded, loading now...');
            await gapi.client.load('people', 'v1');
          }
          
          const response = await gapi.client.people.people.get({
            resourceName: 'people/me',
            personFields: 'names,emailAddresses,photos'
          });
          
          const user = response.result;
          const name = user.names && user.names[0]?.displayName;
          const email = user.emailAddresses && user.emailAddresses[0]?.value;
          const photoUrl = user.photos && user.photos[0]?.url;
          
          console.log('User info from People API:', { name, email });
          
          // Update UI with user info
          const displayName = name || email?.split('@')[0] || 'User';
          updateUserProfileUI(displayName, photoUrl);
          
          return displayName;
          
        } catch (peopleError) {
          console.warn('Failed to fetch from People API, falling back to OAuth2 userinfo:', peopleError);
          
          // If the error is due to missing scope, we might want to request it
          if (peopleError.status === 403 && peopleError.result.error.message.includes('insufficient permissions')) {
            console.log('Missing required scope for People API');
            // In the future, we could prompt the user to grant additional permissions
          }
          
          // Fall back to OAuth2 userinfo
          return await getUserInfoFromOAuth2();
        }
        
      } catch (error) {
        console.error('Error loading user profile:', error);
        
        // If we have a network error, try OAuth2 as a last resort
        if (error.status === 0 || error.status >= 500) {
          console.log('Network error, trying OAuth2 userinfo...');
          try {
            return await getUserInfoFromOAuth2();
          } catch (oauth2Error) {
            console.error('Failed to get user info from OAuth2:', oauth2Error);
          }
        }
        
        // Set default user info as fallback
        updateUserProfileUI('User');
        return 'User';
      }
    }
    
    function updateUserProfileUI(displayName, photoUrl = null) {
      console.log('Updating UI for user:', displayName);
      
      // Update welcome message
      const welcomeName = document.getElementById('welcomeName');
      if (welcomeName) {
        welcomeName.textContent = displayName;
      }
      
      // Update user avatar
      const userAvatar = document.getElementById('userAvatar');
      if (userAvatar) {
        // Clear previous content
        userAvatar.innerHTML = '';
        userAvatar.style.display = 'flex';
        
        if (photoUrl) {
          // Create image element for profile photo
          const img = document.createElement('img');
          img.src = photoUrl;
          img.alt = displayName;
          img.onload = () => {
            // Add visible class after image loads for smooth animation
            userAvatar.classList.add('visible');
          };
          userAvatar.appendChild(img);
        } else {
          // Generate initials avatar if no photo
          const initials = displayName.split(' ')
            .map(part => part[0])
            .join('')
            .toUpperCase()
            .substring(0, 2);
          
          userAvatar.textContent = initials;
          
          // Set random avatar color
          const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#10b981', '#0ea5e9'];
          const randomColor = colors[Math.floor(Math.random() * colors.length)];
          userAvatar.style.backgroundColor = randomColor;
          
          // Also update the primary color variable for the theme
          document.documentElement.style.setProperty('--primary', randomColor);
          
          // Trigger animation
          setTimeout(() => {
            userAvatar.classList.add('visible');
          }, 100);
        }
        
        // Show the avatar in the UI
        userAvatar.style.visibility = 'visible';
      }
      
      console.log('UI updated for user:', displayName);
      return displayName;
    }

     // Sign out handler
     signOutBtn.onclick = () => {
       if (accessToken) {
         google.accounts.oauth2.revoke(accessToken);
       }
       accessToken = null;
       inputBox.value = '';
       inputBox.disabled = true;
       voiceButton.disabled = true;
       msg.textContent = 'Signed out.';
       authBtn.style.display = 'inline-block';
       signOutBtn.style.display = 'none';
     };

        async function sendToLLM(text, isFinal = false) {
      chatHistory.push({ role: "user", content: text });

      // Get current date and time for the prompt
      const currentDateTime = new Date().toLocaleString();

      let systemPrompt = isFinal
        ? "Based on this conversation, create a calendar event. Return a JSON object with this format: {\"summary\": \"Event title\", \"dateTime\": \"2025-08-01T14:00:00Z\"}. Use ISO 8601 format and UTC time. Combine the date and time information to create the dateTime field."
        : `You are a direct and efficient scheduling assistant. You need to gather exactly 4 pieces of information in this order:

1) DATE/DAY (e.g., "Tuesday", "tomorrow", "January 15th")
2) TIME (e.g., "5 PM", "9:30 AM")
3) LOCATION (e.g., "bank", "restaurant", "home")
4) EMAIL for other people mentioned (if any)

Current date and time: {{CURRENT_DATETIME}}

RULES:
- Ask for missing information in order: Date â†’ Time â†’ Location â†’ Email
- Be direct and clear in your questions
- If someone mentions other people (mom, dad, friend, etc.), ALWAYS ask for their email address
- Use simple, short questions like "Where are you going?" or "What's your mom's email address?"
- Don't create the event until you have all required information

Current information:
- Date: ${eventDetails.date || 'Missing'}
- Time: ${eventDetails.time || 'Missing'}
- Attendees: ${eventDetails.attendees || 'Just you'}
- Location: ${eventDetails.location || 'Missing'}
- Attendee Emails: ${eventDetails.attendeeEmails.length > 0 ? eventDetails.attendeeEmails.join(', ') : 'None needed'}

NEXT ACTION: ${getNextAction()}

Respond with ONE short, direct question to get the missing information.`;

      // Replace the placeholder with actual current date and time
      systemPrompt = systemPrompt.replace('{{CURRENT_DATETIME}}', currentDateTime);

      const body = {
        model: "mistralai/Mixtral-8x7B-Instruct-v0.1",
        messages: [
          {
            role: "system",
            content: systemPrompt
          },
          ...chatHistory
        ],
        max_tokens: 300,
        temperature: 0.7
      };

      try {
        if (!validateApiKey(TOGETHER_API_KEY)) {
          throw new Error('Invalid API key configuration');
        }

        const response = await fetch("https://api.together.xyz/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${TOGETHER_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          throw new Error(`API request failed: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();

        if (data.error) {
          throw new Error(`API error: ${data.error.message || 'Unknown error'}`);
        }

        const reply = data.choices?.[0]?.message?.content || "I couldn't understand that.";
        chatHistory.push({ role: "assistant", content: reply });
        return reply;
      } catch (error) {
        console.error('LLM API error:', error);
        const errorMessage = "Sorry, I'm having trouble processing your request. Please try again.";
        chatHistory.push({ role: "assistant", content: errorMessage });
        return errorMessage;
      }
    }

    async function createEvent(summary, dateTime, attendeeEmails = []) {
      try {
        const endDate = new Date(dateTime.getTime() + 60 * 60 * 1000);
        const event = {
          summary,
          start: { dateTime: dateTime.toISOString(), timeZone: 'UTC' },
          end: { dateTime: endDate.toISOString(), timeZone: 'UTC' }
        };
        
        // Add attendees if emails are provided
        if (attendeeEmails && attendeeEmails.length > 0) {
          event.attendees = attendeeEmails.map(email => ({ email: email.trim() }));
        }
        
        const res = await gapi.client.calendar.events.insert({
          calendarId: 'primary',
          resource: event
        });
        return res.result.htmlLink;
      } catch (error) {
        console.error('Calendar API error:', error);
        throw new Error('Failed to create calendar event. Please check your permissions and try again.');
      }
    }

    async function createEventFromDetails() {
      try {
        // Generate a smart event name using LLM
        const summary = await generateSmartEventName();

        // Parse date and time to create a proper DateTime
        const dateTime = parseDateTime(eventDetails.date, eventDetails.time);

        if (!dateTime) {
          throw new Error('Could not parse the date and time information');
        }

        // Debug logging
        console.log('Base date for session:', baseDate.toLocaleString());
        console.log('Event details:', eventDetails);
        console.log('Parsed dateTime:', dateTime);
        console.log('Current real time:', new Date());

        // Validate that the date is in the future relative to base date (with some tolerance)
        const timeDiff = dateTime.getTime() - baseDate.getTime();
        const hoursDiff = timeDiff / (1000 * 60 * 60);

        if (hoursDiff < -1) { // Allow 1 hour tolerance for past events
          throw new Error(`Event date must be in the future. The specified time (${dateTime.toLocaleString()}) is in the past relative to the session start time (${baseDate.toLocaleString()}).`);
        }

        const eventLink = await createEvent(summary, dateTime, eventDetails.attendeeEmails);
        const inviteInfo = eventDetails.attendeeEmails.length > 0 ? ` (Invites sent to: ${eventDetails.attendeeEmails.join(', ')})` : '';
        msg.innerHTML = `ðŸ“… Event created: <a href="${eventLink}" target="_blank">${summary}</a>${inviteInfo}`;

        // Reset for next event
        questionCount = 0;
        chatHistory = [];
        eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
        // Reset base date for new session
        baseDate = new Date();
        console.log('New session started with base date:', baseDate.toLocaleString());

      } catch (error) {
        console.error('Event creation error:', error);
        msg.textContent = `âš ï¸ ${error.message}`;
        questionCount = 0;
        chatHistory = [];
        eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
      }
    }

    inputBox.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter') return;
      const text = inputBox.value.trim();
      if (!text) return;

      msg.textContent = 'ðŸ¤– Thinking...';
      inputBox.value = '';
      inputBox.disabled = true;
      questionCount++;

      // Update event details with user input
      updateEventDetails(text);

      // Debug logging
      console.log('After updateEventDetails:', eventDetails);
      console.log('Has all info:', eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location);

      // Check if we have all required information
      const hasBasicInfo = eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location;
      const needsEmailInvitation = requiresEmailInvitation();
      const hasEmailsWhenNeeded = !needsEmailInvitation || eventDetails.attendeeEmails.length > 0;
      const hasAllInfo = hasBasicInfo && hasEmailsWhenNeeded;
      const isFinal = questionCount >= 6; // Fallback to prevent infinite loops

      console.log(`Event processing: hasBasicInfo=${hasBasicInfo}, needsEmailInvitation=${needsEmailInvitation}, hasEmailsWhenNeeded=${hasEmailsWhenNeeded}, hasAllInfo=${hasAllInfo}`);
      console.log(`Current eventDetails:`, eventDetails);

      // If we have all basic info but need emails, ask for them via AI
      if (hasBasicInfo && needsEmailInvitation && eventDetails.attendeeEmails.length === 0) {
        console.log('All basic info gathered, but need email for invitation - continuing to AI');
        // Continue to AI to ask for email
      }
      // If we have all info including emails (when needed), create event directly
      else if (hasAllInfo) {
        console.log('All information complete - creating event directly');
        msg.textContent = 'ðŸŽ¯ All information gathered! Creating your event...';
        await createEventFromDetails();
        return;
      }

      const reply = await sendToLLM(text, isFinal);

      if (isFinal) {
        try {
          const jsonMatch = reply.match(/{[^}]+}/);
          if (jsonMatch) {
            const parsed = JSON.parse(jsonMatch[0]);
            const { summary, dateTime } = parsed;

            // Validate date string
            const eventDate = new Date(dateTime);
            if (isNaN(eventDate.getTime())) {
              throw new Error('Invalid date format received from AI');
            }

            // Check if date is in the future relative to base date (with tolerance)
            const timeDiff = eventDate.getTime() - baseDate.getTime();
            const hoursDiff = timeDiff / (1000 * 60 * 60);

            if (hoursDiff < -1) { // Allow 1 hour tolerance for past events
              throw new Error(`Event date must be in the future. The specified time (${eventDate.toLocaleString()}) is in the past relative to the session start time (${baseDate.toLocaleString()}).`);
            }

            // Generate smart event name instead of using basic summary
            const smartEventName = await generateSmartEventName();

            const eventLink = await createEvent(smartEventName, eventDate, eventDetails.attendeeEmails);
            const inviteInfo = eventDetails.attendeeEmails.length > 0 ? ` (Invites sent to: ${eventDetails.attendeeEmails.join(', ')})` : '';
            msg.innerHTML = `ðŸ“… Event created: <a href="${eventLink}" target="_blank">${smartEventName}</a>${inviteInfo}`;
            questionCount = 0;
            chatHistory = [];
            eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
            // Reset base date for new session
            baseDate = new Date();
            console.log('New session started with base date:', baseDate.toLocaleString());
            return;
          } else {
            throw new Error('No valid JSON found in response');
          }
        } catch (err) {
          console.error('Event creation error:', err);
          msg.textContent = `âš ï¸ ${err.message || "I couldn't understand the schedule details. Please try again."}`;
          questionCount = 0;
          chatHistory = [];
          eventDetails = { date: null, time: null, attendees: null, location: null, attendeeEmails: [] };
          // Reset base date for new session
          baseDate = new Date();
        }
      } else {
        // Check again if we now have all info after AI response
        const hasBasicInfoAfterAI = eventDetails.date && eventDetails.time && eventDetails.attendees && eventDetails.location;
        const needsEmailAfterAI = requiresEmailInvitation();
        const hasEmailsWhenNeededAfterAI = !needsEmailAfterAI || eventDetails.attendeeEmails.length > 0;
        const hasAllInfoAfterAI = hasBasicInfoAfterAI && hasEmailsWhenNeededAfterAI;

        if (hasAllInfoAfterAI) {
          msg.textContent = 'ðŸŽ¯ All information gathered! Creating your event...';
          await createEventFromDetails();
          return;
        }

        // Show progress indicator and gathered info
        const progressInfo = `<br><br><small>ðŸ“‹ Progress: ${4 - getMissingInfo().length}/4 details gathered</small>`;

        const gatheredInfo = eventDetails.date || eventDetails.time || eventDetails.attendees || eventDetails.location
          ? `<br><small>âœ… Gathered: ${[eventDetails.date, eventDetails.time, eventDetails.attendees, eventDetails.location].filter(Boolean).join(', ')}</small>`
          : '';

        msg.innerHTML = `<strong>ðŸ¤– Assistant:</strong><br>${reply.replace(/\n/g, '<br>')}${progressInfo}${gatheredInfo}`;
      }

      // Re-enable input box after processing
      inputBox.disabled = false;
    });

    // Create floating particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 50;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (15 + Math.random() * 10) + 's';
        particlesContainer.appendChild(particle);
      }
    }
    
    // Enhanced message display with animations
    function displayMessage(content, type = 'assistant') {
      const chatContainer = document.getElementById('chatContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.innerHTML = content;
      
      // Replace the current message or add new one
      const existingMessage = document.getElementById('message');
      if (existingMessage && type === 'assistant') {
        existingMessage.innerHTML = content;
      } else {
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }
    
    // Show typing indicator
    function showTyping() {
      const chatContainer = document.getElementById('chatContainer');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'typing-indicator';
      typingDiv.id = 'typing';
      typingDiv.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatContainer.appendChild(typingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Google API initialization with better error handling and People API support
    async function gapiLoaded() {
      console.log('Google API script loaded');
      
      try {
        // First, ensure gapi is loaded
        if (typeof gapi === 'undefined') {
          throw new Error('Google API client not loaded');
        }
        
        // Load the client library
        await new Promise((resolve, reject) => {
          if (!gapi.load) {
            return reject(new Error('gapi.load is not available'));
          }
          
          gapi.load('client:auth2', {
            callback: resolve,
            onerror: (err) => {
              console.error('Error loading Google API client:', err);
              reject(new Error('Failed to load Google API client'));
            },
            timeout: 10000, // 10 seconds
            ontimeout: () => reject(new Error('Timeout loading Google API client'))
          });
        });
        
        // Initialize the client with the API key and client ID
        console.log('Initializing Google API client...');
        if (!gapi.client) {
          throw new Error('gapi.client is not available');
        }
        
        await gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        });
        
        console.log('Google API client initialized with scopes:', SCOPES);
        gapiInited = true;
        maybeEnableButtons();
        
        // Check if user is already signed in
        const authInstance = gapi.auth2.getAuthInstance();
        if (authInstance && authInstance.isSignedIn && authInstance.isSignedIn.get()) {
          console.log('User already signed in');
          const user = authInstance.currentUser.get();
          accessToken = user.getAuthResponse().access_token;
          
          // Set the token for gapi client
          if (gapi.client) {
            gapi.client.setToken({ access_token: accessToken });
          }
          
          // Handle successful authentication
          await handleAuthSuccess();
        }
        
      } catch (error) {
        console.error('Failed to initialize Google API:', error);
        
        // Show error to user
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) {
          loginContainer.innerHTML += `
            <div class="error-message" style="color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;">
              Error initializing Google services. Please refresh the page.
              <br><small>${error.message || 'Unknown error occurred'}</small>
            </div>
          `;
        }
      }
    }
    
    function gisLoaded() {
      console.log('Google Identity Services script loaded');
      
      try {
        if (!window.google || !window.google.accounts || !window.google.accounts.oauth2) {
          throw new Error('Google Identity Services not properly loaded');
        }
        
        // Initialize the token client with all required scopes
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          prompt: 'consent',
          callback: async (response) => {
            const authButton = document.getElementById('authorize_button');
            
            if (response.error) {
              console.error('OAuth error:', response.error);
              
              // Reset button state
              if (authButton) {
                authButton.textContent = 'Sign in with Google';
                authButton.disabled = false;
              }
              
              if (response.error === 'popup_closed') {
                console.log('User closed the OAuth popup');
              } else if (response.error === 'access_denied') {
                console.warn('User denied the permission request');
                alert('Permission is required to access your Google Calendar. Please grant the requested permissions.');
              } else {
                console.error('OAuth error:', response.error);
                alert('Sign-in error: ' + (response.error_description || response.error));
              }
              return;
            }
            
            console.log('OAuth token received');
            accessToken = response.access_token;
            
            try {
              // Set the token for gapi client
              if (gapi.client) {
                gapi.client.setToken({ access_token: accessToken });
              }
              
              // Handle successful authentication
              await handleAuthSuccess();
              
            } catch (error) {
              console.error('Error after authentication:', error);
              
              // Show error to user
              const loginContainer = document.getElementById('loginContainer');
              if (loginContainer) {
                loginContainer.innerHTML += `
                  <div class="error-message" style="color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;">
                    Error after sign-in: ${error.message || 'Unknown error occurred'}
                  </div>
                `;
              }
              
              // Reset button state
              if (authButton) {
                authButton.textContent = 'Sign in with Google';
                authButton.disabled = false;
              }
            }
          }
        });
        
        gisInited = true;
        console.log('Google Identity Services initialized with scopes:', SCOPES);
        maybeEnableButtons();
        
        // Set up the sign-in button if it exists
        const authButton = document.getElementById('authorize_button');
        if (authButton) {
          authButton.onclick = handleAuthClick;
          authButton.style.display = 'inline-block';
          authButton.disabled = false;
          console.log('Sign-in button initialized');
        } else {
          console.warn('Sign-in button not found in the DOM');
        }
        
      } catch (error) {
        console.error('Error initializing Google Identity Services:', error);
        
        // Show error to user
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) {
          loginContainer.innerHTML += `
            <div class="error-message" style="color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;">
              Error initializing Google Sign-In. Please refresh the page.
              <br><small>${error.message || 'Unknown error occurred'}</small>
            </div>
          `;
        }
      }
    }
    
    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('authorize_button').onclick = handleAuthClick;
        document.getElementById('signout_button').onclick = handleSignoutClick;
        console.log('Google APIs initialized successfully');
      }
    }
    
    function handleAuthClick() {
      console.log('Sign-in button clicked');
      
      const authButton = document.getElementById('authorize_button');
      if (!authButton) {
        console.error('Sign-in button not found');
        return;
      }
      
      // Show loading state
      const originalText = authButton.textContent;
      authButton.textContent = 'Loading...';
      authButton.disabled = true;
      
      // Clear any previous error messages
      const errorMessages = document.querySelectorAll('.error-message');
      errorMessages.forEach(el => el.remove());
      
      try {
        if (!tokenClient) {
          throw new Error('Google Sign-In is not ready. Please refresh the page and try again.');
        }
        
        if (!gapiInited || !gisInited) {
          throw new Error('Google services not fully loaded. Please wait and try again.');
        }
        
        console.log('Requesting access token with scopes:', SCOPES);
        
        // Request token with consent
        tokenClient.requestAccessToken({
          prompt: 'consent',
          // Add any additional parameters needed for your app
          // For example, you can add login_hint for a better user experience
          // login_hint: 'user@example.com'
        });
        
        // The callback in tokenClient will handle the response
        
      } catch (error) {
        console.error('Sign-in error:', error);
        
        // Show error to user
        const loginContainer = document.getElementById('loginContainer');
        const errorMessage = document.createElement('div');
        errorMessage.className = 'error-message';
        errorMessage.style.cssText = 'color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;';
        
        let errorText = `Error during sign-in: ${error.message || 'Unknown error occurred'}`;
        
        // Add more user-friendly messages for common errors
        if (error.message && error.message.includes('popup_blocked')) {
          errorText = 'The sign-in popup was blocked. Please allow popups for this site and try again.';
        } else if (error.message && error.message.includes('access_denied')) {
          errorText = 'Permission was denied. Please grant the requested permissions to use the app.';
        }
        
        errorMessage.textContent = errorText;
        
        if (loginContainer) {
          loginContainer.appendChild(errorMessage);
          
          // Scroll to the error message
          setTimeout(() => {
            errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 100);
        } else {
          // If login container is not found, show an alert as fallback
          alert(errorText);
        }
        
        // Reset button state
        if (authButton) {
          authButton.textContent = originalText;
          authButton.disabled = false;
        }
      }
    }
    
    // After successful login
    async function handleAuthSuccess() {
      console.log('Handling successful authentication...');
      
      // Update UI to show loading state
      const loginContainer = document.getElementById('loginContainer');
      const authButton = document.getElementById('authorize_button');
      
      if (authButton) {
        authButton.textContent = 'Loading profile...';
        authButton.disabled = true;
      }
      
      try {
        // Make sure gapi client is initialized with the token
        if (gapi.client && accessToken) {
          console.log('Setting access token for gapi client');
          gapi.client.setToken({ access_token: accessToken });
          
          // Initialize Calendar API if not already done
          if (!gapi.client.calendar) {
            console.log('Loading Calendar API...');
            await new Promise((resolve, reject) => {
              gapi.client.load('calendar', 'v3', resolve);
            });
            console.log('Calendar API loaded successfully');
          } else {
            console.log('Calendar API already loaded');
          }
        } else {
          console.warn('gapi.client not available or missing access token');
        }
        
        // Load user profile and get display name
        console.log('Loading user profile...');
        const displayName = await loadUserProfile();
        console.log('User profile loaded, display name:', displayName);
        
        // Now update the UI to show the app and hide login
        const appLayout = document.getElementById('appLayout');
        
        if (loginContainer) {
          // Start fading out the login container
          loginContainer.style.opacity = '0';
          loginContainer.style.pointerEvents = 'none';
          
          // After fade out, hide it completely and show the app
          setTimeout(() => {
            loginContainer.style.display = 'none';
            
            // Show the app layout with a nice fade-in effect
            if (appLayout) {
              appLayout.style.display = 'flex';
              appLayout.style.opacity = '0';
              
              // Trigger reflow
              void appLayout.offsetHeight;
              
              // Fade in
              appLayout.style.transition = 'opacity 0.5s ease-in-out';
              appLayout.style.opacity = '1';
            }
          }, 300);
        } else if (appLayout) {
          // Fallback if login container is not found
          appLayout.style.display = 'flex';
        }
        
        // Initialize navigation
        console.log('Setting up navigation...');
        setupNavigation();
        
        // Show welcome page by default
        const welcomePage = document.getElementById('welcomePage');
        const chatPage = document.getElementById('chatPage');
        const inputContainer = document.getElementById('inputContainer');
        
        if (welcomePage) welcomePage.style.display = 'block';
        if (chatPage) chatPage.style.display = 'none';
        
        // Update welcome message with user's name
        const welcomeName = document.getElementById('welcomeName');
        if (welcomeName) welcomeName.textContent = displayName || 'User';
        
        // Show and enable input container for chat
        const inputBox = document.getElementById('inputBox');
        const voiceButton = document.getElementById('voiceButton');
        
        if (inputContainer) {
          inputContainer.style.display = 'flex';
          inputContainer.style.opacity = '0';
          
          // Fade in the input container
          setTimeout(() => {
            inputContainer.style.transition = 'opacity 0.5s ease-in-out';
            inputContainer.style.opacity = '1';
          }, 100);
        }
        
        if (inputBox) {
          inputBox.disabled = false;
          
          // Focus the input box with a small delay
          setTimeout(() => {
            inputBox.focus();
            console.log('Input box focused');
          }, 100);
        }
        
        if (voiceButton) voiceButton.disabled = false;
        
        console.log('Authentication flow completed successfully');
        
      } catch (error) {
        console.error('Error in handleAuthSuccess:', error);
        
        // Show error to user
        const loginContainer = document.getElementById('loginContainer');
        if (loginContainer) {
          const errorMessage = document.createElement('div');
          errorMessage.className = 'error-message';
          errorMessage.style.cssText = 'color: #ff4444; margin-top: 20px; padding: 10px; background: #ffebee; border-radius: 4px;';
          errorMessage.textContent = `Error initializing the app: ${error.message || 'Unknown error occurred'}`;
          
          loginContainer.appendChild(errorMessage);
          
          // Reset button state
          const authButton = document.getElementById('authorize_button');
          if (authButton) {
            authButton.textContent = 'Sign in with Google';
            authButton.disabled = false;
          }
        } else {
          // Fallback if login container is not found
          alert(`Error initializing the app: ${error.message || 'Unknown error occurred'}`);
        }
        
        // Re-throw the error to be caught by the caller if needed
        throw error;
      }
    // Function to handle user sign out
    function handleSignoutClick() {
      console.log('Handling sign out...');
      
      // Revoke the OAuth token
      const token = gapi.client.getToken();
      if (token && token.access_token) {
        try {
          google.accounts.oauth2.revoke(token.access_token, () => {
            console.log('Token revoked successfully');
          });
        } catch (error) {
          console.warn('Error revoking token:', error);
        }
        
        // Clear the token from gapi client
        gapi.client.setToken(null);
      }
      
      // Clear any stored tokens and reset state
      accessToken = null;
      gapiInited = false;
      gisInited = false;
      
      // Reset UI to logged out state
      const loginContainer = document.getElementById('loginContainer');
      const appLayout = document.getElementById('appLayout');
      const authButton = document.getElementById('authorize_button');
      
      if (loginContainer) {
        loginContainer.style.display = 'flex';
        loginContainer.style.opacity = '1';
        loginContainer.style.pointerEvents = 'auto';
      }
      
      if (appLayout) {
        appLayout.style.display = 'none';
      }
      
      if (authButton) {
        authButton.textContent = 'Sign in with Google';
        authButton.disabled = false;
      }
      
      // Clear any error messages
      const errorMessages = document.querySelectorAll('.error-message');
      errorMessages.forEach(el => el.remove());
      
      // Reset the token client
      tokenClient = null;
      
      console.log('Sign out completed');
      }
      accessToken = null;
      
      // Show login container and hide app layout
      document.getElementById('loginContainer').style.display = 'flex';
      document.getElementById('appLayout').style.display = 'none';
      document.getElementById('authorize_button').style.display = 'inline-block';
      document.getElementById('signout_button').style.display = 'none';
      
      // Hide and disable input container
      const inputContainer = document.getElementById('inputContainer');
      const inputBox = document.getElementById('inputBox');
      const voiceButton = document.getElementById('voiceButton');
      
      if (inputContainer) inputContainer.style.display = 'none';
      if (inputBox) inputBox.disabled = true;
      if (voiceButton) voiceButton.disabled = true;
      
      // Reset chat message
      const msg = document.getElementById('message');
      if (msg) {
        msg.innerHTML = '<strong>ðŸ¤– Assistant:</strong><br>You\'ve been signed out. Please sign in to continue.';
      }
    }

    // Demo mode - bypass OAuth for now
    function testButtonClick() {
      console.log('Button clicked!');
      
      // For now, let's enable demo mode so you can see the app working
      const enableDemo = confirm('OAuth setup is complex. Would you like to try DEMO MODE instead?\n\nDemo mode lets you test all features without Google Calendar integration.');
      
      if (enableDemo) {
        // Enable demo mode
        accessToken = 'demo-token';
        
        // Update UI to show connected state
        document.getElementById('authorize_button').style.display = 'none';
        document.getElementById('signout_button').style.display = 'inline-block';
        document.getElementById('inputBox').disabled = false;
        document.getElementById('voiceButton').disabled = false;
        
        const msg = document.getElementById('message');
        msg.innerHTML = '<strong>ðŸ¤– Assistant:</strong><br>ðŸŽ† <strong>DEMO MODE ACTIVE!</strong><br>You can now test all Smart Scheduler features! Events won\'t be saved to Google Calendar, but you can see how everything works.<br><br>Try saying: "Schedule lunch with mom tomorrow at 1pm"';
        
        return;
      }
      
      // If they want real OAuth, show instructions
      alert('For real Google Calendar integration, you need to:\n\n1. Go to console.cloud.google.com\n2. APIs & Services â†’ Credentials\n3. Edit your OAuth client\n4. Add these URLs:\n   - JavaScript origins: https://smart-scheduler-app.windsurf.build\n   - Redirect URIs: https://smart-scheduler-app.windsurf.build\n\nThen wait 2-3 minutes and try again.');
    }
    
    // Check for access token in URL
    function checkForAccessToken() {
      const hash = window.location.hash;
      if (hash.includes('access_token=')) {
        const params = new URLSearchParams(hash.substring(1));
        const token = params.get('access_token');
        if (token) {
          accessToken = token;
          console.log('Got access token:', token.substring(0, 20) + '...');
          
          // Update UI
          document.getElementById('authorize_button').style.display = 'none';
          document.getElementById('signout_button').style.display = 'inline-block';
          document.getElementById('inputBox').disabled = false;
          document.getElementById('voiceButton').disabled = false;
          
          const msg = document.getElementById('message');
          msg.innerHTML = '<strong>ðŸ¤– Assistant:</strong><br>Perfect! I\'m now connected to your Google Calendar. What would you like to schedule?';
          
          // Clear the hash
          window.location.hash = '';
        }
      }
    }

    // Initialize APIs with retry mechanism
    function initializeAPIs() {
      console.log('Page loaded, initializing APIs...');
      
      // Check if Google APIs are available
      if (typeof gapi === 'undefined') {
        console.log('Google API not available yet, retrying in 1 second...');
        setTimeout(initializeAPIs, 1000);
        return;
      }
      
      if (typeof google === 'undefined') {
        console.log('Google Identity Services not available yet, retrying in 1 second...');
        setTimeout(initializeAPIs, 1000);
        return;
      }
      
      // Both APIs are available, initialize them
      gapiLoaded();
      gisLoaded();
    }

    // Initialize Google APIs
    const initGoogleApis = async () => {
      try {
        console.log('Initializing Google APIs...');
        
        // Initialize Google API client
        await initializeGapi();
        
        // Initialize Google Identity Services
        gisLoaded();
        
        // Set up event listeners
        setupNavigation();
        
        // Check for access token in URL (for OAuth redirect)
        checkForAccessToken();
        
        console.log('Google APIs initialized');
      } catch (error) {
        console.error('Error initializing Google APIs:', error);
        showError('Error initializing Google services. Please refresh the page.');
      }
    };

    // Initialize the app when the page loads
    window.onload = function() {
      console.log('Page loaded, initializing app...');
      
      // Set base date for the session
      baseDate = new Date();
      console.log('Base date set to:', baseDate);
      
      // Initialize Google APIs
      initGoogleApis();
      
      // Create floating particles
      createParticles();
      
      // Register Service Worker if available
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('Service Worker registered: ', registration);
          })
          .catch((registrationError) => {
            console.log('Service Worker registration failed: ', registrationError);
          });
      }
      
      // Initialize welcome page functionality
      const getStartedBtn = document.getElementById('getStartedBtn');
      if (getStartedBtn) {
        getStartedBtn.addEventListener('click', function() {
          document.getElementById('welcomeContainer').style.display = 'none';
          document.getElementById('loginContainer').style.display = 'block';
        });
      }
      
      // Handle Back to Welcome from login
      const signOutBtn = document.getElementById('signout_button');
      if (signOutBtn) {
        signOutBtn.addEventListener('click', function() {
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('welcomeContainer').style.display = 'block';
          document.getElementById('appLayout').classList.remove('active');
        });
      }
      
      // Add smooth scrolling to chat
      const chatContainer = document.getElementById('chatContainer');
      if (chatContainer) {
        chatContainer.style.scrollBehavior = 'smooth';
      }
    };
</script>
</body>
</html>